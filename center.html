<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>PAPSI Training Center</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						'papsi-green': '#166938',
						'papsi-red': '#dc2626',
						'papsi-gold': '#f59e0b',
						'papsi-dark': '#1f2937'
					}
				}
			}
		}
	</script>
	<style>
		.card-hover { transition: transform 0.2s, box-shadow 0.2s; }
		.card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
		.training-image { cursor: pointer; transition: opacity 0.2s; }
		.training-image:hover { opacity: 0.8; }
		.modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.5); z-index: 2000; }
		.modal.open { display: flex; }
		.modal-content { background: #fff; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 2rem; }
		/* Filters Drawer (mobile) */
		.filters-drawer { position:fixed; top:0; left:0; bottom:0; width:290px; max-width:85%; background:#fff; z-index:1500; box-shadow:0 10px 30px -5px rgba(0,0,0,.25); display:flex; flex-direction:column; transform:translateX(-100%); transition:transform .30s ease; }
		.filters-drawer.open { transform:translateX(0); }
		.filters-drawer-header { padding:0.85rem 1rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
		.filters-drawer-body { padding:1rem; overflow-y:auto; -webkit-overflow-scrolling:touch; }
		.filters-drawer-close-btn { padding:.5rem; border-radius:.375rem; }
		@media (min-width: 768px) {
			.filters-drawer { position:static; width:auto; max-width:none; height:auto; transform:none !important; box-shadow:none; background:transparent; }
			.filters-drawer-header { display:none; }
			.filters-drawer-body { padding:0; overflow:visible; }
		}
		/* Image Viewer */
		.image-viewer { position: fixed; inset: 0; background: rgba(0,0,0,.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
		.image-viewer.open { display: flex; }
		.image-container { position: relative; max-width: 90%; max-height: 90%; overflow: hidden; cursor: grab; }
		.image-container:active { cursor: grabbing; }
		.viewer-image { max-width: 100%; max-height: 100%; transition: transform .2s ease; user-select: none; }

		/* Image viewer controls */
		.viewer-close {
			position: absolute; top: 14px; right: 14px;
			background: rgba(255,255,255,.14); color: #fff;
			width: 36px; height: 36px; border-radius: 999px; border: 1px solid rgba(255,255,255,.25);
			display: inline-flex; align-items: center; justify-content: center;
		}
		.viewer-close:hover { background: rgba(255,255,255,.22); }

		.viewer-nav {
			position: absolute; top: 50%; transform: translateY(-50%);
			background: rgba(255,255,255,.14); color: #fff;
			width: 40px; height: 40px; border-radius: 999px; border: 1px solid rgba(255,255,255,.25);
			display: inline-flex; align-items: center; justify-content: center;
		}
		.viewer-prev { left: 16px; }
		.viewer-next { right: 16px; }
		.viewer-nav:hover { background: rgba(255,255,255,.22); }
		.viewer-nav[disabled] { opacity: .4; cursor: not-allowed; }

		.viewer-controls {
			position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
			display: flex; gap: 10px;
			background: rgba(17,24,39,.55);
			padding: 8px; border-radius: 999px; border: 1px solid rgba(255,255,255,.15);
		}
		.viewer-btn {
			background: rgba(255,255,255,.14); color: #fff;
			width: 36px; height: 36px; border-radius: 999px; border: 1px solid rgba(255,255,255,.25);
			display: inline-flex; align-items: center; justify-content: center;
		}
		.viewer-btn:hover { background: rgba(255,255,255,.22); }
		@keyframes cartBarIn { from { transform: translateY(12px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
		@keyframes cartAddedPulse { 0% { transform: scale(.985); box-shadow:0 0 0 0 rgba(22,105,56,0.45); } 35% { transform: scale(1); box-shadow:0 0 0 10px rgba(22,105,56,0); } 100% { transform: scale(1); box-shadow:0 0 0 0 rgba(22,105,56,0); } }
		.added-banner-animate { animation: cartAddedPulse 1.8s ease-out 1; }

		/* Promo banner: respect reduced motion */
		@media (prefers-reduced-motion: reduce) {
			.animate-pulse { animation: none !important; }
		}
	</style>
</head>
<body class="bg-gray-50 text-gray-800">
	<!-- Promo Banner -->
	<div id="promoBanner" class="fixed top-0 left-0 right-0 z-[1200] hidden">
		<div class="mx-auto max-w-6xl px-4">
			<div class="bg-papsi-green text-white rounded-b-lg shadow flex flex-col md:flex-row md:items-center md:justify-between gap-2 p-3">
				<div class="flex items-center gap-3">
					<div class="hidden md:block h-2 w-2 rounded-full bg-white/70 animate-pulse"></div>
					<div class="text-sm md:text-base leading-snug">
						<span class="font-semibold">PAPSIPROMO</span>
						<span class="opacity-90">— Get 30% off on trainings. Limited time.</span>
					</div>
				</div>
				<div class="flex items-center gap-2">
					<button id="promoCopyBtn" type="button" class="text-xs md:text-sm px-3 py-1.5 rounded bg-white/15 hover:bg-white/25">Copy code</button>
					<button id="promoApplyBtn" type="button" class="text-xs md:text-sm px-3 py-1.5 rounded bg-white text-papsi-green font-semibold hover:bg-gray-100">Apply now</button>
					<button id="promoDismissBtn" type="button" class="ml-1 text-white/80 hover:text-white text-lg leading-none" aria-label="Dismiss">&times;</button>
				</div>
			</div>
		</div>
	</div>
	<div id="promoSpacer" class="h-0"></div>
	<!-- End of Promo Banner -->
	<div class="max-w-6xl mx-auto px-4 py-6">
		<!-- Page Title with logo placed above the white container -->
		<div class="flex items-center gap-3 mb-4">
			<a href="index.html" class="inline-flex items-center" title="Back to Home">
				<img src="https://papsitrainingcenter.weebly.com/uploads/2/5/9/7/25977880/papsilogo_1.png" alt="PAPSI Logo" class="h-10 w-auto select-none" loading="lazy">
			</a>
			<h1 class="text-2xl font-bold text-papsi-dark">Center for Teacher Excellence</h1>
		</div>

		<!-- Segmented toolbar (filters & stats) -->
		<div class="bg-white rounded-lg shadow-sm p-6 mb-6">
			<div class="flex items-center gap-2 mb-2">
				<div class="inline-flex rounded-md overflow-hidden border border-gray-200 bg-white/70">
					<button id="trainingFiltersMobileBtn" type="button" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium bg-white hover:bg-gray-50 text-gray-700 focus:outline-none rounded-none border-r border-gray-200" aria-expanded="false" aria-controls="trainingFiltersDrawer">
						<svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M3 4.5A1.5 1.5 0 014.5 3h11A1.5 1.5 0 0117 4.5v.382a1.5 1.5 0 01-.44 1.06l-4.56 4.56v4.248a1 1 0 01-1.37.93l-2-.75A1 1 0 017 13.996v-3.494L2.44 5.942A1.5 1.5 0 012 4.882V4.5z"/></svg>
						<span>Filters</span>
						<span id="trainingFiltersActiveCount" class="hidden text-[10px] bg-gray-100 text-gray-600 px-1 rounded">0</span>
					</button>
					<button id="trainingStatsToggle" type="button" class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium bg-white hover:bg-gray-50 text-gray-700 focus:outline-none rounded-none" aria-controls="trainingStatsSection" aria-expanded="false">
						<svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M4 12a1 1 0 011-1h1a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM9 9a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V9zM14 6a1 1 0 011-1h1a1 1 0 011 1v9a1 1 0 01-1 1h-1a1 1 0 01-1-1V6z"/></svg>
						<span>Show Stats</span>
					</button>
				</div>
				<button id="trainingClearFilters" type="button" class="hidden text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200">Clear</button>
			</div>
			<div id="trainingFilterChips" class="flex flex-wrap items-center gap-2 mb-4 hidden"></div>
			<div id="trainingStatsSection" class="hidden">
				<div id="trainingStatsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>
				<div id="trainingYearBars" class="space-y-2 mb-2"></div>
			</div>
		</div>

		<!-- Filters Drawer and controls -->
		<div id="trainingFiltersDrawer" class="filters-drawer md:bg-white md:rounded-lg md:shadow-sm md:p-4 mb-6" role="dialog" aria-modal="true" aria-labelledby="trainingFiltersHeading">
			<div class="filters-drawer-header md:hidden">
				<h3 id="trainingFiltersHeading" class="font-semibold text-papsi-dark text-sm">Training Filters</h3>
				<button type="button" class="filters-drawer-close-btn text-gray-500 hover:text-gray-700 hover:bg-gray-100" aria-label="Close filters" onclick="closeFiltersDrawer()">
					<svg class="w-5 h-5" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14L14 6"/></svg>
				</button>
			</div>
			<div class="filters-drawer-body md:p-0">
				<div class="flex flex-col md:flex-row gap-4 items-center">
					<div class="flex-1 relative">
						<input type="text" id="searchInput" placeholder="Search courses, speakers, or topics..." class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
						<svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/></svg>
						<button id="clearSearch" class="absolute right-3 top-2.5 w-5 h-5 text-gray-400 hover:text-gray-600 hidden" title="Clear search">
							<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
						</button>
					</div>
					<select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green"><option value="all">All Categories</option></select>
					<select id="speakerFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green"><option value="all">All Speakers</option></select>
					<select id="dateSort" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green"><option value="newest">Newest First</option><option value="oldest">Oldest First</option></select>
				</div>
				<div class="mt-4 text-sm text-gray-600"><div id="resultsCounter" class="font-medium">Showing 0 of 0 courses</div></div>
			</div>
		</div>

		<!-- Courses grid and pagination -->
		<div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
		<div id="coursesPagination" class="w-full flex justify-center mt-6 mb-3"></div>
		<div id="trainingBottomSpacer" class="h-0"></div>
	</div>

	<!-- Bottom Cart Bar -->
	<div id="trainingCartBar" class="fixed left-0 right-0 bottom-5 md:bottom-20 z-[1100] px-3 hidden">
		<div class="mx-auto max-w-4xl bg-white border shadow-lg rounded-xl flex items-center justify-between gap-4 px-4 py-3">
			<div class="flex items-center gap-6">
				<div class="leading-tight"><div class="text-xs text-gray-500">Subtotal</div><div class="text-sm font-semibold text-papsi-dark"><span id="trainingBarSubtotal">₱0.00</span></div></div>
				<div class="leading-tight"><div class="text-xs text-gray-500">Total</div><div class="text-sm font-semibold text-papsi-green"><span id="trainingBarTotal">₱0.00</span></div></div>
			</div>
			<button type="button" onclick="openCart()" class="relative flex items-center gap-2 bg-papsi-green text-white px-4 py-2 rounded shadow hover:bg-green-700 transition" aria-label="Open cart">
				<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.3 2.6A1 1 0 007 17h10"/></svg>
				<span>Cart</span>
				<span id="trainingBarCount" class="absolute -top-2 -right-2 text-[10px] bg-white text-papsi-green font-bold px-1.5 py-0.5 rounded-full shadow">0</span>
			</button>
		</div>
	</div>

	<!-- Cart Modal -->
	<div id="cartModal" class="modal">
		<div class="modal-content mx-auto">
			<div class="flex justify-between items-center border-b pb-2 mb-4">
				<h3 class="text-xl font-bold text-papsi-dark">My Cart</h3>
				<button onclick="closeCart()" class="text-gray-400 hover:text-gray-600" aria-label="Close">
					<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
				</button>
			</div>
			<div id="cartList" class="space-y-3 max-h-80 overflow-y-auto"></div>
			<div class="mt-4 border-t pt-4">
					<div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
						<div class="flex-1">
						<label for="voucherInput" class="block text-sm font-medium text-gray-700 mb-1">Voucher Code</label>
						<div class="flex gap-2">
							<input id="voucherInput" type="text" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Enter voucher code for discount">
							<button id="validateVoucherBtn" onclick="validateVoucher()" class="bg-papsi-dark text-white px-3 py-2 rounded hover:bg-gray-800 transition-colors shrink-0">Validate</button>
						</div>
						<div id="voucherStatus" class="mt-1 text-sm"></div>
					</div>
					<div class="flex-1 text-right mt-2 md:mt-0">
						<div class="text-sm text-gray-600">Subtotal: <span id="cartSubtotal" class="font-semibold text-papsi-dark">₱0.00</span></div>
						<div id="cartDiscountRow" class="text-sm text-gray-600 hidden">Discount: <span id="cartDiscount" class="font-semibold text-papsi-green">-₱0.00</span></div>
						<div id="cartVoucherRow" class="text-sm text-gray-600 hidden">Voucher: <span id="cartVoucher" class="font-semibold text-papsi-green">-₱0.00</span></div>
						<div class="text-base font-bold text-papsi-green">Total: <span id="cartTotal">₱0.00</span></div>
					</div>
					</div>
			</div>
			<div class="mt-4 flex flex-col md:flex-row gap-2 justify-end">
				<button id="confirmRegistrationBtn" onclick="openCheckoutModal()" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700 transition-colors flex-1 md:flex-none">Confirm Registration</button>
				<button onclick="closeCart()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors flex-1 md:flex-none">Close</button>
			</div>
		</div>
	</div>

	<!-- Registration Success Modal -->
	<div id="registrationSuccessOverlay" class="fixed inset-0 bg-black/50 z-[3500] hidden" role="dialog" aria-modal="true" aria-labelledby="regSuccessTitle">
		<div class="absolute inset-0 flex items-center justify-center p-4">
			<div class="bg-white rounded-xl shadow-xl w-full max-w-md">
				<div class="flex items-center justify-between px-4 py-3 border-b">
					<h3 id="regSuccessTitle" class="text-lg font-semibold text-papsi-dark">Registration Successful</h3>
					<button id="regSuccessCloseX" class="text-gray-500 hover:text-gray-700" aria-label="Close">&times;</button>
				</div>
				<div class="px-4 py-4">
					<p id="regSuccessSubtitle" class="text-gray-700">Please see our email containing the payment procedures. Sent to your email address: <span class="font-semibold"></span></p>
				</div>
				<div class="px-4 pb-4 flex gap-2 justify-end">
					<button id="regSuccessOk" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700">Ok</button>
					<button id="regSuccessClose" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Close</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Checkout Details Modal -->
	<div id="checkoutModal" class="modal">
		<div class="modal-content mx-auto max-w-xl">
			<div class="flex justify-between items-center border-b pb-2 mb-4">
				<h3 class="text-xl font-bold text-papsi-dark">Checkout Details</h3>
				<button onclick="closeCheckoutModal()" class="text-gray-400 hover:text-gray-600" aria-label="Close">
					<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
				</button>
			</div>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
				<input id="checkoutEmail" type="email" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="name@example.com" aria-describedby="checkoutEmailHelp checkoutEmailAssist">
				<div id="checkoutEmailAssist" class="text-xs text-gray-600 -mt-1 mb-1"></div>
				<select id="checkoutTitleSelect" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" onchange="handleTitleChange()">
					<option value="">Select Title</option>
					<option>Mr.</option>
					<option>Ms.</option>
					<option>Dr.</option>
					<option>Engr.</option>
					<option>Prof.</option>
					<option>Other</option>
				</select>
				<div id="checkoutTitleOtherContainer" class="md:col-span-2 hidden">
					<input id="checkoutTitleOther" type="text" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Type your title">
				</div>
				<input id="checkoutFirstname" type="text" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="First Name">
				<input id="checkoutMiddleinitial" type="text" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Middle Initial (*Leave blank if not applicable)">
				<input id="checkoutLastname" type="text" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Last Name">
				<input id="checkoutSuffix" type="text" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Suffix (*Leave blank if not applicable)">
				<input id="checkoutMobile" type="text" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Mobile Number">
				<select id="checkoutSpecializationSelect" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" onchange="handleSpecializationChange()">
					<option value="">Select Specialization</option>
					<option>Physics</option>
					<option>Biology</option>
					<option>Chemistry</option>
					<option>Natural Science</option>
					<option>Physical Science</option>
					<option>General Science</option>
					<option>Earth Science</option>
					<option>Mathematics</option>
					<option>Other</option>
				</select>
				<div id="checkoutSpecializationOtherContainer" class="md:col-span-2 hidden">
					<input id="checkoutSpecializationOther" type="text" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Type your specialization">
				</div>
				<input id="checkoutSchool" type="text" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Name of School">
				<select id="checkoutType" class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green">
					<option value="">Select Type</option>
					<option>Private</option>
					<option>Public</option>
				</select>
				<input id="checkoutAddress" type="text" class="md:col-span-2 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Address of School">
				<div id="checkoutEmailHelp" class="md:col-span-2 text-xs text-gray-500">We'll send the payment instructions to this email. Use a format like name@example.com.</div>
			</div>
			<div class="mt-4 flex gap-2 justify-end">
				<button id="submitCheckoutBtn" onclick="handleCheckoutSubmit()" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">Submit</button>
				<button onclick="closeCheckoutModal()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Cancel</button>
			</div>
		</div>
	</div>

	<!-- Final Submit Confirmation Modal -->
	<div id="submitConfirmModal" class="modal">
		<div class="modal-content mx-auto max-w-sm">
			<div class="flex justify-between items-center border-b pb-2 mb-3">
				<h3 class="text-lg font-semibold text-papsi-dark">Confirmation</h3>
				<button onclick="closeSubmitConfirm()" class="text-gray-400 hover:text-gray-600" aria-label="Close">
					<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
				</button>
			</div>
			<p class="text-gray-700 mb-4">Do you confirm the courses and want to receive the payment procedures on your email?</p>
			<div class="flex gap-2 justify-end">
				<button id="submitConfirmYes" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700" onclick="proceedFinalSubmit()">Yes</button>
				<button id="submitConfirmCancel" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300" onclick="cancelFinalSubmit()">Cancel</button>
			</div>
		</div>
	</div>

	<!-- Image Viewer -->
	<div id="imageViewer" class="image-viewer" onclick="if(event.target===this) closeImageViewer()">
		<button class="viewer-close" aria-label="Close image" onclick="event.stopPropagation(); closeImageViewer()">&times;</button>
		<button id="viewerPrevBtn" class="viewer-nav viewer-prev" aria-label="Previous image" onclick="event.stopPropagation(); prevImage()">
			<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 15.707a1 1 0 01-1.414 0l-5-5a1 1 0 010-1.414l5-5a1 1 0 011.414 1.414L8.414 10l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
		</button>
		<div class="image-container" onclick="event.stopPropagation()">
			<img id="viewerImage" class="viewer-image" src="" alt="Training Image">
		</div>
		<button id="viewerNextBtn" class="viewer-nav viewer-next" aria-label="Next image" onclick="event.stopPropagation(); nextImage()">
			<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 4.293a1 1 0 011.414 0L13.707 9.293a1 1 0 010 1.414L8.707 15.707a1 1 0 01-1.414-1.414L11.586 10 7.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
		</button>
		<div class="viewer-controls" onclick="event.stopPropagation()">
			<button class="viewer-btn" aria-label="Zoom out" onclick="zoomOut()">
				<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z"/></svg>
			</button>
			<button class="viewer-btn" aria-label="Rotate" onclick="rotateImage()">
				<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M3.172 7A8 8 0 1110 18v-2a6 6 0 10-5.196-3H7l-4 4-4-4h2.172z"/></svg>
			</button>
			<button class="viewer-btn" aria-label="Zoom in" onclick="zoomIn()">
				<svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 010 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/></svg>
			</button>
		</div>
	</div>

	<!-- About Modal -->
	<div id="aboutModal" class="modal">
		<div class="modal-content mx-auto">
			<div class="flex justify-between items-center border-b pb-2 mb-4">
				<h3 id="aboutTitle" class="text-xl font-bold text-papsi-dark">About</h3>
				<button onclick="closeAbout()" class="text-gray-400 hover:text-gray-600" aria-label="Close">
					<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
				</button>
			</div>
			<div id="aboutContent" class="text-sm text-gray-700"></div>
			<div class="mt-4 flex justify-end gap-2">
				<button id="aboutRegisterBtn" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700" onclick="if(window.aboutCourseId){ addToCart(window.aboutCourseId); }">Register Now</button>
				<button class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300" onclick="closeAbout()">Close</button>
			</div>
		</div>
	</div>

	<!-- Audio Modal -->
	<div id="audioModal" class="modal">
		<div class="modal-content mx-auto">
			<div class="flex justify-between items-center border-b pb-2 mb-4">
				<h3 id="audioTitle" class="text-xl font-bold text-papsi-dark">Audio Preview</h3>
				<button onclick="closeAudio()" class="text-gray-400 hover:text-gray-600" aria-label="Close">
					<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
				</button>
			</div>
			<div id="audioContent"></div>
		</div>
	</div>

	<script>
		// --- Constants and state ---
		var AUTH_BASE = 'https://script.google.com/macros/s/AKfycbydRAAaO83lKJpCpu7a48YlncAX9R5N1KvRx5LqMofd6Dd-O1S_Mnp9tGysVGFV7q6dZQ/exec';
		var TRAININGS_URL = 'https://script.google.com/macros/s/AKfycbz8awvt1aQpxA-7vfyp7WJRQLODyHdhVlaMfn7KsRnGIBaLaeQ_7ZYED4qI4kL0CpmXsw/exec?SH=training&func=training';
		var VOUCHER_BASE = 'https://script.google.com/macros/s/AKfycbz8awvt1aQpxA-7vfyp7WJRQLODyHdhVlaMfn7KsRnGIBaLaeQ_7ZYED4qI4kL0CpmXsw/exec';
		var CART_STORAGE_KEY = 'PAPSI_CART_ITEMS';
		var TRAINING_STATS_VISIBLE_KEY = 'PAPSI_TRAINING_STATS_VISIBLE';

		var allCourses = [];
		var filteredCourses = [];
		var cartCourses = [];
		var appliedVoucher = null; // { code, percentage }

		var currentPage = 1;
		var coursesPerPage = 8;

		// --- Toast ---
		function ensureToastContainer(){
			var c = document.getElementById('toastContainer');
			if(!c){
				c = document.createElement('div');
				c.id = 'toastContainer';
				c.className = 'fixed z-[4000] top-4 right-4 flex flex-col gap-2';
				document.body.appendChild(c);
			}
			return c;
		}
		function showToast(message, type, durationMs){
			var color = 'bg-gray-800';
			if(type === 'success') color = 'bg-green-600';
			else if(type === 'error') color = 'bg-red-600';
			else if(type === 'info') color = 'bg-blue-600';
			var container = ensureToastContainer();
			var toast = document.createElement('div');
			toast.setAttribute('role','alert');
			toast.className = color + ' text-white px-4 py-3 rounded shadow-lg flex items-center gap-2 transition ease-out duration-300 opacity-0 translate-y-2';
			toast.innerHTML = '<span>'+String(message||'')+'</span>'+
												'<button class="ml-2 bg-white/20 hover:bg-white/30 text-white text-xs px-2 py-1 rounded">Close</button>';
			var closeBtn = null;
			setTimeout(function(){ toast.classList.remove('opacity-0','translate-y-2'); toast.classList.add('opacity-100','translate-y-0'); }, 10);
			container.appendChild(toast);
			closeBtn = toast.querySelector('button');
			function removeToast(){ toast.classList.remove('opacity-100','translate-y-0'); toast.classList.add('opacity-0','translate-y-2'); setTimeout(function(){ if(toast && toast.parentNode){ toast.parentNode.removeChild(toast); } },200); }
			if(closeBtn){ closeBtn.addEventListener('click', removeToast); }
			setTimeout(removeToast, Math.max(1500, durationMs || 3000));
		}

		// --- Category colors ---
		var CATEGORY_PALETTE = [
			{ badge: 'bg-emerald-100 text-emerald-800', stats: 'text-emerald-600' },
			{ badge: 'bg-blue-100 text-blue-800', stats: 'text-blue-600' },
			{ badge: 'bg-purple-100 text-purple-800', stats: 'text-purple-600' },
			{ badge: 'bg-orange-100 text-orange-800', stats: 'text-orange-600' },
			{ badge: 'bg-rose-100 text-rose-800', stats: 'text-rose-600' },
			{ badge: 'bg-sky-100 text-sky-800', stats: 'text-sky-600' },
			{ badge: 'bg-teal-100 text-teal-800', stats: 'text-teal-600' },
			{ badge: 'bg-amber-100 text-amber-800', stats: 'text-amber-600' },
			{ badge: 'bg-indigo-100 text-indigo-800', stats: 'text-indigo-600' },
			{ badge: 'bg-lime-100 text-lime-800', stats: 'text-lime-600' },
			{ badge: 'bg-fuchsia-100 text-fuchsia-800', stats: 'text-fuchsia-600' },
			{ badge: 'bg-cyan-100 text-cyan-800', stats: 'text-cyan-600' },
			{ badge: 'bg-violet-100 text-violet-800', stats: 'text-violet-600' },
			{ badge: 'bg-pink-100 text-pink-800', stats: 'text-pink-600' },
			{ badge: 'bg-slate-100 text-slate-800', stats: 'text-slate-600' },
			{ badge: 'bg-stone-100 text-stone-800', stats: 'text-stone-600' }
		];
		function hashStringToInt(str){ var h=0; for(var i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0; } return Math.abs(h); }
		function getCategoryPalette(category){ var key=String(category||'Other').trim().toLowerCase(); var idx = hashStringToInt(key)%CATEGORY_PALETTE.length; return CATEGORY_PALETTE[idx]; }
		function categoryBadgeClasses(category){ return getCategoryPalette(category).badge; }
		function categoryStatsText(category){ return getCategoryPalette(category).stats; }

		// --- Utilities ---
		function formatMoney(n){ return '₱' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
		function formatDateMDY(d){ try{ var dt=(d instanceof Date)?d:new Date(d); if(isNaN(dt)) return ''; var m=String(dt.getMonth()+1).padStart(2,'0'); var day=String(dt.getDate()).padStart(2,'0'); var y=dt.getFullYear(); return m+'/'+day+'/'+y; }catch(e){ return ''; } }
		function formatTimestampUS(d){ try{ var dt=(d instanceof Date)?d:new Date(d); if(isNaN(dt)) return ''; var mdy=formatDateMDY(dt); var h=dt.getHours(); var min=String(dt.getMinutes()).padStart(2,'0'); var ampm=h>=12?'PM':'AM'; h=h%12; if(h===0) h=12; var hh=String(h).padStart(2,'0'); return mdy+' '+hh+':'+min+' '+ampm; }catch(e){ return ''; } }

		function parseCourseFees(course){
			var reg=0, promo=0;
			if(course && course.originalPrice){ reg = parseFloat(String(course.originalPrice).toString().replace(/[^0-9.]/g,'')) || 0; }
			if(course && course.price){ promo = parseFloat(String(course.price).toString().replace(/[^0-9.]/g,'')) || 0; }
			if(reg===0 && promo>0) reg=promo; if(promo===0 && reg>0) promo=reg; return { reg:reg, promo:promo };
		}
		function computeCartTotals(){
			var regularSum=0, promoSum=0; var i;
			for(i=0;i<cartCourses.length;i++){
				var id = cartCourses[i];
				var c = null;
				for(var j=0;j<allCourses.length;j++){ if(allCourses[j].id===id){ c=allCourses[j]; break; } }
				if(!c) continue;
				var f = parseCourseFees(c); regularSum += f.reg; promoSum += f.promo;
			}
			var baseDiscount = Math.max(0, regularSum - promoSum);
			var voucherDiscount = 0;
			if(appliedVoucher && typeof appliedVoucher.percentage==='number' && appliedVoucher.percentage>0){ voucherDiscount = promoSum * (appliedVoucher.percentage/100); }
			var total = Math.max(0, promoSum - voucherDiscount);
			return { regularSum:regularSum, promoSum:promoSum, baseDiscount:baseDiscount, voucherDiscount:voucherDiscount, total:total };
		}

		function persistCart(){ try { localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartCourses)); } catch(e){} }
		function loadCart(){ try{ var saved=JSON.parse(localStorage.getItem(CART_STORAGE_KEY)||'[]'); if(Array.isArray(saved)) cartCourses=saved; }catch(e){} }

		function openCart(){
			// Render cart items
			var cartList = document.getElementById('cartList');
			var html = '';
			if(cartCourses.length===0){ html = '<div class="text-gray-500 text-center">Your cart is empty.</div>'; }
			else {
				for(var i=0;i<cartCourses.length;i++){
					var id = cartCourses[i];
					var course = null; for(var j=0;j<allCourses.length;j++){ if(allCourses[j].id===id){ course=allCourses[j]; break; } }
					if(!course) continue;
					var fees = parseCourseFees(course);
					html += '<div class="flex flex-col md:flex-row md:justify-between md:items-center border-b pb-2 gap-1 group">'+
									'<span class="font-medium">'+escapeHtml(course.title)+'</span>'+
									'<span class="flex items-center gap-2">'+
									(fees.reg>0?('<span class="text-gray-400 line-through text-sm">'+formatMoney(fees.reg)+'</span>'):'')+
									'<span class="font-semibold text-papsi-gold">'+formatMoney(fees.promo)+'</span>'+
									'<button onclick="removeFromCart(\''+course.id+'\')" class="ml-2 text-gray-400 hover:text-red-600 transition-colors" title="Remove">'+
									'<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg></button></span></div>';
				}
			}
			cartList.innerHTML = html;

			var totals = computeCartTotals();
			document.getElementById('cartSubtotal').textContent = formatMoney(totals.regularSum);
			var discRow = document.getElementById('cartDiscountRow'); var discEl = document.getElementById('cartDiscount');
			if(discRow && discEl){ if(totals.baseDiscount>0){ discRow.classList.remove('hidden'); discEl.textContent='-'+formatMoney(totals.baseDiscount).replace('₱','₱'); } else { discRow.classList.add('hidden'); discEl.textContent='-₱0.00'; } }
			var vRow = document.getElementById('cartVoucherRow'); var vEl = document.getElementById('cartVoucher');
			if(vRow && vEl){ if(totals.voucherDiscount>0){ vRow.classList.remove('hidden'); vEl.textContent='-'+formatMoney(totals.voucherDiscount).replace('₱','₱'); } else { vRow.classList.add('hidden'); vEl.textContent='-₱0.00'; } }
			document.getElementById('cartTotal').textContent = formatMoney(totals.total);

			var m = document.getElementById('cartModal'); if(m) m.classList.add('open'); document.body.style.overflow='hidden';
			updateCartBar();
		}
		function closeCart(){ var m=document.getElementById('cartModal'); if(m) m.classList.remove('open'); document.body.style.overflow=''; updateCartBar(); }

		function updateCartCount(){ var el=document.getElementById('trainingBarCount'); if(el){ el.textContent = String(cartCourses.length); } updateCartBar(); }
		function updateCartBar(){
			var count = cartCourses.length;
			var bar = document.getElementById('trainingCartBar');
			if(!bar) return;
			// Hide if any overlay open
			var overlaysOpen = false;
			var iv = document.getElementById('imageViewer'); if(iv && iv.classList.contains('open')) overlaysOpen=true;
			var ab = document.getElementById('aboutModal'); if(ab && ab.classList.contains('open')) overlaysOpen=true;
			var au = document.getElementById('audioModal'); if(au && au.classList.contains('open')) overlaysOpen=true;
			var cm = document.getElementById('cartModal'); if(cm && cm.classList.contains('open')) overlaysOpen=true;
			if(count>0 && !overlaysOpen){
				var totals = computeCartTotals();
				var sub=document.getElementById('trainingBarSubtotal'); if(sub) sub.textContent = formatMoney(totals.regularSum);
				var tot=document.getElementById('trainingBarTotal'); if(tot) tot.textContent = formatMoney(totals.total);
				var cnt=document.getElementById('trainingBarCount'); if(cnt) cnt.textContent = String(count);
				bar.classList.remove('hidden');
				var spacer = document.getElementById('trainingBottomSpacer'); if(spacer){ spacer.className='h-24 md:h-20'; }
			} else {
				bar.classList.add('hidden');
				var spacer2 = document.getElementById('trainingBottomSpacer'); if(spacer2){ spacer2.className='h-0'; }
			}
		}

		// Voucher
		async function validateVoucher(){
			var input = document.getElementById('voucherInput');
			var status = document.getElementById('voucherStatus');
			if(!status) return;
			var code = '';
			if(input && typeof input.value === 'string') code = input.value.trim().toUpperCase();
			if(!code){ status.innerHTML = '<span class="text-red-600">Please enter a voucher code.</span>'; appliedVoucher=null; openCart(); return; }
			status.innerHTML = '<span class="text-gray-600">Validating voucher…</span>';
			var url = VOUCHER_BASE + '?SH=voucher&func=voucher&code=' + encodeURIComponent(code);
			try{
				var res = await fetch(url, { method:'GET' });
				var text = await res.text();
				try{
					var data = JSON.parse(text);
					var pct = Number(data.percentage);
					if(isNaN(pct) || pct<=0) throw new Error('Invalid voucher percentage.');
					appliedVoucher = { code: (data.code || code), percentage: pct };
					status.innerHTML = '<span class="text-green-700">Voucher applied: '+appliedVoucher.percentage+'% off</span>';
					openCart();
				} catch(e){
					var msg = (text||'').trim();
					if(/expired/i.test(msg)) status.innerHTML = '<span class="text-red-600">Voucher expired.</span>';
					else if(/invalid/i.test(msg)) status.innerHTML = '<span class="text-red-600">Error: Invalid code.</span>';
					else status.innerHTML = '<span class="text-red-600">'+(msg||'Unable to validate voucher.')+'</span>';
					appliedVoucher = null; openCart();
				}
			} catch(err){ status.innerHTML = '<span class="text-red-600">'+(err && err.message ? err.message : 'Network error validating voucher.')+'</span>'; appliedVoucher=null; openCart(); }
		}

		function addToCart(id){ var wasEmpty = cartCourses.length===0; if(cartCourses.indexOf(id)===-1){ cartCourses.push(id); renderCourses(); updateCartCount(); persistCart(); try{ var c=findCourse(id); showToast((c && c.title) ? (c.title+' added to cart') : 'Added to cart','success',3000);}catch(e){} updateCartBar(); if(wasEmpty){ setTimeout(updateCartBar, 300); } } }
		function removeFromCart(id){ var idx = cartCourses.indexOf(id); if(idx!==-1){ cartCourses.splice(idx,1); openCart(); updateCartCount(); renderCourses(); persistCart(); updateCartBar(); } }

		function findCourse(id){ for(var i=0;i<allCourses.length;i++){ if(allCourses[i].id===id) return allCourses[i]; } return null; }

		// Filters + rendering
		function closeFiltersDrawer(){ var drawer=document.getElementById('trainingFiltersDrawer'); if(!drawer) return; drawer.classList.remove('open'); document.body.style.overflow=''; }
		function toggleDrawer(){ var drawer=document.getElementById('trainingFiltersDrawer'); if(!drawer) return; var isOpen = drawer.classList.contains('open'); if(isOpen){ closeFiltersDrawer(); } else { drawer.classList.add('open'); document.body.style.overflow='hidden'; } }

		async function loadTrainingCourses(){
			var grid = document.getElementById('coursesGrid');
			var counter = document.getElementById('resultsCounter');
			grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Loading courses...</div>';
			try{
				var res = await fetch(TRAININGS_URL);
				var data = await res.json();
				allCourses = Array.isArray(data) ? data.map(function(item, idx){
					return {
						id: 'course-'+idx,
						title: item.title,
						date: new Date(item.date),
						hours: item.hours,
						hoursNum: parseFloat(item.hours)||0,
						instructor: item.speaker,
						image: (typeof item.poster==='string' && item.poster.indexOf('http')===0) ? item.poster : '',
						category: item.category,
						price: item.promo_fee ? ('₱'+item.promo_fee) : '',
						originalPrice: item.regular_fee ? ('₱'+item.regular_fee) : '',
						description: item.about,
						audio: (item.audio && typeof item.audio==='string') ? item.audio : '',
						duration: (item.hours ? (item.hours+' hours') : '')
					};
				}) : [];
				populateCourseFilters();
				filteredCourses = allCourses.slice();
				renderCourses();
				updateCounters();
			} catch(e){ grid.innerHTML = '<div class="col-span-full text-center py-12 text-red-500">Failed to load courses.</div>'; if(counter) counter.textContent = 'Showing 0 of 0 courses'; allCourses=[]; filteredCourses=[]; }
		}

		function populateCourseFilters(){
			var categoryFilter = document.getElementById('categoryFilter');
			var speakerFilter = document.getElementById('speakerFilter');
			if(!categoryFilter || !speakerFilter) return;
			var catsMap = {}; var spMap = {}; var i;
			for(i=0;i<allCourses.length;i++){ var c=allCourses[i]; if(c.category){ catsMap[c.category]=1; } if(c.instructor){ spMap[c.instructor]=1; } }
			var cats = Object.keys(catsMap).sort(); var sps = Object.keys(spMap).sort();
			var selCat = categoryFilter.value; var selSp = speakerFilter.value;
			categoryFilter.innerHTML = '<option value="all">All Categories</option>' + cats.map(function(cat){ return '<option value="'+escapeHtml(cat)+'">'+escapeHtml(cat)+'</option>'; }).join('');
			if(cats.indexOf(selCat)!==-1) categoryFilter.value = selCat; else categoryFilter.value = 'all';
			speakerFilter.innerHTML = '<option value="all">All Speakers</option>' + sps.map(function(sp){ return '<option value="'+escapeHtml(sp)+'">'+escapeHtml(sp)+'</option>'; }).join('');
			if(sps.indexOf(selSp)!==-1) speakerFilter.value = selSp; else speakerFilter.value = 'all';
		}

		function filterCourses(){
			var searchTerm = String(document.getElementById('searchInput').value||'').toLowerCase();
			var catVal = document.getElementById('categoryFilter').value;
			var spVal = document.getElementById('speakerFilter').value;
			var sortVal = document.getElementById('dateSort').value;
			var yearFilter = window.trainingYearFilter || null;
			filteredCourses = allCourses.filter(function(course){
				var matchesSearch = !searchTerm || course.title.toLowerCase().indexOf(searchTerm)!==-1 || (course.instructor||'').toLowerCase().indexOf(searchTerm)!==-1 || (course.description||'').toLowerCase().indexOf(searchTerm)!==-1;
				var matchesCategory = (catVal==='all') || course.category===catVal;
				var matchesSpeaker = (spVal==='all') || course.instructor===spVal;
				var matchesYear = !yearFilter || (course.date instanceof Date && !isNaN(course.date) && course.date.getFullYear()===yearFilter);
				return matchesSearch && matchesCategory && matchesSpeaker && matchesYear;
			});
			filteredCourses.sort(function(a,b){ return (sortVal==='newest') ? (b.date - a.date) : (a.date - b.date); });
			currentPage = 1; renderCourses(); updateCounters(); renderTrainingStats(); try{ renderTrainingFilterChips(); }catch(e){}
		}

		function renderCourses(){
			var grid = document.getElementById('coursesGrid'); var pag = document.getElementById('coursesPagination');
			if(filteredCourses.length===0){ grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">No courses found.</div>'; if(pag) pag.innerHTML=''; return; }
			var total = filteredCourses.length; var totalPages = Math.ceil(total / coursesPerPage);
			if(currentPage>totalPages) currentPage=totalPages; if(currentPage<1) currentPage=1;
			var startIdx = (currentPage-1)*coursesPerPage; var endIdx=startIdx+coursesPerPage; var items = filteredCourses.slice(startIdx, endIdx);
			var html = '';
			for(var i=0;i<items.length;i++){
				var course = items[i];
				var discountVal=0, regVal=0, promoVal=0;
				if(course.originalPrice && course.price){ regVal=parseFloat(String(course.originalPrice).replace(/[^0-9.]/g,'')); promoVal=parseFloat(String(course.price).replace(/[^0-9.]/g,'')); discountVal = (regVal||0) - (promoVal||0); }
				var inCart = cartCourses.indexOf(course.id)!==-1;
				html += ''+
				'<div class="bg-white rounded-lg shadow-sm overflow-hidden card-hover">'+
					'<div class="relative bg-white overflow-hidden">'+
						'<img src="'+escapeAttr(course.image)+'" alt="'+escapeAttr(course.title)+'" class="block w-full h-auto object-contain training-image" loading="lazy" decoding="async" onclick="openImageViewer(this.src, this.alt)" onerror="this.src=\'\'; this.alt=\'Image failed to load\'; this.style.display=\'none\';">'+
						'<div class="absolute top-2 left-2"><span class="'+categoryBadgeClasses(course.category)+' px-2 py-1 rounded text-xs font-medium">'+escapeHtml(course.category || 'Other')+'</span></div>'+
						'<div class="absolute top-2 right-2 flex space-x-1">'+
							'<button onclick="showAbout(\''+course.id+'\')" class="bg-papsi-green text-white rounded-full p-2 shadow-sm hover:bg-green-700 transition-all" aria-label="About">'+
								'<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>'+
							'</button>'+
							'<button onclick="playAudio(\''+course.id+'\')" class="bg-papsi-green text-white rounded-full p-2 shadow-sm hover:bg-green-700 transition-all '+(!course.audio?'opacity-50 cursor-not-allowed':'')+'" '+(!course.audio?'disabled':'')+' aria-label="Audio Preview">'+
								'<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.797l-4.146-3.317a1 1 0 00-.632-.22H2a1 1 0 01-1-1V7.64a1 1 0 011-1h1.605a1 1 0 00.632-.22l4.146-3.317a1 1 0 011.617.797zM14.657 7.757a1 1 0 011.414 0A9.972 9.972 0 0118 12a9.972 9.972 0 01-1.929 4.243 1 1 0 11-1.414-1.414A7.971 7.971 0 0016 12c0-1.594-.463-3.078-1.343-4.243a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>'+
							'</button>'+
						'</div>'+
						'<div class="absolute left-2 right-2 bottom-2 bg-white rounded-md shadow px-3 py-2">'+
							'<div class="text-papsi-dark font-semibold text-sm">'+escapeHtml(course.title)+'</div>'+
							'<div class="text-gray-600 text-xs mt-0.5">'+escapeHtml(course.instructor||'')+'</div>'+
						'</div>'+
						'<div class="absolute bottom-2 right-2 flex items-center gap-2">'+
							'<div class="bg-white rounded px-2 py-1 shadow text-xs font-medium">'+
								'<span class="text-papsi-gold font-semibold">'+escapeHtml(course.price||'')+'</span>'+
								(course.originalPrice ? ('<span class="text-gray-400 line-through ml-1">'+escapeHtml(course.originalPrice)+'</span>') : '')+
							'</div>'+
							(discountVal>0 ? ('<div class="bg-white rounded px-2 py-1 shadow text-xs font-medium">₱'+String(discountVal) +' OFF</div>') : '')+
							'<div class="bg-white rounded px-2 py-1 shadow text-xs font-medium">'+escapeHtml(course.duration||'')+'</div>'+
						'</div>'+
					'</div>'+
					'<div class="p-4">'+
						(inCart ? (
							'<div class="added-success-banner added-banner-animate w-full rounded-md bg-green-50 border border-green-200 p-3 flex flex-col gap-3" role="status" aria-live="polite">'+
								'<div class="flex items-start gap-3">'+
									'<div class="flex-shrink-0 w-8 h-8 rounded-full bg-papsi-green text-white flex items-center justify-center">'+
										'<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a1 1 0 00-1.414-1.414L9 10.414 7.557 8.97a1 1 0 10-1.414 1.415l2.121 2.12a1 1 0 001.414 0l4.179-4.314z" clip-rule="evenodd"/></svg>'+
									'</div>'+
									'<div class="flex-1"><p class="text-sm font-semibold text-papsi-green leading-snug">Added to cart</p><p class="text-xs text-green-700 mt-0.5">Proceed to checkout when you\'re ready.</p></div>'+
								'</div>'+
								'<div><button type="button" onclick="openCart(); event.stopPropagation();" class="w-full inline-flex items-center justify-center gap-2 bg-papsi-green hover:bg-green-700 text-white text-sm font-medium px-3 py-2 rounded-md shadow-sm transition"><span>View Cart</span></button></div>'+
							'</div>'
						) : (
							'<button class="w-full py-2 rounded bg-papsi-green hover:bg-green-700 text-white text-sm font-medium" onclick="addToCart(\''+course.id+'\'); event.stopPropagation();">Register Now</button>'
						))+
					'</div>'+
				'</div>';
			}
			grid.innerHTML = html;
			if(pag){
				if(totalPages>1){
					pag.innerHTML = '<div class="flex items-center space-x-4">'+
													'<button onclick="changeCoursesPage(-1)" class="px-4 py-2 rounded border '+(currentPage===1?'bg-gray-200 text-gray-400 cursor-not-allowed':'bg-white text-gray-700 hover:bg-gray-100')+'" '+(currentPage===1?'disabled':'')+'>Previous</button>'+
													'<span class="mx-2 text-sm">Page '+currentPage+' of '+totalPages+'</span>'+
													'<button onclick="changeCoursesPage(1)" class="px-4 py-2 rounded border '+(currentPage===totalPages?'bg-gray-200 text-gray-400 cursor-not-allowed':'bg-white text-gray-700 hover:bg-gray-100')+'" '+(currentPage===totalPages?'disabled':'')+'>Next</button>'+
													'</div>';
				} else { pag.innerHTML = ''; }
			}
			try{ renderTrainingFilterChips(); }catch(e){}
		}

		function changeCoursesPage(delta){ var totalPages=Math.ceil(filteredCourses.length/coursesPerPage); currentPage += delta; if(currentPage<1) currentPage=1; if(currentPage>totalPages) currentPage=totalPages; renderCourses(); updateCounters(); }
		function updateCounters(){ var searchTerm=String(document.getElementById('searchInput').value||'').toLowerCase(); var catVal=document.getElementById('categoryFilter').value; var spVal=document.getElementById('speakerFilter').value; var totalAvailable = 0; for(var i=0;i<allCourses.length;i++){ var c=allCourses[i]; var matchesSearch=!searchTerm || c.title.toLowerCase().indexOf(searchTerm)!==-1 || (c.instructor||'').toLowerCase().indexOf(searchTerm)!==-1 || (c.description||'').toLowerCase().indexOf(searchTerm)!==-1; var matchesCategory=(catVal==='all')||c.category===catVal; var matchesSpeaker=(spVal==='all')||c.instructor===spVal; if(matchesSearch && matchesCategory && matchesSpeaker){ totalAvailable++; } } var startIdx=(currentPage-1)*coursesPerPage; var shown=Math.max(0, Math.min(coursesPerPage, filteredCourses.length - startIdx)); var rc=document.getElementById('resultsCounter'); if(rc){ rc.textContent='Showing '+shown+' of '+totalAvailable+' courses'; } updateCartCount(); }

		function renderTrainingStats(){
			var grid = document.getElementById('trainingStatsGrid'); var yearBars = document.getElementById('trainingYearBars'); if(!grid) return;
			var total = allCourses.length; var categories = {}; var totalHours=0; for(var i=0;i<allCourses.length;i++){ var c=allCourses[i]; var key=c.category||'Other'; categories[key]=(categories[key]||0)+1; totalHours += (c.hoursNum||0); }
			var parts = [ '<div class="text-center"><div class="text-2xl font-bold text-papsi-green">'+total+'</div><div class="text-sm text-gray-600">Total Courses</div></div>', '<div class="text-center"><div class="text-2xl font-bold text-papsi-dark">'+totalHours+'</div><div class="text-sm text-gray-600">Total Hours</div></div>', '<div class="col-span-full text-[11px] text-gray-600 mt-1">Click a category to filter courses.</div>' ];
			var catKeys = Object.keys(categories).sort(); for(var k=0;k<catKeys.length;k++){ var cat=catKeys[k]; var pal = categoryStatsText(cat); var enc = encodeURIComponent(cat); parts.push('<button type="button" data-cat="'+enc+'" class="text-center group rounded p-2 hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-papsi-green/40" title="Filter by '+escapeAttr(cat)+'"><div class="text-xl font-semibold '+pal+' group-hover:text-papsi-green">'+categories[cat]+'</div><div class="text-sm text-gray-600">'+escapeHtml(cat)+'</div></button>'); }
			grid.innerHTML = parts.join('');
			var btns = grid.querySelectorAll('[data-cat]'); for(var b=0;b<btns.length;b++){ btns[b].addEventListener('click', function(){ var raw=this.getAttribute('data-cat')||''; var val=decodeURIComponent(raw); var sel=document.getElementById('categoryFilter'); if(sel){ var opts=[]; for(var o=0;o<sel.options.length;o++){ opts.push(sel.options[o].value); } sel.value = (opts.indexOf(val)!==-1) ? val : 'all'; } filterCourses(); var gridEl = document.getElementById('coursesGrid'); try{ gridEl.scrollIntoView({behavior:'smooth', block:'start'});}catch(e){} }); }

			if(yearBars){ var yearCounts={}; for(var i2=0;i2<allCourses.length;i2++){ var cc=allCourses[i2]; if(cc.date instanceof Date && !isNaN(cc.date)){ var y=cc.date.getFullYear(); yearCounts[y]=(yearCounts[y]||0)+1; } } var years = Object.keys(yearCounts).map(function(y){return parseInt(y,10);}).sort(function(a,b){return a-b;}); if(!years.length){ yearBars.innerHTML=''; yearBars.classList.add('hidden'); } else { yearBars.classList.remove('hidden'); var maxVal=0; var gt=0; for(var ii=0;ii<years.length;ii++){ var y2=years[ii]; if(yearCounts[y2]>maxVal) maxVal=yearCounts[y2]; gt += yearCounts[y2]; } var sparkWidth=160, sparkHeight=38, cumulative=0; var pts=[]; for(var iii=0;iii<years.length;iii++){ var y3=years[iii]; cumulative += yearCounts[y3]; var x = (iii/((years.length-1)||1))*sparkWidth; var yPos = sparkHeight - (cumulative/gt)*sparkHeight; pts.push(x.toFixed(1)+','+yPos.toFixed(1)); }
				var sparkline = '<div class="mt-4 mb-2"><div class="flex items-center justify-between mb-1"><span class="text-xs font-medium text-gray-600">Cumulative Growth</span><span class="text-[10px] text-gray-500">'+gt+' total</span></div><svg viewBox="0 0 '+sparkWidth+' '+sparkHeight+'" class="w-full max-w-xs h-10 text-papsi-green/70"><polyline fill="none" stroke="currentColor" stroke-width="2" points="'+pts.join(' ')+'" stroke-linejoin="round" stroke-linecap="round" /></svg><div class="text-[11px] text-gray-600 mt-1">Click a year to filter courses.</div></div>';
				var selected = window.trainingYearFilter || null; var barsHtml=''; for(var ivv=years.length-1; ivv>=0; ivv--){ var yv=years[ivv]; var count=yearCounts[yv]; var pct = maxVal ? (count/maxVal)*100 : 0; var share = ((count/gt)*100).toFixed(1); var active = (selected===yv); barsHtml += '<button type="button" data-year="'+yv+'" class="group w-full flex items-center gap-3 text-left year-bar-item '+(active?'ring-1 ring-papsi-green/60 bg-green-50':'')+'" title="'+count+' course'+(count!==1?'s':'')+' in '+yv+' ('+share+'% of total)"><div class="w-14 text-right text-xs '+(active?'text-papsi-green font-semibold':'text-gray-600 font-medium')+'">'+yv+'</div><div class="relative flex-1 h-3 rounded bg-gray-100 overflow-hidden"><div class="h-full bg-gradient-to-r from-papsi-green to-emerald-500" style="width:'+pct+'%"></div><span class="absolute inset-0 flex items-center justify-center text-[10px] font-semibold text-white/90 mix-blend-difference pointer-events-none">'+count+'</span><span class="absolute -right-1 -top-4 text-[10px] text-gray-500">'+share+'%</span></div></button>'; }
				yearBars.innerHTML = sparkline + barsHtml + '<div class="mt-2"><button type="button" id="resetTrainingYearFilterBtn" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 '+(selected?'':'opacity-40 cursor-default')+'" '+(selected?'':'disabled')+'>All Years</button></div>';
				var yBtns = yearBars.querySelectorAll('[data-year]'); for(var yy=0;yy<yBtns.length;yy++){ yBtns[yy].addEventListener('click', function(){ var y=parseInt(this.getAttribute('data-year'),10); if(window.trainingYearFilter===y){ window.trainingYearFilter=null; } else { window.trainingYearFilter=y; } filterCourses(); }); }
				var reset = document.getElementById('resetTrainingYearFilterBtn'); if(reset){ reset.addEventListener('click', function(){ if(window.trainingYearFilter){ window.trainingYearFilter=null; filterCourses(); } }); }
			} }
		}

		function renderTrainingFilterChips(){
			var chips = document.getElementById('trainingFilterChips'); var clearBtn = document.getElementById('trainingClearFilters'); if(!chips||!clearBtn) return;
			var search = document.getElementById('searchInput'); var category = document.getElementById('categoryFilter'); var speaker = document.getElementById('speakerFilter'); var year = window.trainingYearFilter || null; var items=[];
			if(search && String(search.value).trim()){ items.push({key:'search', label:'Search: '+String(search.value).trim()}); }
			if(category && category.value!=='all'){ items.push({key:'category', label:'Category: '+category.value}); }
			if(speaker && speaker.value!=='all'){ items.push({key:'speaker', label:'Speaker: '+speaker.value}); }
			if(year){ items.push({key:'year', label:'Year: '+year}); }
			if(!items.length){ chips.classList.add('hidden'); clearBtn.classList.add('hidden'); chips.innerHTML=''; return; }
			chips.classList.remove('hidden'); clearBtn.classList.remove('hidden');
			var inner=''; for(var i=0;i<items.length;i++){ var it=items[i]; inner += '<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-50 text-papsi-green text-xs font-medium" data-key="'+it.key+'">'+escapeHtml(it.label)+'<button type="button" class="ml-1 text-papsi-green/80 hover:text-papsi-green" aria-label="Remove '+it.key+'" data-remove="'+it.key+'">×</button></span>'; }
			chips.innerHTML = inner;
			var rBtns = chips.querySelectorAll('[data-remove]'); for(var b=0;b<rBtns.length;b++){ rBtns[b].addEventListener('click', function(){ var key=this.getAttribute('data-remove'); if(key==='search'){ if(search){ search.value=''; var cs=document.getElementById('clearSearch'); if(cs) cs.classList.add('hidden'); } } if(key==='category'){ if(category){ category.value='all'; } } if(key==='speaker'){ if(speaker){ speaker.value='all'; } } if(key==='year'){ window.trainingYearFilter=null; } filterCourses(); }); }
		}

		function clearSearch(){ var s=document.getElementById('searchInput'); if(s){ s.value=''; } var cs=document.getElementById('clearSearch'); if(cs){ cs.classList.add('hidden'); } filterCourses(); }

		function clearAllTrainingFilters(){
			try{
				var s=document.getElementById('searchInput'); if(s){ s.value=''; }
				var cs=document.getElementById('clearSearch'); if(cs){ cs.classList.add('hidden'); }
				var cat=document.getElementById('categoryFilter'); if(cat){ cat.value='all'; }
				var sp=document.getElementById('speakerFilter'); if(sp){ sp.value='all'; }
				window.trainingYearFilter = null;
				filterCourses();
			}catch(e){}
		}

		// Stats visibility helpers
		function getSavedStatsVisible(){ try{ var v=localStorage.getItem(TRAINING_STATS_VISIBLE_KEY); return v==='1' || v==='true'; }catch(e){ return false; } }
		function saveStatsVisible(v){ try{ localStorage.setItem(TRAINING_STATS_VISIBLE_KEY, v ? '1' : '0'); }catch(e){} }
		function updateStatsToggleUI(isVisible){
			var btn = document.getElementById('trainingStatsToggle');
			var section = document.getElementById('trainingStatsSection');
			if(section){ if(isVisible){ section.classList.remove('hidden'); } else { section.classList.add('hidden'); } }
			if(btn){
				btn.setAttribute('aria-expanded', String(!!isVisible));
				try{
					var spans = btn.getElementsByTagName('span');
					for(var i=0;i<spans.length;i++){
						if(spans[i].textContent && /show stats|hide stats/i.test(spans[i].textContent)){
							spans[i].textContent = isVisible ? 'Hide Stats' : 'Show Stats';
							break;
						}
					}
				}catch(e){}
			}
		}
		function toggleTrainingStats(){ var next = !getSavedStatsVisible(); saveStatsVisible(next); updateStatsToggleUI(next); if(next){ try{ renderTrainingStats(); }catch(e){} } }

		// --- Email validation ---
		function isValidEmail(email){
			// Simple, user-friendly email regex (no overvalidation):
			// - Some chars before @, a domain with at least one dot, 2+ TLD chars
			return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(String(email||'').trim());
		}
		function updateEmailFieldState(){
			var input = document.getElementById('checkoutEmail');
			var assist = document.getElementById('checkoutEmailAssist');
			if(!input) return;
			var email = String(input.value||'').trim();
			if(!email){
				input.classList.remove('ring-2','ring-red-500');
				if(assist) assist.innerHTML = '';
				return;
			}

			// Domain guidance when user types '@'
			var atIndex = email.indexOf('@');
			if(atIndex !== -1){
				var local = email.slice(0, atIndex).trim();
				var domain = email.slice(atIndex+1).trim();
				var hints = [];
				var suggestions = [];
				if(domain.length === 0){
					hints.push('Add a domain after “@”, e.g., gmail.com');
					suggestions = ['gmail.com','yahoo.com','outlook.com','hotmail.com','live.com'];
				} else if(domain.indexOf('.') === -1){
					hints.push('Domains usually include a dot, e.g., gmail.com');
					suggestions = ['gmail.com','yahoo.com','outlook.com'];
				}
				if(assist){
					if(hints.length || suggestions.length){
						var html = '';
						if(hints.length){ html += '<div>'+hints.join(' ')+'</div>'; }
						if(suggestions.length){
							html += '<div class="mt-1 flex flex-wrap gap-1">' + suggestions.map(function(dom){
								return '<button type="button" class="px-2 py-0.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-700" data-email-domain="'+dom+'">'+dom+'</button>';
							}).join('') + '</div>';
						}
						assist.innerHTML = html;
						// Wire suggestion clicks
						var btns = assist.querySelectorAll('[data-email-domain]');
						for(var i=0;i<btns.length;i++){
							btns[i].addEventListener('click', function(){
								var dom = this.getAttribute('data-email-domain')||'';
								var l = local || '';
								var next = (l ? l : 'name') + '@' + dom;
								input.value = next;
								try{ input.focus(); }catch(e){}
								updateEmailFieldState();
							});
						}
					} else {
						assist.innerHTML = '';
					}
				}
			}
			if(isValidEmail(email)){
				input.classList.remove('ring-2','ring-red-500');
				input.classList.add('ring-2','ring-papsi-green');
				setTimeout(function(){ if(input){ input.classList.remove('ring-2','ring-papsi-green'); } }, 900);
			} else {
				input.classList.add('ring-2','ring-red-500');
			}
		}

		// --- Required fields validation (Middle Initial and Suffix are optional) ---
		function markFieldError(el){ try{ if(!el) return; el.classList.add('ring-2','ring-red-500'); el.setAttribute('aria-invalid','true'); }catch(e){} }
		function clearFieldError(el){ try{ if(!el) return; el.classList.remove('ring-2','ring-red-500'); el.removeAttribute('aria-invalid'); }catch(e){} }
		function focusAndToast(el, msg){ try{ if(el){ el.focus({preventScroll:false}); el.scrollIntoView({behavior:'smooth', block:'center'}); } }catch(e){} showToast(msg,'error',5000); }
		function validateCheckoutRequireds(){
			// Email
			var emailEl = document.getElementById('checkoutEmail');
			var emailVal = String((emailEl&&emailEl.value)||'').trim();
			if(!isValidEmail(emailVal)){
				updateEmailFieldState();
				focusAndToast(emailEl,'Please enter a valid email (e.g., name@example.com).');
				return false;
			}
			// Title (select or Other input)
			var titleSel = document.getElementById('checkoutTitleSelect');
			var titleOther = document.getElementById('checkoutTitleOther');
			var titleVal = String((titleSel&&titleSel.value)||'').trim();
			if(!titleVal){ markFieldError(titleSel); focusAndToast(titleSel,'Please select your title.'); return false; }
			if(/other/i.test(titleVal)){
				var tOtherVal = String((titleOther&&titleOther.value)||'').trim();
				if(!tOtherVal){ markFieldError(titleOther); focusAndToast(titleOther,'Please type your title.'); return false; }
			}
			// First Name
			var fnEl = document.getElementById('checkoutFirstname');
			if(!String((fnEl&&fnEl.value)||'').trim()){ markFieldError(fnEl); focusAndToast(fnEl,'Please enter your first name.'); return false; }
			// Last Name
			var lnEl = document.getElementById('checkoutLastname');
			if(!String((lnEl&&lnEl.value)||'').trim()){ markFieldError(lnEl); focusAndToast(lnEl,'Please enter your last name.'); return false; }
			// Mobile
			var mobEl = document.getElementById('checkoutMobile');
			if(!String((mobEl&&mobEl.value)||'').trim()){ markFieldError(mobEl); focusAndToast(mobEl,'Please enter your mobile number.'); return false; }
			// Specialization (select or Other)
			var specSel = document.getElementById('checkoutSpecializationSelect');
			var specOther = document.getElementById('checkoutSpecializationOther');
			var specVal = String((specSel&&specSel.value)||'').trim();
			if(!specVal){ markFieldError(specSel); focusAndToast(specSel,'Please select your specialization.'); return false; }
			if(/other/i.test(specVal)){
				var sOtherVal = String((specOther&&specOther.value)||'').trim();
				if(!sOtherVal){ markFieldError(specOther); focusAndToast(specOther,'Please type your specialization.'); return false; }
			}
			// School
			var schEl = document.getElementById('checkoutSchool');
			if(!String((schEl&&schEl.value)||'').trim()){ markFieldError(schEl); focusAndToast(schEl,'Please enter your school name.'); return false; }
			// Type (Private/Public)
			var typeEl = document.getElementById('checkoutType');
			if(!String((typeEl&&typeEl.value)||'').trim()){ markFieldError(typeEl); focusAndToast(typeEl,'Please select your school type.'); return false; }
			// Address
			var addrEl = document.getElementById('checkoutAddress');
			if(!String((addrEl&&addrEl.value)||'').trim()){ markFieldError(addrEl); focusAndToast(addrEl,'Please enter your school address.'); return false; }
			return true;
		}

		// Confirm Registration
		async function confirmRegistration(){
			try{
				if(!Array.isArray(cartCourses) || cartCourses.length===0){ showToast('Your cart is empty.','info',3000); return; }
				// Validation is performed before opening confirmation; proceed directly
				// Read details from Checkout Details modal
				var email = String((document.getElementById('checkoutEmail')||{}).value||'').trim();
				var titleSel = document.getElementById('checkoutTitleSelect');
				var titleOther = document.getElementById('checkoutTitleOther');
				var title = '';
				if(titleSel){ title = String(titleSel.value||'').trim(); }
				if(/other/i.test(title) && titleOther){ title = String(titleOther.value||'').trim(); }
				var firstname = String((document.getElementById('checkoutFirstname')||{}).value||'').trim();
				var middleinitial = String((document.getElementById('checkoutMiddleinitial')||{}).value||'').trim();
				var lastname = String((document.getElementById('checkoutLastname')||{}).value||'').trim();
				var suffix = String((document.getElementById('checkoutSuffix')||{}).value||'').trim();
				var mobileRaw = String((document.getElementById('checkoutMobile')||{}).value||'').trim();
				var specSel = document.getElementById('checkoutSpecializationSelect');
				var specOther = document.getElementById('checkoutSpecializationOther');
				var specialization = '';
				if(specSel){ specialization = String(specSel.value||'').trim(); }
				if(/other/i.test(specialization) && specOther){ specialization = String(specOther.value||'').trim(); }
				var school = String((document.getElementById('checkoutSchool')||{}).value||'').trim();
				var type = String((document.getElementById('checkoutType')||{}).value||'').trim();
				var address = String((document.getElementById('checkoutAddress')||{}).value||'').trim();
				// Normalize name parts to UPPERCASE before submission
				firstname = firstname.toUpperCase();
				middleinitial = middleinitial.toUpperCase();
				lastname = lastname.toUpperCase();

				// Build fullname without title; include middleinitial/suffix only if provided
				var fullname = [firstname, middleinitial, lastname, suffix]
					.filter(function(x){ return x && String(x).trim(); })
					.join(' ')
					.replace(/\s+/g,' ')
					.trim();
				if(!email){ showToast('Please enter your email.','error',4000); return; }
				// Build trainings
				var selected=[]; for(var i=0;i<cartCourses.length;i++){ var cid=cartCourses[i]; var c=findCourse(cid); if(c) selected.push(c); }
				var trainingtext = selected.map(function(c){return c.title;}).join(' | ');
				var trainingjson = selected.map(function(c){ return { title: c.title }; });
				var totals = computeCartTotals();
				var nametext = String(fullname||'').replace(/[\.\s]/g,'').toUpperCase();
				var payload = {
					timestamp: formatTimestampUS(new Date()),
					email: email,
					id: '',
					title: title,
					firstname: firstname,
					middleinitial: middleinitial,
					lastname: lastname,
					suffix: suffix,
					fullname: fullname,
					nametext: nametext,
					mobile: mobileRaw.replace(/[^0-9]/g,'') || '',
					specialization: specialization,
					school: school,
					type: type,
					address: address,
					subtotal: totals.regularSum,
					discount: totals.baseDiscount,
					vouchercode: (appliedVoucher && appliedVoucher.code) ? appliedVoucher.code : 'none',
					voucherdiscount: totals.voucherDiscount,
					total: totals.total,
					trainingtext: trainingtext,
					trainingjson: trainingjson
				};
				var btn = document.getElementById('submitCheckoutBtn'); var prevText = btn ? btn.textContent : '';
				setPending(btn, true, 'Submitting…');
				var url = AUTH_BASE + '?SH=Sheet1&func=cart';
				var res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'text/plain; charset=UTF-8' }, body: JSON.stringify(payload) });
				var text = await res.text();
				if(!res.ok){ showToast(text || 'Registration failed.','error',6000); setPending(btn,false, prevText||'Confirm Registration'); return; }
				var message = '';
				try{ var data=JSON.parse(text); if(data && (data.message||data.status||data.result)) message = data.message||data.status||data.result; else message=text; } catch(e){ message=text; }
				showToast((message||'Registration submitted.').trim(), 'success', 6000);
				try{ if(typeof message==='string' && /Recorded and email dispatched\./i.test(String(message).trim())){ openRegistrationSuccessModal(email); } }catch(e){}
				cartCourses = []; persistCart(); renderCourses(); updateCartCount(); appliedVoucher=null; closeCheckoutModal(); closeCart(); updateCartBar();
				setPending(btn,false, prevText||'Confirm Registration');
			} catch(err){ console.error('confirmRegistration error', err); showToast((err && err.message) || 'Network error. Please try again.','error',6000); var btn2=document.getElementById('submitCheckoutBtn'); setPending(btn2,false,'Submit'); }
		}

		function setPending(btn, pending, text){ if(!btn) return; if(pending){ btn.disabled=true; btn.textContent = text||'Working…'; btn.classList.add('opacity-70','cursor-not-allowed'); } else { btn.disabled=false; btn.textContent = text||btn.textContent; btn.classList.remove('opacity-70','cursor-not-allowed'); } }

		// Image viewer with controls
		var viewerImages = [];
		var viewerIndex = 0;
		var viewerScale = 1;
		var viewerRotation = 0;

		function collectGalleryImages(){
			// Collect unique srcs from currently rendered training images
			var nodes = Array.from(document.querySelectorAll('.training-image'));
			var items = [];
			nodes.forEach(function(node){
				var src = node && node.getAttribute('src');
				if(src && items.indexOf(src) === -1){ items.push(src); }
			});
			return items;
		}

		function applyViewerTransform(){
			var img = document.getElementById('viewerImage');
			if(!img) return;
			img.style.transformOrigin = 'center center';
			img.style.transform = 'scale(' + viewerScale + ') rotate(' + viewerRotation + 'deg)';
		}

		function resetViewerTransform(){ viewerScale = 1; viewerRotation = 0; applyViewerTransform(); }

		function showViewerImage(index){
			if(!viewerImages || !viewerImages.length){ viewerImages = collectGalleryImages(); }
			if(!viewerImages.length) return;
			if(index < 0) index = viewerImages.length - 1;
			if(index >= viewerImages.length) index = 0;
			viewerIndex = index;
			var img = document.getElementById('viewerImage');
			if(img){ img.src = viewerImages[viewerIndex]; }
			applyViewerTransform();
		}

		function openImageViewer(src, alt){
			var v = document.getElementById('imageViewer');
			var img = document.getElementById('viewerImage');
			if(!viewerImages || !viewerImages.length){ viewerImages = collectGalleryImages(); }
			var startIdx = viewerImages.indexOf(src);
			viewerIndex = startIdx >= 0 ? startIdx : 0;
			if(img){ img.alt = alt || 'Training Image'; }
			resetViewerTransform();
			showViewerImage(viewerIndex);
			if(v){ v.classList.add('open'); }
			document.body.style.overflow='hidden';
			updateCartBar();
		}
		function closeImageViewer(){ var v=document.getElementById('imageViewer'); if(v){ v.classList.remove('open'); } document.body.style.overflow='auto'; updateCartBar(); }
		function prevImage(){ showViewerImage(viewerIndex - 1); }
		function nextImage(){ showViewerImage(viewerIndex + 1); }
		function zoomIn(){ viewerScale = Math.min(viewerScale * 1.25, 10); applyViewerTransform(); }
		function zoomOut(){ viewerScale = Math.max(viewerScale / 1.25, 0.1); applyViewerTransform(); }
		function rotateImage(){ viewerRotation = (viewerRotation + 90) % 360; applyViewerTransform(); }

		// About
		window.aboutCourseId = null;
		function showAbout(courseId){ window.aboutCourseId = courseId; var modal=document.getElementById('aboutModal'); var title=document.getElementById('aboutTitle'); var content=document.getElementById('aboutContent'); var course=findCourse(courseId); if(!course) return; if(title) title.textContent = course.title; if(content){ content.innerHTML = '<div class="space-y-4">'+
			'<div><h4 class="font-semibold text-papsi-dark mb-2">Speaker</h4><p class="text-gray-600">'+escapeHtml(course.instructor||course.speaker||'')+'</p></div>'+
			'<div class="grid grid-cols-1 md:grid-cols-2 gap-4">'+
				'<div><h4 class="font-semibold text-papsi-dark mb-2">Duration</h4><p class="text-gray-600">'+escapeHtml(course.duration|| (course.hours? (course.hours+' hours') : ''))+'</p></div>'+
				'<div><h4 class="font-semibold text-papsi-dark mb-2">Price</h4><div class="flex items-center space-x-2">'+
					'<p class="text-papsi-gold font-bold text-lg">'+escapeHtml(course.price||'')+'</p>'+
					(course.originalPrice ? ('<span class="text-gray-400 line-through text-sm">'+escapeHtml(course.originalPrice)+'</span>') : '')+
					((course.originalPrice && course.originalPrice!==course.price) ? '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">Discount</span>' : '')+
				'</div></div></div>'+
			'<div><h4 class="font-semibold text-papsi-dark mb-2">About</h4><p class="text-gray-600">'+escapeHtml(course.description||course.about||'')+'</p></div></div>'; }
			if(modal){ modal.classList.add('open'); } document.body.style.overflow='hidden'; updateCartBar(); setTimeout(function(){ var btn=document.getElementById('aboutRegisterBtn'); if(btn){ var inCart = cartCourses.indexOf(courseId)!==-1; if(inCart){ btn.textContent='Added to Cart'; btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-papsi-green','hover:bg-green-700'); btn.disabled=true; } else { btn.textContent='Register Now'; btn.classList.remove('bg-gray-400','cursor-not-allowed'); btn.classList.add('bg-papsi-green','hover:bg-green-700'); btn.disabled=false; } } }, 0);
		}
		function closeAbout(){ var m=document.getElementById('aboutModal'); if(m){ m.classList.remove('open'); } document.body.style.overflow='auto'; updateCartBar(); }

		// Audio
		function playAudio(courseId){ var modal=document.getElementById('audioModal'); var title=document.getElementById('audioTitle'); var content=document.getElementById('audioContent'); var course=findCourse(courseId); if(!course) return; if(title) title.textContent = course.title + ' - Audio Preview'; if(content){ content.innerHTML=''; var p=document.createElement('p'); p.className='text-gray-600 text-sm'; p.textContent='Listen to a preview.'; content.appendChild(p); if(course.audio && /^https?:\/\//i.test(course.audio)){ var audio=document.createElement('audio'); audio.controls=true; audio.style.width='100%'; audio.style.marginTop='1rem'; audio.src=course.audio; audio.preload='none'; audio.addEventListener('error', function(){ var err=document.createElement('div'); err.className='text-red-500 mt-2'; err.textContent='Failed to load audio preview.'; if(audio && audio.parentNode){ audio.parentNode.replaceChild(err, audio); } }); content.appendChild(audio); } else { var d=document.createElement('div'); d.className='text-gray-500 mt-2'; d.textContent='No audio preview available.'; content.appendChild(d); } }
			if(modal){ modal.classList.add('open'); } document.body.style.overflow='hidden'; updateCartBar(); }
		function closeAudio(){ var m=document.getElementById('audioModal'); if(m){ m.classList.remove('open'); } document.body.style.overflow='auto'; updateCartBar(); }

		// Checkout modal helpers
		function openCheckoutModal(){ var m=document.getElementById('checkoutModal'); if(m){ m.classList.add('open'); }
			// Ensure conditional fields are in correct state
			try{ handleTitleChange(); }catch(e){}
			try{ handleSpecializationChange(); }catch(e){}
		}
		function closeCheckoutModal(){ var m=document.getElementById('checkoutModal'); if(m){ m.classList.remove('open'); } }

		// Final submit confirmation modal helpers
		function openSubmitConfirm(){
			closeCheckoutModal();
			var m = document.getElementById('submitConfirmModal'); if(m){ m.classList.add('open'); }
			document.body.style.overflow='hidden';
			setTimeout(function(){ try { document.getElementById('submitConfirmYes').focus(); } catch(e){} }, 0);
		}
		function closeSubmitConfirm(){ var m=document.getElementById('submitConfirmModal'); if(m){ m.classList.remove('open'); } document.body.style.overflow='auto'; }
		function proceedFinalSubmit(){ closeSubmitConfirm(); confirmRegistration(); }
		function cancelFinalSubmit(){ closeSubmitConfirm(); openCheckoutModal(); }

		function handleTitleChange(){
			try{
				var sel=document.getElementById('checkoutTitleSelect');
				var cont=document.getElementById('checkoutTitleOtherContainer');
				if(!sel||!cont) return;
				if(/other/i.test(String(sel.value||''))){
					cont.classList.remove('hidden');
					var inp=document.getElementById('checkoutTitleOther'); if(inp) inp.focus();
				} else {
					cont.classList.add('hidden');
				}
				clearFieldError(sel);
			}catch(e){}
		}

		function handleSpecializationChange(){
			try{
				var sel=document.getElementById('checkoutSpecializationSelect');
				var cont=document.getElementById('checkoutSpecializationOtherContainer');
				if(!sel||!cont) return;
				if(/other/i.test(String(sel.value||''))){
					cont.classList.remove('hidden');
					var inp=document.getElementById('checkoutSpecializationOther'); if(inp) inp.focus();
				} else {
					cont.classList.add('hidden');
				}
				clearFieldError(sel);
			}catch(e){}
		}

		// Submit button handler: validate first, then show confirmation
		function handleCheckoutSubmit(){
			// Ensure the checkout modal is visible during validation so errors are clear
			openCheckoutModal();
			if(!validateCheckoutRequireds()){
				// Validation already shows toasts/highlights; don't proceed
				return;
			}
			// All good: open final confirmation
			openSubmitConfirm();
		}

		// Success modal helpers
		function openRegistrationSuccessModal(email){ try{ var overlay=document.getElementById('registrationSuccessOverlay'); var subtitle=document.getElementById('regSuccessSubtitle'); var span=null; if(subtitle){ var s=subtitle.getElementsByTagName('span'); if(s && s.length) span=s[0]; } if(span) span.textContent = String(email||'').trim(); if(overlay) overlay.classList.remove('hidden'); document.body.style.overflow='hidden'; setTimeout(function(){ var ok=document.getElementById('regSuccessOk'); if(ok) try{ ok.focus(); }catch(e){} },0); }catch(e){} }
		function closeRegistrationSuccessModal(){ try{ var overlay=document.getElementById('registrationSuccessOverlay'); if(overlay) overlay.classList.add('hidden'); document.body.style.overflow=''; }catch(e){} }

		// Esc helpers and viewer keyboard shortcuts
		document.addEventListener('keydown', function(e){
			var iv = document.getElementById('imageViewer');
			var viewerOpen = iv && iv.classList.contains('open');
			if(e && e.key === 'Escape'){
				var ov=document.getElementById('registrationSuccessOverlay'); if(ov && !ov.classList.contains('hidden')){ return void closeRegistrationSuccessModal(); }
				var cm=document.getElementById('cartModal'); if(cm && cm.classList.contains('open')){ return void closeCart(); }
				var ab=document.getElementById('aboutModal'); if(ab && ab.classList.contains('open')){ return void closeAbout(); }
				var au=document.getElementById('audioModal'); if(au && au.classList.contains('open')){ return void closeAudio(); }
				var co=document.getElementById('checkoutModal'); if(co && co.classList.contains('open')){ return void closeCheckoutModal(); }
				var sc=document.getElementById('submitConfirmModal'); if(sc && sc.classList.contains('open')){ return void closeSubmitConfirm(); }
				if(viewerOpen){ return void closeImageViewer(); }
			}
			if(!viewerOpen) return;
			if(e.key === 'ArrowLeft'){ e.preventDefault(); return void prevImage(); }
			if(e.key === 'ArrowRight'){ e.preventDefault(); return void nextImage(); }
			if(e.key === '+' || e.key === '='){ e.preventDefault(); return void zoomIn(); }
			if(e.key === '-' || e.key === '_'){ e.preventDefault(); return void zoomOut(); }
			if((e.key||'').toLowerCase() === 'r'){ e.preventDefault(); return void rotateImage(); }
		});
		document.getElementById('regSuccessCloseX').addEventListener('click', closeRegistrationSuccessModal);
		document.getElementById('regSuccessClose').addEventListener('click', closeRegistrationSuccessModal);
		document.getElementById('regSuccessOk').addEventListener('click', closeRegistrationSuccessModal);
		document.getElementById('registrationSuccessOverlay').addEventListener('click', function(e){ if(e.target===this) closeRegistrationSuccessModal(); });
		// Close confirmation when clicking overlay
		document.getElementById('submitConfirmModal').addEventListener('click', function(e){ if(e.target===this) cancelFinalSubmit(); });

		// Simple escape/attr helpers
		function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
		function escapeAttr(str){ return escapeHtml(str); }

		// Init
		document.addEventListener('DOMContentLoaded', function(){
			// Promo banner logic
			(function(){
				var BANNER_KEY = 'PAPSI_PROMO_DISMISSED_UNTIL';
				var CODE = 'PAPSIPROMO';
				var now = Date.now();
				var dismissedUntil = 0;
				try { dismissedUntil = parseInt(localStorage.getItem(BANNER_KEY)||'0', 10) || 0; } catch(e){}
				var banner = document.getElementById('promoBanner');
				var spacer = document.getElementById('promoSpacer');
				function showBanner(){ if(banner){ banner.classList.remove('hidden'); } if(spacer){ spacer.className='h-14'; } }
				function hideBanner(){ if(banner){ banner.classList.add('hidden'); } if(spacer){ spacer.className='h-0'; } }
				if(now > dismissedUntil){ showBanner(); } else { hideBanner(); }
				// Copy button
				var copyBtn = document.getElementById('promoCopyBtn');
				if(copyBtn){ copyBtn.addEventListener('click', function(){
					try {
						navigator.clipboard.writeText(CODE).then(function(){ showToast('Copied code: '+CODE, 'success', 2500); }).catch(function(){
							// Fallback
							var ta = document.createElement('textarea'); ta.value = CODE; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showToast('Copied code: '+CODE, 'success', 2500); }catch(err){ showToast('Promo code: '+CODE, 'info', 3000); } finally { document.body.removeChild(ta); }
						});
					} catch(err){ showToast('Promo code: '+CODE, 'info', 3000); }
				}); }
				// Apply button
				var applyBtn = document.getElementById('promoApplyBtn');
				if(applyBtn){ applyBtn.addEventListener('click', function(){
					// Open cart, prefill voucher input, and validate
					openCart();
					setTimeout(function(){
						var input = document.getElementById('voucherInput');
						if(input){ input.value = CODE; }
						try { validateVoucher(); } catch(e) {}
					}, 50);
				}); }
				// Dismiss button
				var dismissBtn = document.getElementById('promoDismissBtn');
				if(dismissBtn){ dismissBtn.addEventListener('click', function(){
					var until = Date.now() + 24*60*60*1000; // 24 hours
					try { localStorage.setItem(BANNER_KEY, String(until)); } catch(e){}
					hideBanner();
				}); }
			})();

			// Toggle drawer on mobile/desktop
			var tBtn = document.getElementById('trainingFiltersMobileBtn'); if(tBtn){ tBtn.addEventListener('click', function(){ var w = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; if(w>=768){ var drawer=document.getElementById('trainingFiltersDrawer'); if(drawer){ try{ drawer.scrollIntoView({behavior:'smooth', block:'start'});}catch(e){} } } else { toggleDrawer(); } }); }
			// Stats toggle
			var statsBtn = document.getElementById('trainingStatsToggle'); if(statsBtn){ statsBtn.addEventListener('click', toggleTrainingStats); }
			updateStatsToggleUI(getSavedStatsVisible());
			document.getElementById('clearSearch').addEventListener('click', clearSearch);
			var clearAllBtn = document.getElementById('trainingClearFilters'); if(clearAllBtn){ clearAllBtn.addEventListener('click', clearAllTrainingFilters); }
			document.getElementById('searchInput').addEventListener('input', function(e){ var btn=document.getElementById('clearSearch'); if(e && e.target && e.target.value){ btn.classList.remove('hidden'); } else { btn.classList.add('hidden'); } filterCourses(); });
			document.getElementById('categoryFilter').addEventListener('change', filterCourses);
			document.getElementById('speakerFilter').addEventListener('change', filterCourses);
			document.getElementById('dateSort').addEventListener('change', filterCourses);
			// Email guidance on input
			try{ var em=document.getElementById('checkoutEmail'); if(em){ em.addEventListener('input', function(){ updateEmailFieldState(); clearFieldError(em); }); } }catch(e){}
			// Clear error mark on required fields as user edits
			['checkoutFirstname','checkoutLastname','checkoutMobile','checkoutSchool','checkoutType','checkoutAddress','checkoutTitleOther','checkoutSpecializationOther'].forEach(function(id){
				var el=document.getElementById(id);
				if(el){ el.addEventListener('input', function(){ clearFieldError(el); }); }
			});
			try{ var tsel=document.getElementById('checkoutTitleSelect'); if(tsel){ tsel.addEventListener('change', function(){ clearFieldError(tsel); }); } }catch(e){}
			try{ var ssel=document.getElementById('checkoutSpecializationSelect'); if(ssel){ ssel.addEventListener('change', function(){ clearFieldError(ssel); }); } }catch(e){}

			loadCart();
			loadTrainingCourses();
		});
	</script>
</body>
</html>
