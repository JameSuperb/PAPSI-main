<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPSI Membership Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    // --- DYNAMIC ANNOUNCEMENTS ---
    async function loadAnnouncements() {
    const url = "https://script.google.com/macros/s/AKfycbz8awvt1aQpxA-7vfyp7WJRQLODyHdhVlaMfn7KsRnGIBaLaeQ_7ZYED4qI4kL0CpmXsw/exec?SH=announcement&func=announcement";
        const container = document.getElementById('announcementsContainer');
        container.innerHTML = '<div class="text-center text-gray-500 py-8">Loading announcements...</div>';
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No announcements found.</div>';
                return;
            }
            container.innerHTML = data.map(item => {
                const postedAgo = timeAgo(item.dateposted);
                return `
                <div class="bg-gray-50 rounded-lg shadow p-4 flex flex-col items-stretch">
                    <div class="w-full mb-4">
                        <img src="${item.photo}" alt="${item.title}" class="w-full h-auto max-h-[400px] object-contain rounded-md border border-gray-200" style="display:block;margin:0 auto;">
                    </div>
                    <div class="flex-1 flex flex-col">
                        <h4 class="text-lg font-bold text-papsi-dark mb-1">${item.title}</h4>
                        <p class="text-gray-700 mb-2">${item.subtitle}</p>
                        <div class="flex items-center text-xs text-gray-500 mb-2">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Posted ${postedAgo}
                        </div>
                        <a href="${item.link}" target="_blank" rel="noopener" class="inline-block bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700 transition-colors self-start">See more</a>
                    </div>
                </div>
                `;
            }).join('');
        } catch (e) {
            container.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load announcements.</div>';
        }
    }

    // Helper: format posted-ago
    function timeAgo(dateString) {
        const now = new Date();
        const posted = new Date(dateString);
        const diffMs = now - posted;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        if (diffDays < 1) {
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            if (diffHours < 1) {
                const diffMins = Math.floor(diffMs / (1000 * 60));
                return diffMins <= 1 ? 'just now' : `${diffMins} minutes ago`;
            }
            return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
        } else if (diffDays < 7) {
            return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return weeks === 1 ? '1 week ago' : `${weeks} weeks ago`;
        } else if (diffDays < 365) {
            const months = Math.floor(diffDays / 30);
            return months === 1 ? '1 month ago' : `${months} months ago`;
        } else {
            const years = Math.floor(diffDays / 365);
            return years === 1 ? '1 year ago' : `${years} years ago`;
        }
    }
    // --- END DYNAMIC ANNOUNCEMENTS ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'papsi-green': '#166938',
                        'papsi-red': '#dc2626',
                        'papsi-gold': '#f59e0b',
                        'papsi-dark': '#1f2937'
                    }
                }
            }
        }
    </script>
    <style>
        .active-tab {
            color: #166938;
            border-bottom: 2px solid #166938;
        }
        /* Year bar animation + styling */
        .animate-width { animation: barGrow .9s cubic-bezier(.65,.05,.36,1) forwards; transform-origin: left; }
        @keyframes barGrow { from { transform:scaleX(0); } to { transform:scaleX(1); } }
        .year-bar-item { transition: background .25s, box-shadow .25s; }
        .year-bar-item:hover { background:#f5f9f6; }
        .card-hover {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-container {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            cursor: grab;
        }
        .image-container:active {
            cursor: grabbing;
        }
        .viewer-image {
            max-width: 100%;
            max-height: 100%;
            transition: transform 0.2s ease;
            user-select: none;
        }
        .viewer-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        .viewer-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .viewer-btn:hover {
            background: white;
        }
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        .training-image {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .training-image:hover {
            opacity: 0.8;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Remove overlay padding for perfect centering */
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2.5rem 2rem;
            box-sizing: border-box;
        }
        .audio-player {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .play-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #166938;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .play-btn:hover {
            background: #0f5429;
        }
        .audio-progress {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }
        .audio-progress-bar {
            height: 100%;
            background: #166938;
            width: 0%;
            transition: width 0.1s;
        }
        /* Video player modal styles */
        .video-modal-content { max-width: 36rem; }
        .video-size-normal { max-width: 36rem; }
        .video-size-large { max-width: 64rem; }
        .video-size-full  { width: 100%; max-width: 100%; height: 100vh; border-radius: 0; }
        .vp-aspect { position: relative; padding-top: 56.25%; }
        .vp-aspect > * { position: absolute; inset: 0; width: 100%; height: 100%; }

        /* Slides (PDF) modal styles */
        .slides-modal-content { max-width: 64rem; }
        .slides-size-normal { max-width: 64rem; }
        .slides-size-large  { max-width: 96rem; }
        .slides-size-full   { width: 100%; max-width: 100%; height: 100vh; border-radius: 0; }
        .sp-body { height: 80vh; }
        .sp-frame { width: 100%; height: 100%; border: 0; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <style>
    /* Inline enhancement: refresh button spin + hover micro-interaction */
    @keyframes refresh-spin { to { transform: rotate(360deg); } }
    .refresh-icon.spin { animation: refresh-spin .8s linear infinite; }
    .refresh-btn:hover .refresh-icon:not(.spin) { animation: refresh-spin .6s linear; }
    .refresh-btn:focus-visible { outline: 2px solid #166534; outline-offset: 2px; }
    /* Module modal styles */
    .module-modal-content { max-width: 80rem; }
    .mm-body { height: 80vh; }
    .mm-frame { width:100%; height:100%; border:0; background:#fff; }
    .modules-toggle-active { background:#166534; color:#fff; }
    </style>
    <style>
    /* Mobile Filter Drawer (progressive enhancement) */
    @media (max-width: 767px) {
        .filters-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1490; opacity:0; pointer-events:none; transition:opacity .25s ease; }
        .filters-overlay.visible { opacity:1; pointer-events:auto; }
        .filters-drawer { position:fixed; top:0; left:0; bottom:0; width:290px; max-width:85%; background:#fff; z-index:1500; box-shadow:0 10px 30px -5px rgba(0,0,0,.25); display:flex; flex-direction:column; transform:translateX(-100%); transition:transform .30s ease; }
        .filters-drawer.open { transform:translateX(0); }
        .filters-drawer-header { padding:0.85rem 1rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; }
        .filters-drawer-body { padding:1rem; overflow-y:auto; -webkit-overflow-scrolling:touch; }
        .filters-drawer-close-btn { padding:.5rem; border-radius:.375rem; }
        body.filters-lock { overflow:hidden; touch-action:none; }
        /* Hide original inline cards when converted to drawer */
        .filters-inline-hidden { display:none !important; }
    }
    @media (min-width: 768px) {
        /* Desktop: reset drawer elements so content displays inline normally */
        .filters-overlay { display:none !important; }
        .filters-drawer { position:static; width:auto; max-width:none; height:auto; transform:none !important; box-shadow:none; background:transparent; }
        .filters-drawer-header { display:none; }
        .filters-drawer-body { padding:0; overflow:visible; }
        .filters-mobile-trigger { display:none !important; }
    }
    </style>
    <!-- Auth Overlay (Phase 1: UI only; hidden until wired) -->
    <div id="authOverlay" class="fixed inset-0 bg-white/95 backdrop-blur-sm z-[2000] overflow-auto hidden">
        <div class="min-h-screen flex items-center justify-center p-6">
            <div class="w-full max-w-md">
                <!-- Validate Page -->
                <section id="auth-validate" class="bg-white rounded-lg shadow p-6 space-y-5">
                    <div class="flex flex-col items-center text-center space-y-3">
                        <img src="https://papsitrainingcenter.weebly.com/uploads/2/5/9/7/25977880/papsilogo_1.png" alt="PAPSI" class="h-14 w-auto">
                        <h2 class="text-xl font-bold text-papsi-dark">Validation Process</h2>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">Email Address</label>
                        <input id="authValidateEmail" type="email" placeholder="Enter your email address here" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" aria-describedby="authValidateStatus">
                    </div>
                    <div id="authValidateStatus" class="text-sm" role="status" aria-live="polite"></div>
                        <!-- Subtle Renew CTA (hidden by default) -->
                        <div id="authValidateRenewCta" class="hidden mt-2">
                            <a href="membership.html" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-papsi-green/60 focus:ring-offset-1 transition">Please renew your membership</a>
                        </div>
                    <button id="authValidateBtn" class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">Validate</button>
                </section>

                <!-- Registration Page (hidden by default) -->
                <section id="auth-register" class="bg-white rounded-lg shadow p-6 space-y-5 hidden mt-6">
                    <div class="flex flex-col items-center text-center space-y-3">
                        <img src="https://papsitrainingcenter.weebly.com/uploads/2/5/9/7/25977880/papsilogo_1.png" alt="PAPSI" class="h-14 w-auto">
                        <h2 class="text-xl font-bold text-papsi-dark">Registration</h2>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">Email Address</label>
                        <input id="authRegisterEmail" type="email" placeholder="Enter your email address here" class="w-full border rounded px-3 py-2 bg-gray-100" readonly aria-describedby="authRegisterStatus">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">PAPSI ID</label>
                        <input id="authRegisterId" type="text" placeholder="Enter your PAPSI ID here" class="w-full border rounded px-3 py-2" aria-describedby="authRegisterStatus">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">Password (min 8 characters)</label>
                        <input id="authRegisterPassword" type="password" placeholder="Enter your password here" class="w-full border rounded px-3 py-2" aria-describedby="authRegisterStatus">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">Confirm Password</label>
                        <input id="authRegisterConfirm" type="password" placeholder="Reenter your password here" class="w-full border rounded px-3 py-2" aria-describedby="authRegisterStatus">
                    </div>
                    <div id="authRegisterStatus" class="text-sm" role="status" aria-live="polite"></div>
                    <div class="flex gap-2">
                        <button id="authRegisterBtn" class="flex-1 bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">Register</button>
                        <button id="authRegisterBackBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400 transition-colors">Back</button>
                    </div>
                </section>

                <!-- Login Page (hidden by default) -->
                <section id="auth-login" class="bg-white rounded-lg shadow p-6 space-y-5 hidden mt-6">
                    <div class="flex flex-col items-center text-center space-y-3">
                        <img src="https://papsitrainingcenter.weebly.com/uploads/2/5/9/7/25977880/papsilogo_1.png" alt="PAPSI" class="h-14 w-auto">
                        <h2 class="text-xl font-bold text-papsi-dark">Login</h2>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">Email Address</label>
                        <input id="authLoginEmail" type="email" placeholder="Enter your email address here" class="w-full border rounded px-3 py-2" aria-describedby="authLoginStatus">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-papsi-dark mb-1">Password (min 8 characters)</label>
                        <input id="authLoginPassword" type="password" placeholder="Enter your password here" class="w-full border rounded px-3 py-2" aria-describedby="authLoginStatus">
                    </div>
                    <div id="authLoginStatus" class="text-sm" role="status" aria-live="polite"></div>
                    <!-- Forgot Password helper (shown only on incorrect password) -->
                    <div id="forgotPasswordRow" class="mt-1 hidden">
                        <button id="forgotPasswordBtn" type="button" class="text-sm text-papsi-green hover:text-green-700 underline">
                            Forgot Password? Receive it by Email
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button id="authLoginBtn" class="flex-1 bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">Login</button>
                        <button id="authLoginBackBtn" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400 transition-colors">Back</button>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <!-- Forgot Password Confirmation Modal -->
    <div id="forgotPasswordModal" class="modal hidden z-[2100]">
        <div class="modal-content max-w-md mx-auto p-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold text-papsi-dark">Confirmation</h3>
                <button onclick="closeForgotPasswordConfirm()" class="text-gray-400 hover:text-gray-600" aria-label="Close">
                    <svg class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
            </div>
            <p class="text-gray-700 mb-4">Do you want to receive your password by your email address?</p>
            <div id="forgotPwEmailLine" class="text-sm text-gray-600 -mt-2 mb-4">We will send to: <span id="forgotPwEmailText" class="font-medium text-papsi-dark break-all"></span></div>
            <div class="flex gap-2 justify-end">
                <button id="forgotPwYesBtn" type="button" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700 transition-colors" onclick="sendPasswordEmail()">Yes</button>
                <button type="button" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors" onclick="closeForgotPasswordConfirm()">Cancel</button>
            </div>
        </div>
    </div>
    <script>
    // ===== Auth Overlay Navigation (Phase 2) =====
    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || '').trim());
    }
    function showAuthPage(which) {
        const panes = ['validate', 'register', 'login'];
        panes.forEach(p => {
            const el = document.getElementById('auth-' + p);
            if (el) el.classList.toggle('hidden', p !== which);
        });
        // Phase 7: clear statuses when switching panes
        try { clearAuthStatuses(); } catch {}
        // Focus first input of the shown pane
        setTimeout(() => {
            const shown = document.getElementById('auth-' + which);
            if (!shown) return;
            const input = shown.querySelector('input');
            if (input) { try { input.focus(); } catch (e) {} }
        }, 0);
    }
    // Wire Back buttons to return to Validate
    document.addEventListener('DOMContentLoaded', function() {
        var regBack = document.getElementById('authRegisterBackBtn');
        if (regBack) regBack.addEventListener('click', function(){ showAuthPage('validate'); });
        var loginBack = document.getElementById('authLoginBackBtn');
        if (loginBack) loginBack.addEventListener('click', function(){ showAuthPage('validate'); });
        // Optional UX: Escape returns to Validate when on Register or Login
        document.addEventListener('keydown', function(e){
            if (e.key === 'Escape') {
                const overlay = document.getElementById('authOverlay');
                if (!overlay || overlay.classList.contains('hidden')) return;
                const onRegister = !document.getElementById('auth-register')?.classList.contains('hidden');
                const onLogin = !document.getElementById('auth-login')?.classList.contains('hidden');
                if (onRegister || onLogin) {
                    e.preventDefault();
                    showAuthPage('validate');
                }
            }
        });
    });
    // ===== End Phase 2 =====
    </script>
    <script>
    // ===== Auth Validate Handler (Phase 3) =====
    const AUTH_BASE = 'https://script.google.com/macros/s/AKfycbydRAAaO83lKJpCpu7a48YlncAX9R5N1KvRx5LqMofd6Dd-O1S_Mnp9tGysVGFV7q6dZQ/exec';
    const AUTH_SH = 'Sheet1';

    function buildAuthUrl(func, query = {}) {
        const params = new URLSearchParams({ SH: AUTH_SH, func });
        Object.entries(query).forEach(([k, v]) => {
            if (v !== undefined && v !== null) params.append(k, String(v));
        });
        return `${AUTH_BASE}?${params.toString()}`;
    }

    async function handleAuthValidate() {
        const emailInput = document.getElementById('authValidateEmail');
        const statusEl = document.getElementById('authValidateStatus');
        const btn = document.getElementById('authValidateBtn');
        const renewCta = document.getElementById('authValidateRenewCta');
        const email = String(emailInput?.value || '').trim();

    // Reset status
    setAuthStatus(statusEl, '');
    if (renewCta) renewCta.classList.add('hidden');

        if (!isValidEmail(email)) {
            setAuthStatus(statusEl, 'Please enter a valid email address.', 'error');
            emailInput?.focus();
            return;
        }

        // Minimal UX lock (full polish in Phase 7)
    const prevText = btn?.textContent;
    setPending(btn, true, 'Validating…');
    setAuthStatus(statusEl, 'Validating, please wait…', 'info');

        try {
            const url = buildAuthUrl('validate', { email });
            const res = await fetch(url, { method: 'GET' });
            const text = await res.text();

            // Try JSON first (in case backend returns structured error/info)
            try {
                const data = JSON.parse(text);
                // Renew signal in structured response
                const jmsg = (data?.message || data?.status || data?.result || '').toString();
                if (/renew/i.test(jmsg)) {
                    setAuthStatus(statusEl, '');
                    if (renewCta) renewCta.classList.remove('hidden');
                    return;
                }
                // If backend responds with a redirect hint in JSON (optional)
                const next = (data?.next || data?.action || '').toString().toLowerCase();
                if (next === 'register' || next === 'login') {
                    routeAfterValidation(next, email);
                    return;
                }
                // Otherwise show message or fallback to text parsing
                if (data?.message) { setAuthStatus(statusEl, String(data.message), 'error'); return; }
            } catch (_) {
                // Not JSON; proceed to plain-text handling
            }

            const normalized = text.trim().toLowerCase();
            if (/renew/i.test(normalized)) {
                setAuthStatus(statusEl, '');
                if (renewCta) renewCta.classList.remove('hidden');
                return;
            }
            if (normalized === 'register' || normalized === 'login') {
                routeAfterValidation(normalized, email);
                return;
            }

            // Unexpected response
            setAuthStatus(statusEl, text || 'Unexpected response. Please try again later.', 'error');
        } catch (err) {
            setAuthStatus(statusEl, err?.message || 'Unable to validate right now.', 'error');
        } finally {
            setPending(btn, false, prevText || 'Validate');
        }
    }

    function routeAfterValidation(next, email) {
        if (next === 'register') {
            const regEmail = document.getElementById('authRegisterEmail');
            if (regEmail) regEmail.value = email;
            showAuthPage('register');
        } else {
            const loginEmail = document.getElementById('authLoginEmail');
            if (loginEmail) loginEmail.value = email;
            showAuthPage('login');
        }
    }

    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Deterministic category color mapping
    const CATEGORY_PALETTE = [
        { badge: 'bg-emerald-100 text-emerald-800', stats: 'text-emerald-600' },
        { badge: 'bg-blue-100 text-blue-800', stats: 'text-blue-600' },
        { badge: 'bg-purple-100 text-purple-800', stats: 'text-purple-600' },
        { badge: 'bg-orange-100 text-orange-800', stats: 'text-orange-600' },
        { badge: 'bg-rose-100 text-rose-800', stats: 'text-rose-600' },
        { badge: 'bg-sky-100 text-sky-800', stats: 'text-sky-600' },
        { badge: 'bg-teal-100 text-teal-800', stats: 'text-teal-600' },
        { badge: 'bg-amber-100 text-amber-800', stats: 'text-amber-600' },
        { badge: 'bg-indigo-100 text-indigo-800', stats: 'text-indigo-600' },
        { badge: 'bg-lime-100 text-lime-800', stats: 'text-lime-600' },
        { badge: 'bg-fuchsia-100 text-fuchsia-800', stats: 'text-fuchsia-600' },
        { badge: 'bg-cyan-100 text-cyan-800', stats: 'text-cyan-600' },
        { badge: 'bg-violet-100 text-violet-800', stats: 'text-violet-600' },
        { badge: 'bg-pink-100 text-pink-800', stats: 'text-pink-600' },
        { badge: 'bg-slate-100 text-slate-800', stats: 'text-slate-600' },
        { badge: 'bg-stone-100 text-stone-800', stats: 'text-stone-600' }
    ];

    function hashStringToInt(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) {
            h = (h << 5) - h + str.charCodeAt(i);
            h |= 0; // Convert to 32bit integer
        }
        return Math.abs(h);
    }

    function getCategoryPalette(category) {
        const key = (category || 'Other').toString().trim().toLowerCase();
        const idx = hashStringToInt(key) % CATEGORY_PALETTE.length;
        return CATEGORY_PALETTE[idx];
    }

    function categoryBadgeClasses(category) {
        return getCategoryPalette(category).badge;
    }

    function categoryStatsText(category) {
        return getCategoryPalette(category).stats;
    }

    // Normalize server profile keys to UI expectations
    function normalizeServerProfile(p){
        if (!p || typeof p !== 'object') return p;
        const out = { ...p };
        // publication -> publications
        if (out.publication && !out.publications) out.publications = out.publication;
        // attended -> Attended (optional, for My Learning rendering)
        if (out.attended && !out.Attended) out.Attended = out.attended;
        // Optional category normalization
        if (Array.isArray(out.Attended)) {
            out.Attended = out.Attended.map(item => {
                const copy = { ...item };
                if (copy.category === 'I.C.T.') copy.category = 'ICT';
                return copy;
            });
        }
        // Normalize membership validity fields to consistent keys
        if (out.Date && !out.date) out.date = out.Date;
        if (out.Validity && !out.validity) out.validity = out.Validity;
        if (out.Expiry && !out.expiry) out.expiry = out.Expiry;
        if (out.Expiration && !out.expiration) out.expiration = out.Expiration;
        // If primary date missing, coalesce from any available
        if (!out.date) out.date = out.validity || out.expiry || out.expiration || out.Date || out.Validity || out.Expiry || out.Expiration || out.date;
        return out;
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('authValidateBtn')?.addEventListener('click', handleAuthValidate);
        // Optional: Enter key submits on Validate page
        const vInput = document.getElementById('authValidateEmail');
        if (vInput) {
            vInput.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); handleAuthValidate(); } });
            vInput.addEventListener('input', function(){ try { document.getElementById('authValidateRenewCta')?.classList.add('hidden'); } catch {} });
        }
    });
    // ===== End Phase 3 =====
    </script>
    <script>
    // ===== Auth Registration Handler (Phase 4) =====
    async function handleAuthRegister() {
        const emailEl = document.getElementById('authRegisterEmail');
        const idEl = document.getElementById('authRegisterId');
        const passEl = document.getElementById('authRegisterPassword');
        const confirmEl = document.getElementById('authRegisterConfirm');
        const statusEl = document.getElementById('authRegisterStatus');
        const btn = document.getElementById('authRegisterBtn');

        const email = String(emailEl?.value || '').trim();
        const idVal = String(idEl?.value || '').trim();
        const password = String(passEl?.value || '');
        const confirm = String(confirmEl?.value || '');

    setAuthStatus(statusEl, '');

        // Basic client validations
        if (!isValidEmail(email)) {
            setAuthStatus(statusEl, 'Please provide a valid email.', 'error');
            emailEl?.focus();
            return;
        }
        if (!idVal) {
            setAuthStatus(statusEl, 'Please enter your PAPSI ID.', 'error');
            idEl?.focus();
            return;
        }
        if (!password || password.length < 8) {
            setAuthStatus(statusEl, 'Password must be at least 8 characters.', 'error');
            passEl?.focus();
            return;
        }
        if (password !== confirm) {
            setAuthStatus(statusEl, 'Passwords do not match.', 'error');
            confirmEl?.focus();
            return;
        }

        // Minimal UX lock
    const prevText = btn?.textContent;
    setPending(btn, true, 'Registering…');
    setAuthStatus(statusEl, 'Submitting, please wait…', 'info');

        try {
            const url = buildAuthUrl('register', { email, id: idVal, password });
            const res = await fetch(url, { method: 'GET' });
            const text = await res.text();

            // Try JSON first
            try {
                const data = JSON.parse(text);
                const rawProfile = data?.profile || data || null;
                // Heuristic: server may return a profile object without success/status flags
                const looksLikeProfile = rawProfile && typeof rawProfile === 'object' && (
                    rawProfile.email || rawProfile.id || rawProfile.firstname || rawProfile.lastname || Array.isArray(rawProfile.attended)
                );
                const flaggedSuccess = data?.success === true || String(data?.status || '').toLowerCase() === 'ok' || /success/i.test(String(data?.message || ''));
                if (looksLikeProfile) {
                    // Immediate login path on registration success with profile payload
                    const profile = normalizeServerProfile(rawProfile);
                    try { localStorage.setItem('PAPSI_PROFILE', JSON.stringify(profile)); } catch {}
                    try { window.PAPSI_PROFILE = profile; } catch {}
                    try { if (typeof setProfile === 'function') setProfile(profile); } catch {}
                    const overlay = document.getElementById('authOverlay');
                    if (overlay) overlay.classList.add('hidden');
                    // Clear sensitive fields
                    try { document.getElementById('authRegisterPassword').value = ''; } catch {}
                    try { document.getElementById('authRegisterConfirm').value = ''; } catch {}
                    setAuthStatus(statusEl, '');
                    // Reveal logout button
                    try { document.getElementById('logoutBtn')?.classList.remove('hidden'); } catch {}
                    return;
                }
                if (flaggedSuccess) {
                    // No profile payload, keep existing UX: go to Login with success message
                    afterRegisterSuccess(email, statusEl);
                    return;
                }
                // JSON but not ok and not a profile
                const msg = data?.message || 'Registration failed.';
                setAuthStatus(statusEl, String(msg), 'error');
                return;
            } catch (_) {
                // Plain text handling
                const normalized = text.trim().toLowerCase();
                if (['ok', 'success', 'registered', 'login'].includes(normalized)) {
                    afterRegisterSuccess(email, statusEl);
                    return;
                }
                setAuthStatus(statusEl, text || 'Registration failed.', 'error');
                return;
            }
        } catch (err) {
            setAuthStatus(statusEl, err?.message || 'Unable to register right now.', 'error');
        } finally {
            setPending(btn, false, prevText || 'Register');
        }
    }

    function afterRegisterSuccess(email, regStatusEl) {
        // Clear sensitive fields
        const passEl = document.getElementById('authRegisterPassword');
        const confirmEl = document.getElementById('authRegisterConfirm');
        if (passEl) passEl.value = '';
        if (confirmEl) confirmEl.value = '';

        // Route to login and show success message there
        const loginEmail = document.getElementById('authLoginEmail');
        const loginStatus = document.getElementById('authLoginStatus');
        if (loginEmail) loginEmail.value = email;
        if (loginStatus) setAuthStatus(loginStatus, 'Registration successful. Please log in.', 'success');
        showAuthPage('login');
        if (regStatusEl) setAuthStatus(regStatusEl, '');
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('authRegisterBtn')?.addEventListener('click', handleAuthRegister);
        const confirmEl = document.getElementById('authRegisterConfirm');
        if (confirmEl) confirmEl.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); handleAuthRegister(); } });
    });
    // ===== End Phase 4 =====
    </script>
    <script>
    // ===== Auth Login Handler (Phase 5) =====
    async function handleAuthLogin() {
        const emailEl = document.getElementById('authLoginEmail');
        const passEl = document.getElementById('authLoginPassword');
        const statusEl = document.getElementById('authLoginStatus');
        const btn = document.getElementById('authLoginBtn');
        const forgotRow = document.getElementById('forgotPasswordRow');

        const email = String(emailEl?.value || '').trim();
        const password = String(passEl?.value || '');

        setAuthStatus(statusEl, '');
        if (forgotRow) forgotRow.classList.add('hidden');

        if (!isValidEmail(email)) {
            setAuthStatus(statusEl, 'Please enter a valid email.', 'error');
            emailEl?.focus();
            return;
        }
        if (!password || password.length < 8) {
            setAuthStatus(statusEl, 'Password must be at least 8 characters.', 'error');
            passEl?.focus();
            return;
        }

        // Minimal UX lock
        const prevText = btn?.textContent;
        setPending(btn, true, 'Logging in…');
        setAuthStatus(statusEl, 'Checking your credentials…', 'info');

        try {
            const url = buildAuthUrl('login', { email, password });
            const res = await fetch(url, { method: 'GET' });
            const text = await res.text();

            // Try JSON first
            try {
                const data = JSON.parse(text);
                const profile = normalizeServerProfile(data?.profile || data || null);
                if (profile && typeof profile === 'object') {
                    // Block expired membership before granting access
                    if (!isMembershipActive(profile)) {
                        setAuthStatus(statusEl, '');
                        gateExpiredMembership(profile);
                        return;
                    }
                    try { localStorage.setItem('PAPSI_PROFILE', JSON.stringify(profile)); } catch {}
                    try { window.PAPSI_PROFILE = profile; } catch {}
                    try { if (typeof setProfile === 'function') setProfile(profile); } catch {}
                    const overlay = document.getElementById('authOverlay');
                    if (overlay) overlay.classList.add('hidden');
                    if (passEl) passEl.value = '';
                    setAuthStatus(statusEl, '');
                    if (forgotRow) forgotRow.classList.add('hidden');
                    return;
                }
                const msg = (data?.message || data?.status || data?.result || '').toString();
                if (/renew/i.test(msg)) { renderRenewStatus(statusEl, msg || 'Please renew your membership.'); return; }
                if (/incorrect password/i.test(msg)) {
                    setAuthStatus(statusEl, 'Incorrect password.', 'error');
                    if (forgotRow) forgotRow.classList.remove('hidden');
                    return;
                }
                setAuthStatus(statusEl, msg || 'Login failed. Please try again.', 'error');
                return;
            } catch (_) {
                // Plain text handling
                const norm = (text || '').trim();
                if (/renew/i.test(norm)) { renderRenewStatus(statusEl, norm || 'Please renew your membership.'); return; }
                if (/incorrect password/i.test(norm)) {
                    setAuthStatus(statusEl, 'Incorrect password.', 'error');
                    if (forgotRow) forgotRow.classList.remove('hidden');
                    return;
                }
                setAuthStatus(statusEl, norm || 'Invalid credentials.', 'error');
                return;
            }
        } catch (err) {
            setAuthStatus(statusEl, err?.message || 'Unable to login right now.', 'error');
        } finally {
            setPending(btn, false, prevText || 'Login');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('authLoginBtn')?.addEventListener('click', handleAuthLogin);
        const passEl = document.getElementById('authLoginPassword');
        if (passEl) passEl.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); handleAuthLogin(); } });
    });
    // ===== End Phase 5 =====
    </script>
    <script>
    // ===== Forgot Password Flow =====
    document.addEventListener('DOMContentLoaded', function() {
        const fpBtn = document.getElementById('forgotPasswordBtn');
        if (fpBtn) fpBtn.addEventListener('click', openForgotPasswordConfirm);
        // Hide forgot row when editing inputs
        ['authLoginEmail','authLoginPassword'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', () => {
                const row = document.getElementById('forgotPasswordRow');
                if (row) row.classList.add('hidden');
            });
        });
    });

    function openForgotPasswordConfirm() {
        const email = String(document.getElementById('authLoginEmail')?.value || '').trim();
        if (!isValidEmail(email)) {
            try { showToast('Please enter a valid email first.', 'error'); } catch { alert('Please enter a valid email first.'); }
            return;
        }
        const modal = document.getElementById('forgotPasswordModal');
        if (!modal) return;
        // Populate the email line for reassurance
        try {
            const line = document.getElementById('forgotPwEmailText');
            if (line) line.textContent = email;
        } catch {}
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        // Close on overlay click
        function onOverlay(e){ if (e.target === modal) { closeForgotPasswordConfirm(); modal.removeEventListener('click', onOverlay); } }
        modal.addEventListener('click', onOverlay);
    }

    function closeForgotPasswordConfirm() {
        const modal = document.getElementById('forgotPasswordModal');
        if (modal) modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Esc to close
    document.addEventListener('keydown', function(e){
        const modal = document.getElementById('forgotPasswordModal');
        if (modal && !modal.classList.contains('hidden') && e.key === 'Escape') closeForgotPasswordConfirm();
    });

    async function sendPasswordEmail() {
        const email = String(document.getElementById('authLoginEmail')?.value || '').trim();
        if (!isValidEmail(email)) {
            try { showToast('Please enter a valid email first.', 'error'); } catch { alert('Please enter a valid email first.'); }
            return;
        }
        const yesBtn = document.getElementById('forgotPwYesBtn');
        const prev = yesBtn?.textContent;
        setPending(yesBtn, true, 'Sending…');
        try {
            const url = buildAuthUrl('password', { email });
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'text/plain; charset=UTF-8' } });
            const text = await res.text();
            try { showToast(text || 'Password will be sent if the email exists.', res.ok ? 'success' : 'error', 5000); } catch {}
            closeForgotPasswordConfirm();
            const row = document.getElementById('forgotPasswordRow');
            if (row) row.classList.add('hidden');
        } catch (err) {
            try { showToast(err?.message || 'Unable to send password right now.', 'error'); } catch {}
        } finally {
            setPending(yesBtn, false, prev || 'Yes');
        }
    }
    // ===== End Forgot Password Flow =====
    </script>
    <script>
    // ===== Header Refresh (re-fetch profile via login endpoint) =====
    async function handleRefreshProfile(options = {}) {
        const silent = !!options.silent;
        const btn = document.getElementById('refreshBtn');
        let saved = null;
        try { saved = JSON.parse(localStorage.getItem('PAPSI_PROFILE') || 'null'); } catch {}
        const email = saved?.email ? String(saved.email).trim() : '';
        const password = saved?.password ? String(saved.password) : '';

        if (!email || !isValidEmail(email) || !password || password.length < 8) {
            // If silent, skip; if manual, route to Login
            if (!silent) {
                const overlay = document.getElementById('authOverlay');
                if (overlay) overlay.classList.remove('hidden');
                showAuthPage('login');
                const le = document.getElementById('authLoginEmail');
                if (le) le.value = email || '';
                try { showToast('Please log in to refresh your profile.', 'info'); } catch {}
            }
            return;
        }

        const prevText = btn?.textContent;
        if (!silent) setPending(btn, true, 'Refreshing…');
        try {
            const url = buildAuthUrl('login', { email, password });
            const res = await fetch(url, { method: 'GET' });
            const text = await res.text();
            // Handle plain-text Renew first
            const normText = (text || '').trim();
            if (/renew/i.test(normText)) {
                // Treat as expired membership and gate
                gateExpiredMembership(saved || { email });
                if (!silent) { try { showToast('Membership renewal required. Please renew to continue.', 'error'); } catch {} }
                return;
            }
            let profile = null;
            try {
                const data = JSON.parse(text);
                // If server sends a JSON message indicating Renew, gate
                const msg = (data?.message || data?.status || data?.result || '').toString();
                if (/renew/i.test(msg)) {
                    gateExpiredMembership(saved || { email });
                    if (!silent) { try { showToast('Membership renewal required. Please renew to continue.', 'error'); } catch {} }
                    return;
                }
                profile = normalizeServerProfile(data?.profile || data || null);
            } catch {
                throw new Error(text || 'Failed to refresh profile.');
            }
            if (!profile || typeof profile !== 'object') throw new Error('Invalid profile data.');
            // Gate expired memberships on refresh
            if (!isMembershipActive(profile)) {
                gateExpiredMembership(profile);
                if (!silent) { try { showToast('Membership has expired. Please renew to continue.', 'error'); } catch {} }
                return;
            }
            try { localStorage.setItem('PAPSI_PROFILE', JSON.stringify(profile)); } catch {}
            try { window.PAPSI_PROFILE = profile; } catch {}
            try { if (typeof setProfile === 'function') setProfile(profile); } catch {}
            // show logout if hidden
            try { document.getElementById('logoutBtn')?.classList.remove('hidden'); } catch {}
            if (!silent) { try { showToast('Profile refreshed.', 'success'); } catch {} }
        } catch (err) {
            if (!silent) { try { showToast(err?.message || 'Unable to refresh profile. Please log in again.', 'error'); } catch {} }
        } finally {
            if (!silent) setPending(btn, false, prevText || 'Refresh');
        }
    }

    document.addEventListener('DOMContentLoaded', function(){
        document.getElementById('refreshBtn')?.addEventListener('click', handleRefreshProfile);
    });
    // ===== End Header Refresh =====
    </script>
    <script>
    // ===== Toast Notifications =====
    function ensureToastContainer() {
        let c = document.getElementById('toastContainer');
        if (!c) {
            c = document.createElement('div');
            c.id = 'toastContainer';
            c.className = 'fixed top-4 right-4 z-[3000] space-y-2';
            document.body.appendChild(c);
        }
        return c;
    }
    function showToast(message, type = 'info', durationMs = 3000) {
        const container = ensureToastContainer();
        const colors = {
            success: 'bg-green-600',
            error: 'bg-red-600',
            info: 'bg-gray-800'
        };
        const color = colors[type] || colors.info;
        const toast = document.createElement('div');
        toast.setAttribute('role', 'alert');
        toast.className = `${color} text-white px-4 py-3 rounded shadow-lg flex items-center gap-2 transition ease-out duration-300 opacity-0 translate-y-2`;
        toast.innerHTML = `
            <span class="inline-block">${escapeHtml(String(message))}</span>
            <button aria-label="Close" class="ml-2 text-white/80 hover:text-white">&times;</button>
        `;
        const closeBtn = toast.querySelector('button');
        closeBtn.addEventListener('click', () => dismiss());
        container.appendChild(toast);
        // animate in
        requestAnimationFrame(() => {
            toast.classList.remove('opacity-0','translate-y-2');
            toast.classList.add('opacity-100','translate-y-0');
        });
        let hideTimer = setTimeout(dismiss, Math.max(1500, durationMs));
        function dismiss() {
            clearTimeout(hideTimer);
            toast.classList.remove('opacity-100','translate-y-0');
            toast.classList.add('opacity-0','translate-y-2');
            setTimeout(() => { toast.remove(); }, 200);
        }
    }
    // ===== End Toast Notifications =====
    </script>
    <script>
    // ===== Gate on Load (Phase 6) =====
    function showAuthOverlayAtValidate() {
        const overlay = document.getElementById('authOverlay');
        if (overlay) overlay.classList.remove('hidden');
        showAuthPage('validate');
        setTimeout(() => {
            const input = document.getElementById('authValidateEmail');
            if (input) { try { input.focus(); } catch {} }
        }, 0);
    }

    document.addEventListener('DOMContentLoaded', function() {
        try {
            const saved = localStorage.getItem('PAPSI_PROFILE');
            if (saved) {
                try {
                    const profile = JSON.parse(saved);
                    if (profile && typeof profile === 'object') {
                        // Gate expired memberships on restore
                        if (!isMembershipActive(profile)) {
                            gateExpiredMembership(profile);
                            return;
                        }
                        window.PAPSI_PROFILE = profile;
                        if (typeof setProfile === 'function') setProfile(profile);
                        const overlay = document.getElementById('authOverlay');
                        if (overlay) overlay.classList.add('hidden');
                        // Show logout button on successful session
                        try { document.getElementById('logoutBtn')?.classList.remove('hidden'); } catch {}
                        // Auto-refresh profile silently on load/reload
                        setTimeout(() => { try { handleRefreshProfile({ silent: true }); } catch {} }, 150);
                        return; // already gated in
                    }
                } catch { /* ignore parse error and fall through to show overlay */ }
            }
        } catch { /* localStorage inaccessible; show overlay */ }
        // No valid session found
        showAuthOverlayAtValidate();
        try { document.getElementById('logoutBtn')?.classList.add('hidden'); } catch {}
    });
    // ===== End Phase 6 =====
    </script>
    <script>
    // ===== Shared Auth UX Helpers (Phase 7) =====
    function setAuthStatus(el, message, type) {
        if (!el) return;
        el.classList.remove('text-red-600','text-green-700','text-gray-600');
        if (!message) { el.innerHTML = ''; return; }
        const color = type === 'error' ? 'text-red-600' : (type === 'success' ? 'text-green-700' : 'text-gray-600');
        el.classList.add(color);
        el.innerHTML = escapeHtml(String(message));
    }
    // Flexible date parser to handle ISO, US/EU numeric, and textual month formats
    // Returns a Date object on success, or null on failure.
    function parseFlexDate(input) {
        if (input instanceof Date && !isNaN(input)) return new Date(input.getTime());
        if (typeof input === 'number') {
            // Treat 10 or 13-digit numbers as epoch (seconds or ms)
            const s = String(input);
            const n = s.length === 10 ? Number(input) * 1000 : Number(input);
            const d = new Date(n);
            return isNaN(d) ? null : d;
        }
        const raw = String(input || '').trim();
        if (!raw) return null;
        // Quick native parse first (handles ISO and many common forms)
        const native = new Date(raw);
        if (!isNaN(native)) return native;

        // Normalize: remove commas and ordinal suffixes (1st -> 1)
        let s = raw.replace(/,/g, ' ').replace(/\b(\d{1,2})(st|nd|rd|th)\b/gi, '$1').replace(/\s+/g, ' ').trim();
        // Month names map
        const MON = {
            jan: 1, january: 1,
            feb: 2, february: 2,
            mar: 3, march: 3,
            apr: 4, april: 4,
            may: 5,
            jun: 6, june: 6,
            jul: 7, july: 7,
            aug: 8, august: 8,
            sep: 9, sept: 9, september: 9,
            oct: 10, october: 10,
            nov: 11, november: 11,
            dec: 12, december: 12
        };
        const toInt = (v) => { const n = Number(v); return Number.isFinite(n) ? n : NaN; };
        const twoDigitYear = (y) => {
            const yy = Number(y);
            if (!Number.isFinite(yy)) return NaN;
            if (yy < 70) return 2000 + yy; // 00-69 => 2000-2069
            if (yy < 100) return 1900 + yy; // 70-99 => 1970-1999
            return yy;
        };
        const makeDate = (y, m, d) => {
            const dt = new Date(y, m - 1, d);
            return (dt.getFullYear() === y && dt.getMonth() === m - 1 && dt.getDate() === d) ? dt : null;
        };
        const lastDay = (y, m) => new Date(y, m, 0).getDate(); // m is 1-based

        // 1) YYYY-MM-DD (or / .) possibly with time ignored
        {
            const m = s.match(/^(\d{4})[\/.\-](\d{1,2})[\/.\-](\d{1,2})(?:\b|\s|T).*$/);
            if (m) {
                const y = toInt(m[1]); const mo = toInt(m[2]); const da = toInt(m[3]);
                const dt = makeDate(y, mo, da);
                if (dt) return dt;
            }
        }
        // 2) DD-MM-YYYY or MM-DD-YYYY (ambiguous). Prefer MM-DD-YYYY by default.
        {
            const m = s.match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})$/);
            if (m) {
                const a = toInt(m[1]), b = toInt(m[2]);
                let y = toInt(m[3]); y = y < 100 ? twoDigitYear(y) : y;
                // Heuristics
                if (a > 12 && b <= 12) { // D-M-Y
                    const dt = makeDate(y, b, a);
                    if (dt) return dt;
                } else if (b > 12 && a <= 12) { // M-D-Y
                    const dt = makeDate(y, a, b);
                    if (dt) return dt;
                } else {
                    // Ambiguous: try M/D/Y then D/M/Y
                    let dt = makeDate(y, a, b);
                    if (dt) return dt;
                    dt = makeDate(y, b, a);
                    if (dt) return dt;
                }
            }
        }
        // 3) Month name formats
        {
            // D Mon YYYY
            let m = s.match(/^(\d{1,2})\s+([A-Za-z]+)\s+(\d{2,4})$/);
            if (m) {
                const da = toInt(m[1]);
                const mo = MON[m[2].toLowerCase()];
                let y = toInt(m[3]); y = y < 100 ? twoDigitYear(y) : y;
                if (mo) {
                    const dt = makeDate(y, mo, da);
                    if (dt) return dt;
                }
            }
            // Mon D YYYY
            m = s.match(/^([A-Za-z]+)\s+(\d{1,2})\s+(\d{2,4})$/);
            if (m) {
                const mo = MON[m[1].toLowerCase()];
                const da = toInt(m[2]);
                let y = toInt(m[3]); y = y < 100 ? twoDigitYear(y) : y;
                if (mo) {
                    const dt = makeDate(y, mo, da);
                    if (dt) return dt;
                }
            }
            // Mon YYYY (assume last day of the month)
            m = s.match(/^([A-Za-z]+)\s+(\d{4})$/);
            if (m) {
                const mo = MON[m[1].toLowerCase()];
                const y = toInt(m[2]);
                if (mo) {
                    const da = lastDay(y, mo);
                    const dt = makeDate(y, mo, da);
                    if (dt) return dt;
                }
            }
        }
        // 4) MM/YYYY or YYYY/MM (assume last day of month)
        {
            let m = s.match(/^(\d{1,2})[\/.\-](\d{4})$/);
            if (m) {
                const mo = toInt(m[1]); const y = toInt(m[2]);
                const da = lastDay(y, mo);
                const dt = makeDate(y, mo, da);
                if (dt) return dt;
            }
            m = s.match(/^(\d{4})[\/.\-](\d{1,2})$/);
            if (m) {
                const y = toInt(m[1]); const mo = toInt(m[2]);
                const da = lastDay(y, mo);
                const dt = makeDate(y, mo, da);
                if (dt) return dt;
            }
        }
        // 5) Fallback failed
        return null;
    }
    // Render a subtle CTA for membership renewal
    function renderRenewStatus(el, message) {
        if (!el) return;
        const safeMsg = escapeHtml(String(message || 'Your membership requires renewal.'));
        el.classList.remove('text-red-600','text-green-700','text-gray-600');
        el.innerHTML = `
            <div class="text-red-600 font-medium">${safeMsg}</div>
            <div class="mt-2">
                <a href="membership.html" class="inline-flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-papsi-green/60 focus:ring-offset-1 transition">Please renew your membership</a>
            </div>
        `;
    }
    function setPending(btn, isPending, text) {
        if (!btn) return;
        const inlineSpin = btn.hasAttribute('data-inline-spin');
        if (isPending) {
            if (inlineSpin) {
                const icon = btn.querySelector('.refresh-icon');
                if (icon) icon.classList.add('spin');
                // Store original label once, then set pending label (if provided)
                const span = btn.querySelector('span');
                if (span) {
                    if (!btn.dataset.prevText) btn.dataset.prevText = span.textContent || '';
                    if (text) span.textContent = text;
                }
                btn.disabled = true;
                btn.classList.add('opacity-70','cursor-not-allowed');
            } else {
                if (!btn.dataset.prevHtml) btn.dataset.prevHtml = btn.innerHTML;
                const label = text || btn.textContent || '';
                btn.innerHTML = `<span class=\"inline-block w-4 h-4 mr-2 border-2 border-current border-t-transparent rounded-full animate-spin align-[-2px]\"></span>${escapeHtml(label)}`;
                btn.disabled = true;
                btn.classList.add('opacity-70','cursor-not-allowed');
            }
        } else {
            if (inlineSpin) {
                const icon = btn.querySelector('.refresh-icon');
                if (icon) icon.classList.remove('spin');
                // Restore original label if previously stored; otherwise use provided fallback
                const span = btn.querySelector('span');
                const restore = btn.dataset.prevText || text || '';
                if (span && restore) span.textContent = restore;
                if (btn.dataset.prevText) delete btn.dataset.prevText;
                btn.disabled = false;
                btn.classList.remove('opacity-70','cursor-not-allowed');
            } else {
                if (btn.dataset.prevHtml) {
                    btn.innerHTML = btn.dataset.prevHtml;
                    delete btn.dataset.prevHtml;
                } else {
                    btn.textContent = text || btn.textContent || '';
                }
                btn.disabled = false;
                btn.classList.remove('opacity-70','cursor-not-allowed');
            }
        }
    }
    function clearAuthStatuses() {
        ['authValidateStatus','authRegisterStatus','authLoginStatus'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });
    }
    // ===== Membership Expiry Helpers (NEW) =====
    function getMembershipExpiry(profile) {
        if (!profile || typeof profile !== 'object') return null;
        const keys = ['date', 'validity', 'expiry', 'expiration'];
        for (const k of keys) {
            const v = profile[k];
            if (v) {
                const d = parseFlexDate(v);
                if (d && !isNaN(d)) {
                    // inclusive until end-of-day
                    d.setHours(23,59,59,999);
                    return d;
                }
            }
        }
        return null;
    }
    function isMembershipActive(profile) {
        const exp = getMembershipExpiry(profile);
        if (!exp) return true; // no date provided, assume active
        return new Date() <= exp;
    }
    function gateExpiredMembership(profile) {
        // Drop any stored session
        try { localStorage.removeItem('PAPSI_PROFILE'); } catch {}
        try { window.PAPSI_PROFILE = null; } catch {}
        try { if (typeof setProfile === 'function') setProfile(null); } catch {}

        // Show overlay at Validate (no email prefill)
        const overlay = document.getElementById('authOverlay');
        if (overlay) overlay.classList.remove('hidden');
        showAuthPage('validate');

        // Inject renewal guidance and relogin button
        const vStatus = document.getElementById('authValidateStatus');
        if (vStatus) {
            vStatus.classList.remove('text-red-600','text-green-700','text-gray-600');
            vStatus.innerHTML = `
                <div class="text-red-600 font-medium">Your PAPSI membership has expired.</div>
                <div class="mt-1 text-gray-700">Please renew your membership to continue.</div>
                <div class="mt-2">
                    <a href="membership.html" class="text-papsi-green underline hover:text-green-700">Renew now at membership.html</a>
                </div>
                <div class="mt-2 text-xs text-gray-600">Tip: Please complete the renewal first before re‑logging in.</div>
                <div class="mt-3">
                    <button id="expiredReloginBtn" type="button" class="px-3 py-1.5 rounded bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm">Re‑login</button>
                </div>
            `;
            setTimeout(() => {
                document.getElementById('expiredReloginBtn')?.addEventListener('click', () => {
                    showAuthPage('login');
                });
            }, 0);
        }

        // Hide logout (no active session)
        try { document.getElementById('logoutBtn')?.classList.add('hidden'); } catch {}
    }
    // ===== End Membership Expiry Helpers =====
    // Clear inline errors when user edits inputs
    document.addEventListener('DOMContentLoaded', function() {
        const pairs = [
            ['authValidateEmail','authValidateStatus'],
            ['authRegisterEmail','authRegisterStatus'],
            ['authRegisterId','authRegisterStatus'],
            ['authRegisterPassword','authRegisterStatus'],
            ['authRegisterConfirm','authRegisterStatus'],
            ['authLoginEmail','authLoginStatus'],
            ['authLoginPassword','authLoginStatus']
        ];
        pairs.forEach(([inputId, statusId]) => {
            const input = document.getElementById(inputId);
            const status = document.getElementById(statusId);
            if (input && status) input.addEventListener('input', () => setAuthStatus(status, ''));
        });
        // Phase 8: Logout handling
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) logoutBtn.addEventListener('click', function(){
            try { localStorage.removeItem('PAPSI_PROFILE'); } catch {}
            try { window.PAPSI_PROFILE = null; } catch {}
            try { if (typeof setProfile === 'function') setProfile(null); } catch {}
            // Clear My Learning state and UI
            try { myLearning = []; filteredLearningCourses = []; learningCurrentPage = 1; } catch {}
            try { renderLearningCourses(); updateLearningCounters(); renderLearningStats(); } catch {}
            const overlay = document.getElementById('authOverlay');
            if (overlay) overlay.classList.remove('hidden');
            showAuthPage('validate');
            setTimeout(() => {
                const input = document.getElementById('authValidateEmail');
                if (input) { try { input.focus(); } catch {} }
            }, 0);
            logoutBtn.classList.add('hidden');
        });
    });
    // ===== End Phase 7 =====
    </script>
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <img src="https://papsitrainingcenter.weebly.com/uploads/2/5/9/7/25977880/papsilogo_1.png" 
                         alt="PAPSI Logo" 
                         class="h-10 w-auto"
                         onerror="this.src=''; this.alt='PAPSI Logo'; this.style.display='none';">
                    <h1 class="text-xl font-bold text-papsi-dark">Member Portal</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="w-8 h-8 bg-papsi-green rounded-full flex items-center justify-center">
                        <span id="headerInitials" class="text-white text-sm font-medium">MM</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Home Page -->
        <div id="home-page" class="page-content">
            <!-- Welcome Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center space-x-4 mb-4">
                    <div class="w-16 h-16 bg-papsi-green rounded-full flex items-center justify-center">
                        <span id="homeWelcomeInitials" class="text-white text-xl font-medium">MM</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-papsi-dark leading-snug">
                            Welcome<br>
                            <span id="homeWelcomeName" class="block">Member</span>
                        </h2>
                        <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium mt-2">
                            Active Member
                        </span>
                    </div>
                </div>
                <!-- Option B Integration: Inline About & Privacy buttons inside the Welcome card -->
                <div class="flex flex-wrap items-center gap-2 pt-3 mt-1 border-t border-gray-100">
                    <button type="button" onclick="openInfoModal('aboutInfoModal')" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-papsi-dark focus:outline-none focus:ring-2 focus:ring-papsi-green/60 focus:ring-offset-1 transition">
                        <svg class="w-4 h-4 text-papsi-green" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-9.5a.75.75 0 111.5 0v5a.75.75 0 01-1.5 0v-5zM10 7a.875.875 0 100-1.75A.875.875 0 0010 7z" clip-rule="evenodd"/></svg>
                        <span>About PAPSI</span>
                    </button>
                    <button type="button" onclick="openInfoModal('privacyInfoModal')" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium bg-gray-50 text-gray-600 hover:bg-gray-100 hover:text-papsi-dark focus:outline-none focus:ring-2 focus:ring-papsi-green/60 focus:ring-offset-1 transition">
                        <svg class="w-4 h-4 text-papsi-green" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a6 6 0 016 6v1.086a2 2 0 01.586 1.414l-.007.178c-.1 1.897-.698 3.495-1.89 4.947-1.135 1.382-2.63 2.405-4.57 3.162a1.99 1.99 0 01-1.438 0c-1.94-.757-3.435-1.78-4.57-3.162-1.192-1.452-1.79-3.05-1.89-4.947L2 10.5A2 2 0 012.586 9.086V8a6 6 0 016-6z"/><path fill="#fff" d="M10 7a2 2 0 00-2 2v2.25a2 2 0 001.106 1.79l.788.394.788-.395A2 2 0 0012 11.25V9a2 2 0 00-2-2z"/></svg>
                        <span>Privacy Policy</span>
                    </button>
                </div>
            </div>

                        
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-xl font-bold text-papsi-dark mb-4">📢 PAPSI Announcements</h3>
                <div id="announcementsContainer" class="space-y-6">
                    <!-- Announcements will be dynamically populated here -->
                </div>
            </div>
        </div>

        <!-- My Learning Page -->
        <div id="learning-page" class="page-content hidden">
            <!-- Learning Header + Toolbar -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="relative overflow-hidden">
                    <h2 class="text-2xl font-bold text-papsi-dark mb-2">My Learning</h2>
                    <!-- Transient success banner (shown after registration) -->
                    <div id="learningSuccessBanner" class="hidden mb-3 rounded-md border border-green-200 bg-green-50 px-3 py-2 flex items-start gap-2" role="status" aria-live="polite">
                        <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a1 1 0 00-1.414-1.414L9 10.414 7.557 8.97a1 1 0 10-1.414 1.415l2.121 2.12a1 1 0 001.414 0l4.179-4.314z" clip-rule="evenodd"/></svg>
                        <div id="learningSuccessBannerText" class="text-sm text-green-800">Registration submitted successfully.</div>
                    </div>
                    <!-- Segmented toolbar: Filters + Show/Hide Stats + Clear -->
                    <div class="flex items-center gap-2 mb-2">
                        <div class="inline-flex rounded-md overflow-hidden border bg-white/70">
                            <button id="learningFiltersMobileBtn" type="button" class="filters-mobile-trigger inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium bg-white hover:bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-papsi-green rounded-none border-r" aria-expanded="false" aria-controls="learningFiltersDrawer">
                                <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M3 4.5A1.5 1.5 0 014.5 3h11A1.5 1.5 0 0117 4.5v.382a1.5 1.5 0 01-.44 1.06l-4.56 4.56v4.248a1 1 0 01-1.37.93l-2-.75A1 1 0 017 13.996v-3.494L2.44 5.942A1.5 1.5 0 012 4.882V4.5z"/>
                                </svg>
                                <span>Filters</span>
                                <span id="learningFiltersActiveCount" class="hidden text-[10px] bg-gray-100 text-gray-600 px-1 rounded">0</span>
                            </button>
                            <button id="learningStatsToggle" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 font-medium bg-white hover:bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-papsi-green rounded-none" aria-controls="learningStatsSection" aria-expanded="false" type="button">
                                <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M4 12a1 1 0 011-1h1a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM9 9a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V9zM14 6a1 1 0 011-1h1a1 1 0 011 1v9a1 1 0 01-1 1h-1a1 1 0 01-1-1V6z"/>
                                </svg>
                                <span>Show Stats</span>
                            </button>
                        </div>
                        <button id="learningClearFilters" type="button" class="hidden text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-papsi-green">Clear</button>
                    </div>
                    <!-- Active filter chips -->
                    <div id="learningFilterChips" class="flex flex-wrap items-center gap-2 mb-4 hidden"></div>

                    <!-- Stats section (collapsible) -->
                    <div id="learningStatsSection" class="hidden">
                        <div id="learningStatsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>
                        <div id="learningYearBars" class="space-y-2 mb-2"></div>
                    </div>
                </div>
            </div>
            <!-- Search and Filter Controls (Learning) -->
            <div id="learningFiltersDrawer" class="filters-drawer md:bg-white md:rounded-lg md:shadow-sm md:p-4 mb-6" role="dialog" aria-modal="true" aria-labelledby="learningFiltersHeading">
                <div class="filters-drawer-header md:hidden">
                    <h3 id="learningFiltersHeading" class="font-semibold text-papsi-dark text-sm">My Learning Filters</h3>
                    <button type="button" class="filters-drawer-close-btn text-gray-500 hover:text-gray-700 hover:bg-gray-100" aria-label="Close filters" onclick="closeFiltersDrawer('learning')">
                        <svg class="w-5 h-5" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14L14 6"/></svg>
                    </button>
                </div>
                <div class="filters-drawer-body md:p-0">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <!-- Search Bar -->
                    <div class="flex-1 relative">
                        <input type="text" id="learningSearchInput" placeholder="Search your courses, speakers, or topics..." 
                               class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <button id="clearLearningSearch" class="absolute right-3 top-2.5 w-5 h-5 text-gray-400 hover:text-gray-600 hidden">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Category Filter -->
                    <select id="learningCategoryFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <option value="all">All Categories</option>
                        <option value="Biology">Biology</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="ICT">ICT</option>
                    </select>
                    
                    <!-- Speaker Filter -->
                    <select id="learningSpeakerFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <option value="all">All Speakers</option>
                        <option value="Dr. Chona Camille Abeledo">Dr. Chona Camille Abeledo</option>
                        <option value="Dr. James Salveo Olarve">Dr. James Salveo Olarve</option>
                        <option value="Dr. David Penaloza Jr">Dr. David Penaloza Jr</option>
                    </select>
                    
                    <!-- Date Sort -->
                    <select id="learningDateSort" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
                
                    <!-- Results Counter -->
                    <div class="mt-4 text-sm text-gray-600">
                        <div id="learningResultsCounter" class="font-medium">
                            Showing 6 of 6 courses
                        </div>
                    </div>
                </div><!-- /drawer body -->
            </div>
            

            <div id="learningCoursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- My learning courses will be dynamically populated here -->
            </div>
            
            <!-- Video Player Modal -->
            <div id="videoPlayerModal" class="modal hidden z-50">
                <div id="videoModalContent" class="modal-content video-modal-content video-size-normal mx-auto p-0 flex flex-col">
                    <!-- Header: Title + Close -->
                    <div class="flex items-start justify-between px-4 py-3 border-b bg-white rounded-t-lg">
                        <h3 id="videoPlayerTitle" class="text-lg font-bold text-papsi-dark flex-1 min-w-0 whitespace-normal break-words pr-6" title="Video Title">Video</h3>
                        <button onclick="closeVideoPlayer()" class="ml-2 text-gray-500 hover:text-gray-700" aria-label="Close video player" type="button">&times;</button>
                    </div>
                    <!-- Body: Video Area -->
                    <div class="bg-white">
                        <div class="vp-aspect bg-black overflow-hidden relative">
                            <div id="videoEmbedContainer"></div>
                            <div id="videoLoading" class="absolute inset-0 flex items-center justify-center">
                                <span class="inline-block w-10 h-10 border-4 border-white/70 border-t-transparent rounded-full animate-spin"></span>
                            </div>
                            <div id="videoFallback" class="hidden absolute inset-0 flex items-center justify-center p-4">
                                <div class="bg-white/95 rounded p-4 text-center max-w-md shadow">
                                    <div class="font-semibold text-papsi-dark mb-1">Unable to embed this video</div>
                                    <div class="text-sm text-gray-600 mb-3">The source may block embedding. You can open it in a new tab:</div>
                                    <a id="videoOpenExternal" target="_blank" rel="noopener" class="inline-block bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700">Open Video</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Footer: Size Controls -->
                    <div class="px-4 py-3 border-t bg-white flex items-center gap-2 rounded-b-lg">
                        <button id="vpSizeNormal" class="w-8 h-8 flex items-center justify-center rounded bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-papsi-green" type="button" title="Normal size" aria-label="Normal size">
                            <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><rect x="4" y="6" width="12" height="8" rx="1"/></svg>
                        </button>
                        <button id="vpSizeLarge" class="w-8 h-8 flex items-center justify-center rounded bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-papsi-green" type="button" title="Large size" aria-label="Large size">
                            <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" aria-hidden="true"><rect x="3.5" y="5.5" width="13" height="9" rx="1"/><path d="M6 5.5v-2M14 5.5v-2M6 17v-2M14 17v-2" stroke-linecap="round"/></svg>
                        </button>
                        <button id="vpSizeFull" class="w-8 h-8 flex items-center justify-center rounded bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-papsi-green" type="button" title="Full screen" aria-label="Full screen">
                            <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.7" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4h4M12 4h4v4M16 12v4h-4M8 16H4v-4"/></svg>
                        </button>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Slides (PDF) Modal -->
            <div id="slidesModal" class="modal hidden z-50">
                <div id="slidesModalContent" class="modal-content slides-modal-content slides-size-normal mx-auto p-0">
                    <div class="flex items-center justify-between px-4 py-3 border-b rounded-t-lg bg-white">
                        <h3 id="slidesTitle" class="text-lg font-bold text-papsi-dark">Slides</h3>
                        <button onclick="closeSlidesViewer()" class="ml-2 text-gray-500 hover:text-gray-700" aria-label="Close slides" type="button">&times;</button>
                    </div>
                    <div class="bg-white">
                        <div class="sp-body rounded-b-lg overflow-hidden relative">
                            <iframe id="slidesFrame" class="sp-frame" title="Slides"></iframe>
                            <div id="slidesLoading" class="absolute inset-0 flex items-center justify-center bg-white/60">
                                <span class="inline-block w-10 h-10 border-4 border-gray-300 border-t-transparent rounded-full animate-spin"></span>
                            </div>
                            <div id="slidesFallback" class="hidden absolute inset-0 flex items-center justify-center">
                                <div class="bg-white/95 rounded p-4 text-center max-w-md">
                                    <div class="font-semibold text-papsi-dark mb-1">Unable to embed this PDF</div>
                                    <div class="text-sm text-gray-600 mb-3">The source may block embedding. You can open it in a new tab:</div>
                                    <a id="slidesOpenExternal" target="_blank" rel="noopener" class="inline-block bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700">Open PDF</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modules (Drive Folder) Modal -->
            <div id="modulesModal" class="modal hidden z-50">
                <div id="modulesModalContent" class="modal-content module-modal-content mx-auto p-0">
                    <div class="px-4 py-3 border-b rounded-t-lg bg-white">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex rounded overflow-hidden border">
                                <button id="modulesViewList" type="button" class="px-2 py-1 text-xs flex items-center gap-1 hover:bg-gray-200" title="List view" aria-label="List view">
                                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 6h12M4 10h12M4 14h12" stroke-linecap="round"/></svg>
                                </button>
                                <button id="modulesViewGrid" type="button" class="px-2 py-1 text-xs flex items-center gap-1 hover:bg-gray-200" title="Grid view" aria-label="Grid view">
                                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="4" y="4" width="4" height="4" rx="1"/><rect x="12" y="4" width="4" height="4" rx="1"/><rect x="4" y="12" width="4" height="4" rx="1"/><rect x="12" y="12" width="4" height="4" rx="1"/></svg>
                                </button>
                            </div>
                            <button onclick="closeModulesViewer()" class="ml-2 text-gray-500 hover:text-gray-700" aria-label="Close modules" type="button">&times;</button>
                        </div>
                        <h3 id="modulesTitle" class="text-lg font-bold text-papsi-dark whitespace-normal break-words leading-snug">Modules</h3>
                    </div>
                    <div class="bg-white">
                        <div class="mm-body rounded-b-lg overflow-hidden relative">
                            <iframe id="modulesFrame" class="mm-frame" title="Modules Folder"></iframe>
                            <div id="modulesLoading" class="absolute inset-0 flex items-center justify-center bg-white/70">
                                <span class="inline-block w-10 h-10 border-4 border-gray-300 border-t-transparent rounded-full animate-spin"></span>
                            </div>
                            <div id="modulesFallback" class="hidden absolute inset-0 flex items-center justify-center p-4">
                                <div class="bg-white/95 rounded p-4 text-center max-w-md shadow">
                                    <div class="font-semibold text-papsi-dark mb-1">Unable to embed this folder</div>
                                    <div class="text-sm text-gray-600 mb-3">Open it in a new tab:</div>
                                    <a id="modulesOpenExternal" target="_blank" rel="noopener" class="inline-block bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700">Open Folder</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hub Page -->
        <div id="hub-page" class="page-content hidden">
            <!-- Title, toolbar, and stats inside one white container -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="relative overflow-hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-2xl font-bold text-papsi-dark">Center for Teacher Excellence</h2>
                    </div>
                    <!-- Segmented toolbar: Filters + Show/Hide Stats + Clear -->
                    <div class="flex items-center gap-2 mb-2">
                        <div class="inline-flex rounded-md overflow-hidden border bg-white/70">
                            <button id="trainingFiltersMobileBtn" type="button" class="filters-mobile-trigger inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium bg-white hover:bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-papsi-green rounded-none border-r" aria-expanded="false" aria-controls="trainingFiltersDrawer">
                                <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M3 4.5A1.5 1.5 0 014.5 3h11A1.5 1.5 0 0117 4.5v.382a1.5 1.5 0 01-.44 1.06l-4.56 4.56v4.248a1 1 0 01-1.37.93l-2-.75A1 1 0 017 13.996v-3.494L2.44 5.942A1.5 1.5 0 012 4.882V4.5z"/>
                                </svg>
                                <span>Filters</span>
                                <span id="trainingFiltersActiveCount" class="hidden text-[10px] bg-gray-100 text-gray-600 px-1 rounded">0</span>
                            </button>
                            <button id="trainingStatsToggle" class="inline-flex items-center gap-2 text-sm px-3 py-1.5 font-medium bg-white hover:bg-gray-50 text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-papsi-green rounded-none" aria-controls="trainingStatsSection" aria-expanded="false" type="button">
                                <svg class="w-4 h-4 text-gray-600" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M4 12a1 1 0 011-1h1a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM9 9a1 1 0 011-1h1a1 1 0 011 1v6a1 1 0 01-1 1h-1a1 1 0 01-1-1V9zM14 6a1 1 0 011-1h1a1 1 0 011 1v9a1 1 0 01-1 1h-1a1 1 0 01-1-1V6z"/>
                                </svg>
                                <span>Show Stats</span>
                            </button>
                        </div>
                        <button id="trainingClearFilters" type="button" class="hidden text-xs px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-papsi-green">Clear</button>
                    </div>
                    <!-- Active filter chips -->
                    <div id="trainingFilterChips" class="flex flex-wrap items-center gap-2 mb-4 hidden"></div>

                    <!-- Stats section (collapsible) -->
                    <div id="trainingStatsSection" class="hidden">
                        <div id="trainingStatsGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>
                        <div id="trainingYearBars" class="space-y-2 mb-2"></div>
                    </div>
                </div>
            </div>
            <!-- Search and Filter Controls (Training Center) -->
            <div id="trainingFiltersDrawer" class="filters-drawer md:bg-white md:rounded-lg md:shadow-sm md:p-4 mb-6" role="dialog" aria-modal="true" aria-labelledby="trainingFiltersHeading">
                <div class="filters-drawer-header md:hidden">
                    <h3 id="trainingFiltersHeading" class="font-semibold text-papsi-dark text-sm">Training Filters</h3>
                    <button type="button" class="filters-drawer-close-btn text-gray-500 hover:text-gray-700 hover:bg-gray-100" aria-label="Close filters" onclick="closeFiltersDrawer('training')">
                        <svg class="w-5 h-5" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14L14 6"/></svg>
                    </button>
                </div>
                <div class="filters-drawer-body md:p-0">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <!-- Search Bar -->
                    <div class="flex-1 relative">
                        <input type="text" id="searchInput" placeholder="Search courses, speakers, or topics..." 
                               class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                        </svg>
                        <button id="clearSearch" class="absolute right-3 top-2.5 w-5 h-5 text-gray-400 hover:text-gray-600 hidden">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Category Filter -->
                    <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <option value="all">All Categories</option>
                    </select>
                    
                    <!-- Speaker Filter -->
                    <select id="speakerFilter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <option value="all">All Speakers</option>
                    </select>
                    
                    <!-- Date Sort -->
                    <select id="dateSort" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
                
                    <!-- Results Counter -->
                    <div class="mt-4 text-sm text-gray-600">
                        <div id="resultsCounter" class="font-medium">
                            Showing 6 of 6 courses
                        </div>
                    </div>
                </div><!-- /drawer body -->
            </div>
            
            <div id="coursesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Training center courses will be dynamically populated here -->
                </div>
                <div id="coursesPagination" class="w-full flex justify-center mt-6 mb-2 md:mb-3"></div>
                <!-- Spacer to ensure content remains visible above fixed cart bar -->
                <div id="trainingBottomSpacer" class="h-0"></div>
                <!-- Cart Modal -->
                <div id="cartModal" class="modal hidden z-[1300]">
                    <div class="modal-content mx-auto">
                        <div class="flex justify-between items-center border-b pb-2 mb-4">
                            <h3 class="text-xl font-bold text-papsi-dark">My Cart</h3>
                            <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                        <div id="cartList" class="space-y-3 max-h-80 overflow-y-auto"></div>
                        <div class="mt-4 border-t pt-4">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div class="flex-1">
                                    <label for="voucherInput" class="block text-sm font-medium text-gray-700 mb-1">Voucher Code</label>
                                    <div class="flex gap-2">
                                        <input id="voucherInput" type="text" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Enter voucher code for discount">
                                        <button id="validateVoucherBtn" onclick="validateVoucher()" class="bg-papsi-dark text-white px-3 py-2 rounded hover:bg-gray-800 transition-colors shrink-0">Validate</button>
                                    </div>
                                    <div id="voucherStatus" class="mt-1 text-sm"></div>
                                </div>
                                <div class="flex-1 text-right mt-2 md:mt-0">
                                    <div class="text-sm text-gray-600">Subtotal: <span id="cartSubtotal" class="font-semibold text-papsi-dark">₱0.00</span></div>
                                    <div id="cartDiscountRow" class="text-sm text-gray-600 hidden">Discount: <span id="cartDiscount" class="font-semibold text-papsi-green">-₱0.00</span></div>
                                    <div id="cartVoucherRow" class="text-sm text-gray-600 hidden">Voucher: <span id="cartVoucher" class="font-semibold text-papsi-green">-₱0.00</span></div>
                                    <div class="text-base font-bold text-papsi-green">Total: <span id="cartTotal">₱0.00</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex flex-col md:flex-row gap-2 justify-end">
                            <button id="confirmRegistrationBtn" onclick="confirmRegistration()" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700 transition-colors flex-1 md:flex-none">Confirm Registration</button>
                            <button onclick="closeCart()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors flex-1 md:flex-none">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Extras Page -->
        <div id="extras-page" class="page-content hidden">
            <h2 class="text-2xl font-bold text-papsi-dark mb-6">Extras</h2>
            <div id="extrasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Calendar Modal -->
        <div id="calendarModal" class="modal hidden z-50">
            <div class="modal-content max-w-3xl mx-auto p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-papsi-dark">PAPSI Calendar</h3>
                    <button onclick="closeCalendarModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <button onclick="changeCalendarMonth(-1)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">&#8592; Prev</button>
                    <div id="calendarMonthLabel" class="font-semibold text-lg"></div>
                    <button onclick="changeCalendarMonth(1)" class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">Next &#8594;</button>
                </div>
                <div id="calendarGrid" class="overflow-x-auto"></div>
            </div>
        </div>
<script>
// Calendar modal state
let calendarMonth = new Date().getMonth();
let calendarYear = new Date().getFullYear();

function openCalendarModal() {
    renderCalendar();
    document.getElementById('calendarModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}
function closeCalendarModal() {
    document.getElementById('calendarModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}
function changeCalendarMonth(delta) {
    calendarMonth += delta;
    if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear--;
    } else if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear++;
    }
    renderCalendar();
}
function renderCalendar() {
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
    const firstDay = new Date(calendarYear, calendarMonth, 1).getDay();
    const calendarGrid = document.getElementById('calendarGrid');
    document.getElementById('calendarMonthLabel').textContent = `${monthNames[calendarMonth]} ${calendarYear}`;

    // Gather events from allCourses (assume course.date or course.startDate)
    // Group events by day
    const events = (allCourses || []).map(c => {
        let dateStr = c.date || c.startDate;
        if (!dateStr) return null;
        let d = new Date(dateStr);
        if (isNaN(d)) return null;
        return { day: d.getDate(), month: d.getMonth(), year: d.getFullYear(), title: c.title };
    }).filter(e => e && e.month === calendarMonth && e.year === calendarYear);

    // Map: day -> array of events
    const eventsByDay = {};
    events.forEach(e => {
        if (!eventsByDay[e.day]) eventsByDay[e.day] = [];
        eventsByDay[e.day].push(e);
    });

    let html = '<table class="w-full text-sm"><thead><tr>';
    ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d => html += `<th class="p-1 text-center font-medium">${d}</th>`);
    html += '</tr></thead><tbody><tr>';
    let day = 1;
    let started = false;
    for (let i = 0; i < 6; i++) { // max 6 weeks
        for (let j = 0; j < 7; j++) {
            if (!started && j === firstDay) started = true;
            if (started && day <= daysInMonth) {
                const dayEvents = eventsByDay[day] || [];
                html += `<td class="border h-16 align-top p-1 ${dayEvents.length ? 'bg-green-50' : ''}">`;
                html += `<div class="font-bold">${day}</div>`;
                if (dayEvents.length) {
                    dayEvents.forEach(ev => {
                        html += `<div class="mt-1 text-xs text-papsi-green font-semibold truncate">${ev.title}</div>`;
                    });
                }
                html += '</td>';
                day++;
            } else {
                html += '<td class="border h-16"></td>';
            }
        }
        if (day > daysInMonth) break;
        html += '</tr><tr>';
    }
    html += '</tr></tbody></table>';
    calendarGrid.innerHTML = html;

    // Add scrollable event list for selected day (if needed)
    // Optionally, you can add a click handler to each cell to show a modal with all events for that day
}
</script>
<script>
// === Sticky Checkout Bar & Cart UX Enhancement (Persistent) ===
const CART_COACH_KEY = 'PAPSI_CART_COACH_DONE';
const CART_HIDE_BAR_KEY = 'PAPSI_HIDE_CART_BAR';
const CART_STORAGE_KEY = 'PAPSI_CART_ITEMS';
let CART_MODAL_OPEN = false;

// Load persisted cart early if available
try {
    const savedCart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');
    if (Array.isArray(savedCart) && savedCart.every(x => typeof x === 'string')) {
        cartCourses = savedCart; // will sync UI after data load
    }
} catch {}

function persistCart(){
    try { localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cartCourses)); } catch {}
}

function formatMoney(n){ return '₱' + Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
function parseCourseFees(course){
    // Supports either numeric fields (regular_fee, promo_fee) or string fields (originalPrice, price)
    let reg = 0, promo = 0;
    if (course && course.regular_fee != null) {
        reg = parseFloat(String(course.regular_fee).toString().replace(/[^0-9.]/g, '')) || 0;
    } else if (course && course.originalPrice) {
        reg = parseFloat(String(course.originalPrice).toString().replace(/[^0-9.]/g, '')) || 0;
    }
    if (course && course.promo_fee != null) {
        promo = parseFloat(String(course.promo_fee).toString().replace(/[^0-9.]/g, '')) || 0;
    } else if (course && course.price) {
        promo = parseFloat(String(course.price).toString().replace(/[^0-9.]/g, '')) || 0;
    }
    if (reg === 0 && promo > 0) reg = promo; // fallback: if no regular specified, treat promo as regular
    if (promo === 0 && reg > 0) promo = reg; // fallback: if no promo specified, treat promo same as regular
    return { reg, promo };
}
function computeCartTotals(){
    let regularSum = 0;
    let promoSum = 0;
    (cartCourses||[]).forEach(id => {
        const c = (allCourses||[]).find(x => x.id === id);
        if (!c) return;
        const { reg, promo } = parseCourseFees(c);
        regularSum += reg;
        promoSum += promo;
    });
    const baseDiscount = Math.max(0, regularSum - promoSum);
    let voucherDiscount = 0;
    try {
        if (appliedVoucher && typeof appliedVoucher.percentage === 'number' && appliedVoucher.percentage > 0) {
            voucherDiscount = promoSum * (appliedVoucher.percentage / 100);
        }
    } catch {}
    const total = Math.max(0, promoSum - voucherDiscount);
    return { regularSum, promoSum, baseDiscount, voucherDiscount, total };
}
function overlayBlocksCartBar(){
    try{
        const isOpen = (el) => el && !el.classList.contains('hidden');
        const iv = document.getElementById('imageViewer');
        const about = document.getElementById('aboutModal');
        const audio = document.getElementById('audioModal');
        return isOpen(iv) || isOpen(about) || isOpen(audio);
    }catch{ return false; }
}
function updateCartBar(){
    const count = cartCourses.length;
    const onHub = (window.__currentPage === 'hub');

    // Hide global sticky bar on all pages (we only use the Training Center bar)
    const sticky = document.getElementById('cartStickyBar');
    if (sticky) {
        sticky.classList.add('hidden');
        dismissCoachMark();
    }

    // Training Center bottom bar for hub page
    const tbar = document.getElementById('trainingCartBar');
    if (tbar) {
        if (onHub && count > 0 && !CART_MODAL_OPEN && !overlayBlocksCartBar()) {
            const { regularSum, total } = computeCartTotals();
            const subEl = document.getElementById('trainingBarSubtotal');
            const totEl = document.getElementById('trainingBarTotal');
            const cntEl = document.getElementById('trainingBarCount');
            if (subEl) subEl.textContent = formatMoney(regularSum);
            if (totEl) totEl.textContent = formatMoney(total);
            if (cntEl) cntEl.textContent = count;
            tbar.classList.remove('hidden');
            // Add bottom padding to hub page so pagination isn't covered by the bar
            const hub = document.getElementById('hub-page');
            if (hub) { hub.classList.add('pb-28','md:pb-24'); }
            // Expand bottom spacer just above the bar
            const spacer = document.getElementById('trainingBottomSpacer');
            if (spacer) { spacer.className = 'h-24 md:h-20'; }
        } else {
            tbar.classList.add('hidden');
            // Remove extra padding when bar is hidden
            const hub = document.getElementById('hub-page');
            if (hub) { hub.classList.remove('pb-28','md:pb-24'); }
            const spacer = document.getElementById('trainingBottomSpacer');
            if (spacer) { spacer.className = 'h-0'; }
        }
    }
}
function hideCartBar(){
    const bar = document.getElementById('cartStickyBar');
    if(bar) bar.classList.add('hidden');
    try { localStorage.setItem(CART_HIDE_BAR_KEY,'1'); } catch {}
}
function maybeShowCartBarFirstTime(){
    try { if(localStorage.getItem(CART_HIDE_BAR_KEY)==='1') return; } catch {}
    updateCartBar();
}
function showAddToastWithAction(title){
    try {
        showToast(`${title} added to cart`, 'success', 4000);
        const container = document.getElementById('toastContainer');
        const last = container?.lastElementChild;
        if(last){
            const btn = document.createElement('button');
            btn.textContent = 'View Cart';
            btn.className = 'ml-auto bg-white/20 hover:bg-white/30 text-white text-xs px-2 py-1 rounded';
            btn.onclick = () => openCart();
            last.appendChild(btn);
        }
    } catch {}
}
// Coach mark
function positionCoachMark(){
    const coach = document.getElementById('cartCoachMark');
    const bar = document.getElementById('cartStickyBar');
    if(!coach || !bar || bar.classList.contains('hidden')) return;
    const rect = bar.getBoundingClientRect();
    coach.style.left = (rect.left + 24) + 'px';
    coach.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
}
function showCoachMarkOnce(){
    try { if(localStorage.getItem(CART_COACH_KEY)==='1') return; } catch {}
    const coach = document.getElementById('cartCoachMark');
    const bar = document.getElementById('cartStickyBar');
    if(!coach || !bar || bar.classList.contains('hidden')) return;
    coach.classList.remove('hidden');
    positionCoachMark();
    window.addEventListener('resize', positionCoachMark);
    window.addEventListener('scroll', positionCoachMark, { passive:true });
}
function dismissCoachMark(){
    const coach = document.getElementById('cartCoachMark');
    if(coach && !coach.classList.contains('hidden')){
        coach.classList.add('hidden');
        window.removeEventListener('resize', positionCoachMark);
        window.removeEventListener('scroll', positionCoachMark);
        try { localStorage.setItem(CART_COACH_KEY,'1'); } catch {}
    }
}
window.dismissCoachMark = dismissCoachMark;

// Clear entire cart
function clearEntireCart(){
    if(!cartCourses.length) return;
    cartCourses = [];
    persistCart();
    renderCourses();
    updateCartCount();
    closeCart();
    updateCartBar();
    try { showToast('Cart cleared','info'); } catch {}
}

// Keep sticky bar in sync on load and after UI changes

document.addEventListener('DOMContentLoaded', () => {
    // Ensure cart bars are not nested inside any hidden page-content container
    try {
        ['cartStickyBar','trainingCartBar','cartCoachMark'].forEach(id => {
            const el = document.getElementById(id);
            if (el && el.closest('.page-content')) {
                document.body.appendChild(el);
            }
        });
    } catch {}

    maybeShowCartBarFirstTime();
    if(cartCourses.length){ setTimeout(showCoachMarkOnce, 800); }
});
</script>
        <!-- Sticky Checkout Bar & Coach Mark -->
        <div id="cartStickyBar" class="fixed left-0 right-0 bottom-4 z-[1100] px-3 hidden">
            <div class="mx-auto max-w-4xl bg-white border shadow-lg rounded-xl flex items-center justify-between gap-4 px-4 py-3 animate-[cartBarIn_.35s_ease]">
                <div class="flex items-center gap-3">
                    <button type="button" onclick="openCart()" class="relative w-11 h-11 rounded-full bg-papsi-green text-white flex items-center justify-center hover:bg-green-700 transition" aria-label="Open cart">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.35 2.7A1 1 0 007 17h10a1 1 0 00.95-.68L21 13M7 13V6a1 1 0 011-1h5a1 1 0 011 1v7"/>
                        </svg>
                        <span id="cartBarCount" class="absolute -top-1 -right-1 text-[10px] bg-white text-papsi-green font-bold px-1.5 py-0.5 rounded-full shadow">0</span>
                    </button>
                    <div class="leading-tight">
                        <div class="text-xs text-gray-500">Subtotal</div>
                        <div class="text-sm font-semibold text-papsi-dark"><span id="cartBarSubtotal">₱0.00</span></div>
                    </div>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <button type="button" onclick="openCart()" class="text-sm px-4 py-2 rounded bg-papsi-green text-white font-medium hover:bg-green-700 shadow-sm">Checkout (<span id="cartBarItems">0</span>)</button>
                    <button type="button" onclick="clearEntireCart()" class="text-sm px-3 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300">Clear Cart</button>
                    <button type="button" onclick="hideCartBar()" class="p-2 text-gray-400 hover:text-gray-600" aria-label="Hide sticky cart bar">
                        <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 6l8 8M6 14L14 6"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Training Center Bottom Cart Bar (only visible on hub page when cart > 0) -->
    <div id="trainingCartBar" class="fixed left-0 right-0 bottom-24 md:bottom-20 z-[1100] px-3 hidden">
            <div class="mx-auto max-w-4xl bg-white border shadow-lg rounded-xl flex items-center justify-between gap-4 px-4 py-3">
                <div class="flex items-center gap-6">
                    <div class="leading-tight">
                        <div class="text-xs text-gray-500">Subtotal</div>
                        <div class="text-sm font-semibold text-papsi-dark"><span id="trainingBarSubtotal">₱0.00</span></div>
                    </div>
                    <div class="leading-tight">
                        <div class="text-xs text-gray-500">Total</div>
                        <div class="text-sm font-semibold text-papsi-green"><span id="trainingBarTotal">₱0.00</span></div>
                    </div>
                </div>
                <button type="button" onclick="openCart()" class="relative flex items-center gap-2 bg-papsi-green text-white px-4 py-2 rounded shadow hover:bg-green-700 transition" aria-label="Open cart">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.3 2.6A1 1 0 007 17h10"/>
                    </svg>
                    <span>Cart</span>
                    <span id="trainingBarCount" class="absolute -top-2 -right-2 text-[10px] bg-white text-papsi-green font-bold px-1.5 py-0.5 rounded-full shadow">0</span>
                </button>
            </div>
        </div>
        <div id="cartCoachMark" class="fixed z-[1150] hidden" role="dialog" aria-label="Cart guidance">
            <div class="relative bg-white border shadow-xl rounded-lg p-3 max-w-xs text-sm">
                <div class="font-semibold text-papsi-dark mb-1">Next step</div>
                <p class="text-gray-600 mb-2">Tap Checkout to proceed with registration.</p>
                <div class="flex justify-end gap-2">
                    <button class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300" onclick="dismissCoachMark()">Close</button>
                    <button class="text-xs px-2 py-1 rounded bg-papsi-green text-white hover:bg-green-700" onclick="dismissCoachMark(); openCart();">Open Cart</button>
                </div>
                <div class="absolute -top-2 left-6 w-4 h-4 bg-white border-l border-t rotate-45" aria-hidden="true"></div>
            </div>
        </div>
        <style>
            @keyframes cartBarIn {from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}
        </style>
        <!-- Added-to-Cart Success Banner Animation -->
        <style>
            @keyframes cartAddedPulse { 
                0% { transform: scale(.985); box-shadow:0 0 0 0 rgba(22,105,56,0.45); }
                35% { transform: scale(1); box-shadow:0 0 0 10px rgba(22,105,56,0); }
                100% { transform: scale(1); box-shadow:0 0 0 0 rgba(22,105,56,0); }
            }
            .added-banner-animate { animation: cartAddedPulse 1.8s ease-out 1; }
        </style>
                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-green-400 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">Verification</h3>
                            <p class="text-gray-600 text-sm">Verify certificates (enter code, check if valid)</p>
                        </div>
                    </div>
                    <button onclick="openVerifyModal()" class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        Verify Certificate
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">PAPSI Calendar</h3>
                            <p class="text-gray-600 text-sm">View events and workshops</p>
                        </div>
                    </div>
                    <button onclick="openCalendarModal()" class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        View Calendar
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-orange-500 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">Be a PAPSI Speaker</h3>
                            <p class="text-gray-600 text-sm">Submit profile + topic proposal</p>
                        </div>
                    </div>
                    <button class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        Apply as Speaker
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 2a1 1 0 011 1v1h1a1 1 0 010 2H6v1a1 1 0 01-2 0V6H3a1 1 0 010-2h1V3a1 1 0 011-1zm0 10a1 1 0 011 1v1h1a1 1 0 110 2H6v1a1 1 0 11-2 0v-1H3a1 1 0 110-2h1v-1a1 1 0 011-1zM12 2a1 1 0 01.967.744L14.146 7.2 17.5 9.134a1 1 0 010 1.732L14.146 12.8l-1.179 4.456a1 1 0 01-1.934 0L9.854 12.8 6.5 10.866a1 1 0 010-1.732L9.854 7.2l1.179-4.456A1 1 0 0112 2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">Host an Event</h3>
                            <p class="text-gray-600 text-sm">School or organization requests PAPSI partnership</p>
                        </div>
                    </div>
                    <button class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        Request Partnership
                    </button>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-indigo-500 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">Community</h3>
                            <p class="text-gray-600 text-sm">Connect with other members on Facebook group</p>
                        </div>
                    </div>
                    <button class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        Join Facebook Group
                    </button>
                    <script>
                    // Make the Community button open the Facebook group in a new tab
                    (function() {
                        const communityBtns = document.querySelectorAll('button');
                        communityBtns.forEach(btn => {
                            if (btn.textContent.trim() === 'Join Facebook Group') {
                                btn.onclick = function() {
                                    window.open('https://www.facebook.com/groups/papsifbgroup', '_blank');
                                };
                            }
                        });
                    })();
                    </script>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">Facebook Page</h3>
                            <p class="text-gray-600 text-sm">Visit the official Facebook page of PAPSI</p>
                        </div>
                    </div>
                    <button class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        Visit Facebook Page
                    </button>
                    <script>
                    // Make the Facebook Page button open the official page in a new tab
                    (function() {
                        const fbPageBtns = document.querySelectorAll('button');
                        fbPageBtns.forEach(btn => {
                            if (btn.textContent.trim() === 'Visit Facebook Page') {
                                btn.onclick = function() {
                                    window.open('https://www.facebook.com/papsifbpage', '_blank');
                                };
                            }
                        });
                        // Coming soon placeholders for Apply as Speaker & Request Partnership
                        const soonBtns = Array.from(fbPageBtns).filter(b => {
                            const t = b.textContent.trim();
                            return t === 'Apply as Speaker' || t === 'Request Partnership';
                        });
                        soonBtns.forEach(b => {
                            b.addEventListener('click', function(e){
                                e.preventDefault();
                                try { showToast('Feature coming soon', 'info'); } catch { alert('Feature coming soon'); }
                            });
                        });
                    })();
                    </script>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 card-hover">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-papsi-red rounded-lg flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-semibold text-papsi-dark">Help & Support</h3>
                            <p class="text-gray-600 text-sm">Get assistance and contact support</p>
                        </div>
                    </div>
                    <button onclick="openSupportModal()" class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                        Contact Support
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page-content hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-papsi-dark">Profile</h2>
                <div class="flex items-center gap-3">
                    <button id="refreshBtn" class="refresh-btn flex items-center gap-1 px-3 py-1.5 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm" title="Refresh Profile" type="button" aria-label="Refresh Profile" data-inline-spin="true">
                        <svg class="refresh-icon w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M16.5 7.5h5v5" />
                            <path d="M2.5 11.5a9 9 0 0115.364-5.364L21.5 9" />
                            <path d="M7.5 16.5h-5v-5" />
                            <path d="M21.5 12.5a9 9 0 01-15.364 5.364L2.5 15" />
                        </svg>
                        <span>Refresh</span>
                    </button>
                    <button id="logoutBtn" class="hidden flex items-center gap-1 px-3 py-1.5 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 text-sm" title="Logout" type="button">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><path stroke-linecap="round" stroke-linejoin="round" d="M10 17l5-5-5-5"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H3"/></svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center space-x-6 mb-8">
                    <div class="w-24 h-24 bg-papsi-green rounded-full flex items-center justify-center">
                        <span id="avatarInitials" class="text-white text-2xl font-medium">JD</span>
                    </div>
                    <div>
                        <h3 id="profileName" class="text-xl font-bold text-papsi-dark">John A Doe</h3>
                        <div class="flex items-center space-x-4 mt-1">
                            <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                                Active
                            </span>
                            <span id="profileValidity" class="text-gray-500 text-sm">until Dec 12, 2025</span>
                        </div>
                        <div class="mt-1">
                            <span id="profileId" class="text-gray-600 text-sm">PAPSI ID: 2025001</span>
                        </div>
                    </div>
                </div>

                <form class="space-y-8">
                    <!-- Account Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-papsi-dark mb-4">Account Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Email</label>
                                <input id="emailInput" type="email" aria-readonly="true" readonly
                                       value="john.doe@email.com"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Password</label>
                                <input id="passwordInput" type="password" value="********" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                        </div>
                    </div>

                    <!-- Personal Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-papsi-dark mb-4">Personal Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Title</label>
                                <select id="profileTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" aria-controls="profileTitleOther" aria-expanded="false">
                                    <option>Mr.</option>
                                    <option>Ms.</option>
                                    <option>Mrs.</option>
                                    <option>Dr.</option>
                                    <option>Mx.</option>
                                    <option>Other</option>
                                </select>
                                <input id="profileTitleOther" type="text" placeholder="Enter your title" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green hidden">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">First Name</label>
                                <input id="firstNameInput" type="text" aria-readonly="true" readonly value="John" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Middle Initial</label>
                                <input id="middleInitialInput" type="text" aria-readonly="true" readonly value="A" maxlength="1" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Last Name</label>
                                <input id="lastNameInput" type="text" aria-readonly="true" readonly value="Doe" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Suffix</label>
                                <input id="suffixInput" type="text" aria-readonly="true" readonly value="" placeholder="Jr., Sr., III, etc." class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Birth Date</label>
                                <input id="birthDateInput" type="date" value="1985-06-15" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Mobile Number</label>
                                <input id="mobileInput" type="tel" value="+63 912 345 6789" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                        </div>
                    </div>

                    <!-- Affiliation -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-papsi-dark mb-4">Affiliation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Name of School/Organization</label>
                                <input id="schoolInput" type="text" value="University of the Philippines" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Type</label>
                                <select id="typeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green">
                                    <option>Public</option>
                                    <option>Private</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-papsi-dark mb-2">Address of School/Organization</label>
                            <textarea id="addressTextarea" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Complete address of your school or organization">Diliman, Quezon City, Metro Manila 1101</textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Position</label>
                                <select id="positionSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" aria-controls="positionOther" aria-expanded="false">
                                    <option value="">Select position…</option>
                                    <option>Student</option>
                                    <option>Teacher</option>
                                    <option>Subject Teacher</option>
                                    <option>Class Adviser</option>
                                    <option>Homeroom Teacher</option>
                                    <option>Master Teacher</option>
                                    <option>Lead Teacher</option>
                                    <option>Head Teacher</option>
                                    <option>Assistant Principal/ Vice Principal</option>
                                    <option>Principal</option>
                                    <option>Instructor</option>
                                    <option>Lecturer</option>
                                    <option>Adjunct Instructor/ Adjunct Faculty</option>
                                    <option>Teaching Assistant</option>
                                    <option>Graduate Assistant</option>
                                    <option>Assistant Professor</option>
                                    <option>Associate Professor</option>
                                    <option>Professor</option>
                                    <option>Visiting Professor/ Visiting Lecturer</option>
                                    <option>Clinical Instructor/ Clinical Professor</option>
                                    <option>Research Professor</option>
                                    <option>Extension Professor</option>
                                    <option>Distinguished Professor</option>
                                    <option>Endowed Chair/ Chair Professor</option>
                                    <option>Professor Emeritus/ Emerita</option>
                                    <option>Tutor</option>
                                    <option>Trainer</option>
                                    <option>Mentor Teacher</option>
                                    <option>Subject Matter Expert</option>
                                    <option>Faculty Specialist</option>
                                    <option>Other</option>
                                </select>
                                <input id="positionOther" type="text" placeholder="Enter your position" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green hidden">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Specialization</label>
                                <select id="specializationSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" aria-controls="specializationOther" aria-expanded="false">
                                    <option value="">Select specialization…</option>
                                    <option>Physics</option>
                                    <option>Biology</option>
                                    <option>Chemistry</option>
                                    <option>Natural Science</option>
                                    <option>Physical Science</option>
                                    <option>General Science</option>
                                    <option>Earth Science</option>
                                    <option>Mathematics</option>
                                    <option>Other</option>
                                </select>
                                <input id="specializationOther" type="text" placeholder="Enter your specialization" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green hidden">
                            </div>
                        </div>
                    </div>

                    <!-- Academic & Research Information -->
                    <div class="border-b border-gray-200 pb-6">
                        <h4 class="text-lg font-semibold text-papsi-dark mb-4">Academic & Research Information</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">About</label>
                                <textarea id="aboutTextarea" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Brief professional background and experience">Experienced educational psychologist with 10+ years in research and practice. Specializes in cognitive development and learning assessment methodologies.</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Research Interests</label>
                                <textarea id="researchTextarea" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Areas of research interest">Cognitive development, learning disabilities, educational assessment, psychological testing, child psychology</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-papsi-dark mb-2">Publications</label>
                                <textarea id="publicationsTextarea" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="List your publications, research papers, books, etc."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-papsi-green text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
                            Save Changes
                        </button>
                        <button type="button" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-colors">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-around items-end py-2">
                <button onclick="showPage('home')" id="home-btn" class="flex flex-col items-center py-2 px-3 active-tab">
                    <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                    </svg>
                    <span class="text-xs">Home</span>
                </button>
                
                <button onclick="showPage('hub')" id="hub-btn" class="flex flex-col items-center py-2 px-3 text-gray-500">
                    <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                    <span class="text-xs">Training Center</span>
                </button>
                
                <button onclick="showPage('learning')" id="learning-btn" class="flex flex-col items-center py-2 px-3 text-gray-500">
                    <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-xs">My Learning</span>
                </button>
                
                <button onclick="showPage('extras')" id="extras-btn" class="flex flex-col items-center py-2 px-3 text-gray-500">
                    <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                    </svg>
                    <span class="text-xs">Extras</span>
                </button>
                
                <button onclick="showPage('profile')" id="profile-btn" class="flex flex-col items-center py-2 px-3 text-gray-500">
                    <svg class="w-5 h-5 mb-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-xs">Profile</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Add bottom padding to prevent content from being hidden behind nav -->
    <div class="h-20"></div>

    <!-- Image Viewer Modal -->
    <div id="imageViewer" class="image-viewer hidden">
        <div class="viewer-controls">
            <button class="viewer-btn" onclick="closeImageViewer()">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
        <div class="image-container" id="imageContainer">
            <img id="viewerImage" class="viewer-image" src="" alt="Training Image">
        </div>
        <div class="zoom-controls">
            <button class="viewer-btn" onclick="zoomOut()">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"/>
                </svg>
            </button>
            <button class="viewer-btn" onclick="resetZoom()">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
            </button>
            <button class="viewer-btn" onclick="zoomIn()">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-papsi-dark" id="aboutTitle">Course Information</h3>
                    <button onclick="closeAbout()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                <div id="aboutContent" class="space-y-4">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="aboutRegisterBtn" onclick="aboutRegisterNow()" class="bg-papsi-green text-white py-2 px-4 rounded hover:bg-green-700 transition-colors">
                        Register Now
                    </button>
                    <button onclick="closeAbout()" class="bg-gray-200 text-gray-700 py-2 px-4 rounded hover:bg-gray-300 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Modal -->
    <div id="audioModal" class="modal hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-papsi-dark" id="audioTitle">Course Preview</h3>
                    <button onclick="closeAudio()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
                <div id="audioContent">
                    <!-- Dynamic audio player will be injected here by playAudio() -->
                    <div class="mt-4">
                        <p class="text-gray-600 text-sm" id="audioDescription">
                            Listen to a preview.
                        </p>
                    </div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button onclick="closeAudio()" class="flex-1 bg-papsi-green text-white py-2 px-4 rounded hover:bg-green-700 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verifyModal" class="modal hidden z-50">
        <div class="modal-content max-w-xl mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-papsi-dark">Certificate Verification</h3>
                <button onclick="closeVerifyModal()" class="text-gray-400 hover:text-gray-600" aria-label="Close verification modal">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="verifyCodeInput" class="block text-sm font-medium text-gray-700 mb-1">Enter verification code</label>
                    <input id="verifyCodeInput" type="text" class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-papsi-green" placeholder="Enter the certificate code here.">
                </div>
                <div class="flex gap-2 justify-end">
                    <button onclick="verifyCertificate()" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">Verify</button>
                    <button onclick="closeVerifyModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors">Cancel</button>
                </div>
                <div id="verifyResult" class="text-sm"></div>
            </div>
        </div>
    </div>

    <script>
        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        let audioPlaying = false;
        let audioProgress = 0;
        let audioInterval;


        // Dynamic data containers for courses
        let allCourses = [];
        let filteredCourses = [];

        // --- Audio URL helpers ---
        function getFirstUrlFromText(text) {
            if (!text || typeof text !== 'string') return '';
            // Extract the first http/https URL
            const match = text.match(/https?:\/\/[^\s)]+/i);
            return match ? match[0] : '';
        }

        function normalizeDriveUrl(url) {
            if (!url) return '';
            try {
                const u = new URL(url);
                if (u.hostname.includes('drive.google.com')) {
                    // Patterns: /file/d/ID/view | /file/d/ID/preview | open?id=ID | uc?id=ID
                    let id = '';
                    const fileMatch = u.pathname.match(/\/file\/d\/([^/]+)/);
                    if (fileMatch && fileMatch[1]) id = fileMatch[1];
                    if (!id && (u.searchParams.get('id') || u.searchParams.get('file_id'))) {
                        id = u.searchParams.get('id') || u.searchParams.get('file_id');
                    }
                    if (id) {
                        return `https://drive.google.com/uc?export=download&id=${id}`;
                    }
                }
            } catch {}
            return url;
        }

        function normalizeDropboxUrl(url) {
            if (!url) return '';
            try {
                const u = new URL(url);
                if (u.hostname.includes('dropbox.com')) {
                    // Ensure direct download for streaming
                    u.searchParams.set('dl', '1');
                    return u.toString();
                }
            } catch {}
            return url;
        }

        function normalizeAudioUrl(raw) {
            if (!raw || typeof raw !== 'string') return '';
            let url = getFirstUrlFromText(raw.trim());
            if (!/^https?:\/\//i.test(url)) return '';
            // Normalize known hosts
            url = normalizeDriveUrl(url);
            url = normalizeDropboxUrl(url);
            return url;
        }

        function resolveAudioFromItem(item) {
            if (!item || typeof item !== 'object') return '';
            // Prefer obvious fields first
            const preferredKeys = [
                'audio', 'Audio', 'audio_link', 'Audio Link', 'audioLink', 'AudioLink', 'audiourl', 'audio_url', 'Audio URL', 'audiourl'
            ];
            for (const key of preferredKeys) {
                if (key in item && typeof item[key] === 'string') {
                    const n = normalizeAudioUrl(item[key]);
                    if (n) return n;
                }
            }
            // Fallback: scan any field with "audio" in the key name
            for (const k of Object.keys(item)) {
                if (/audio/i.test(k) && typeof item[k] === 'string') {
                    const n = normalizeAudioUrl(item[k]);
                    if (n) return n;
                }
            }
            return '';
        }
    // My Learning state (attended items per logged-in user)
    let myLearning = [];
    let filteredLearningCourses = [];
    // Pagination for My Learning
    let learningCurrentPage = 1;
    const learningPerPage = 8;

        // Robust date parsing for varying formats
        function parseFlexDate(val) {
            if (!val) return new Date(0);
            // If already a Date
            if (val instanceof Date) return isNaN(val) ? new Date(0) : val;
            const s = String(val).trim();
            // Try native first
            let d = new Date(s);
            if (!isNaN(d)) return d;
            // Try DD/MM/YYYY or D/M/YYYY
            const dmY = s.match(/^([0-3]?\d)[\/\-]([0-1]?\d)[\/\-](\d{4})$/);
            if (dmY) {
                const day = parseInt(dmY[1], 10);
                const mon = parseInt(dmY[2], 10) - 1;
                const yr = parseInt(dmY[3], 10);
                d = new Date(yr, mon, day);
                return isNaN(d) ? new Date(0) : d;
            }
            // Try YYYY/MM/DD
            const yMd = s.match(/^(\d{4})[\/\-]([0-1]?\d)[\/\-]([0-3]?\d)$/);
            if (yMd) {
                const yr = parseInt(yMd[1], 10);
                const mon = parseInt(yMd[2], 10) - 1;
                const day = parseInt(yMd[3], 10);
                d = new Date(yr, mon, day);
                return isNaN(d) ? new Date(0) : d;
            }
            // Try DD-MMM-YYYY (e.g., 05-Feb-2024)
            const dMonY = s.match(/^([0-3]?\d)[\-\s]([A-Za-z]{3,})[\-\s](\d{4})$/);
            if (dMonY) {
                const map = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,sept:8,oct:9,nov:10,dec:11};
                const day = parseInt(dMonY[1], 10);
                const mon = map[dMonY[2].slice(0,3).toLowerCase()];
                const yr = parseInt(dMonY[3], 10);
                if (typeof mon === 'number') {
                    d = new Date(yr, mon, day);
                    return isNaN(d) ? new Date(0) : d;
                }
            }
            return new Date(0);
        }

        // Normalize a single attended item from server to UI course shape
        function normalizeAttendedItem(it, idx) {
            const d = parseFlexDate(it?.date);
            const hoursRaw = (typeof it?.hours === 'number') ? it.hours : (it?.hours ? parseFloat(String(it.hours).replace(/[^0-9.]/g, '')) : 0);
            const hoursNum = isNaN(hoursRaw) ? 0 : hoursRaw;
            // Attempt to resolve module URL from multiple potential key variants
            const moduleUrl = (
                it?.module || it?.Module || it?.modules || it?.Modules ||
                it?.['module link'] || it?.['Module Link'] || it?.['module_url'] ||
                it?.['moduleURL'] || it?.['ModuleURL'] || it?.['moduleurl'] || ''
            );
            return {
                id: `learn-${idx}`,
                title: String(it?.title || ''),
                instructor: String(it?.speaker || ''),
                image: typeof it?.poster === 'string' ? it.poster : '',
                category: it?.category === 'I.C.T.' ? 'ICT' : String(it?.category || ''),
                date: d,
                duration: hoursNum ? `${hoursNum} hours` : (it?.hours ? `${it.hours} hours` : ''),
                hoursNum: hoursNum,
                video: String(it?.video || ''),
                module: String(moduleUrl || ''),
                presentation: String(it?.presentation || ''),
                description: ''
            };
        }

        // Accept attended array and hydrate My Learning state + UI
        function setMyLearning(attendedArr) {
            if (!Array.isArray(attendedArr)) {
                myLearning = [];
                filteredLearningCourses = [];
                learningCurrentPage = 1;
                // Go through canonical pipeline to ensure sorting/counters/stats
                filterLearningCourses();
                return;
            }
            myLearning = attendedArr.map((it, i) => normalizeAttendedItem(it, i));
            filteredLearningCourses = [...myLearning];
            learningCurrentPage = 1;
            populateLearningFilters();
            // Use canonical pipeline so default sort (newest) applies on first render
            filterLearningCourses();
        }

        // Populate My Learning filters from current myLearning data
        function populateLearningFilters() {
            const categoryEl = document.getElementById('learningCategoryFilter');
            const speakerEl = document.getElementById('learningSpeakerFilter');
            if (!categoryEl || !speakerEl) return;

            const prevCat = categoryEl.value;
            const prevSpk = speakerEl.value;

            const categories = Array.from(new Set(myLearning.map(x => x.category).filter(Boolean))).sort();
            const speakers = Array.from(new Set(myLearning.map(x => x.instructor).filter(Boolean))).sort();

            categoryEl.innerHTML = '<option value="all">All Categories</option>' +
                categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
            speakerEl.innerHTML = '<option value="all">All Speakers</option>' +
                speakers.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');

            // Try to preserve previous selections if still valid
            if (prevCat && (prevCat === 'all' || categories.includes(prevCat))) categoryEl.value = prevCat;
            if (prevSpk && (prevSpk === 'all' || speakers.includes(prevSpk))) speakerEl.value = prevSpk;
        }

    // Cart state
    let cartCourses = [];
    // Voucher state
    let appliedVoucher = null; // { code: string, percentage: number, date?: string }

    // Pagination state for training center
    let currentPage = 1;
    const coursesPerPage = 8;

        // Fetch courses from endpoint and populate allCourses
        async function loadTrainingCourses() {
            const url = "https://script.google.com/macros/s/AKfycbz8awvt1aQpxA-7vfyp7WJRQLODyHdhVlaMfn7KsRnGIBaLaeQ_7ZYED4qI4kL0CpmXsw/exec?SH=training&func=training";
            const grid = document.getElementById('coursesGrid');
            const counter = document.getElementById('resultsCounter');
            grid.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500">Loading courses...</div>`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                allCourses = Array.isArray(data) ? data.map((item, idx) => ({
                    id: `course-${idx}`,
                    title: item.title,
                    date: new Date(item.date),
                    hours: item.hours,
                    hoursNum: parseFloat(item.hours) || 0,
                    instructor: item.speaker,
                    image: (typeof item.poster === 'string' && item.poster.startsWith('http')) ? item.poster : '',
                    category: item.category,
                    price: item.promo_fee ? `₱${item.promo_fee}` : '',
                    originalPrice: item.regular_fee ? `₱${item.regular_fee}` : '',
                    description: item.about,
                    audio: resolveAudioFromItem(item),
                    duration: item.hours + ' hours'
                })) : [];

                // Populate category and speaker filters dynamically
                populateCourseFilters();
                filteredCourses = [...allCourses];
                renderCourses();
                updateCounters();

        // Populate category and speaker filter dropdowns dynamically
        function populateCourseFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            const speakerFilter = document.getElementById('speakerFilter');
            if (!categoryFilter || !speakerFilter) return;

            // Get unique categories and speakers from allCourses
            const categories = Array.from(new Set(allCourses.map(c => c.category).filter(Boolean))).sort();
            const speakers = Array.from(new Set(allCourses.map(c => c.instructor).filter(Boolean))).sort();

            // Save current selections
            const selectedCategory = categoryFilter.value;
            const selectedSpeaker = speakerFilter.value;

            // Populate categories
            categoryFilter.innerHTML = '<option value="all">All Categories</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            // Restore selection if possible
            if (categories.includes(selectedCategory)) categoryFilter.value = selectedCategory;

            // Populate speakers
            speakerFilter.innerHTML = '<option value="all">All Speakers</option>' +
                speakers.map(spk => `<option value="${spk}">${spk}</option>`).join('');
            // Restore selection if possible
            if (speakers.includes(selectedSpeaker)) speakerFilter.value = selectedSpeaker;
        }
            } catch (e) {
                grid.innerHTML = `<div class="col-span-full text-center py-12 text-red-500">Failed to load courses.</div>`;
                counter.textContent = "Showing 0 of 0 courses";
                allCourses = [];
                filteredCourses = [];
            }
        }

        // Search and filter functionality for Training Center
        function filterCourses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const speakerFilter = document.getElementById('speakerFilter').value;
            const dateSort = document.getElementById('dateSort').value;
            const yearFilter = window.trainingYearFilter || null;

            // Filter courses
            filteredCourses = allCourses.filter(course => {
                const matchesSearch = !searchTerm || 
                    course.title.toLowerCase().includes(searchTerm) ||
                    course.instructor.toLowerCase().includes(searchTerm) ||
                    course.description.toLowerCase().includes(searchTerm);
                
                const matchesCategory = categoryFilter === 'all' || course.category === categoryFilter;
                const matchesSpeaker = speakerFilter === 'all' || course.instructor === speakerFilter;
                const matchesYear = !yearFilter || (course.date instanceof Date && !isNaN(course.date) && course.date.getFullYear() === yearFilter);
                return matchesSearch && matchesCategory && matchesSpeaker && matchesYear;
            });

            // Sort courses
            filteredCourses.sort((a, b) => {
                if (dateSort === 'newest') {
                    return b.date - a.date;
                } else {
                    return a.date - b.date;
                }
            });

            // Reset to first page on new filter/search
            currentPage = 1;

            renderCourses();
            updateCounters();
            renderTrainingStats();
            try{ renderTrainingFilterChips(); }catch{}
        }

        function renderCourses() {
            const grid = document.getElementById('coursesGrid');
            const pag = document.getElementById('coursesPagination');

            // Helper to check if course is in cart
            function isInCart(courseId) {
                return cartCourses.includes(courseId);
            }

            if (filteredCourses.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.562M15 6.306a7.962 7.962 0 00-6 0m6 0V5a2 2 0 00-2-2H9a2 2 0 00-2 2v1.306m8 0V7a2 2 0 012 2v6.414l.293.293a1 1 0 001.414-1.414L16 12.586V11a2 2 0 00-2-2H8a2 2 0 00-2 2v1.586l-2.707 2.707a1 1 0 001.414 1.414L7 14.414V13a2 2 0 012-2h6a2 2 0 012 2z"/>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No courses found</h3>
                        <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter criteria.</p>
                    </div>
                `;
                // Clear pagination when no courses
                if (pag) pag.innerHTML = '';
                return;
            }

            // Pagination logic
            const totalCourses = filteredCourses.length;
            const totalPages = Math.ceil(totalCourses / coursesPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            const startIdx = (currentPage - 1) * coursesPerPage;
            const endIdx = startIdx + coursesPerPage;
            const coursesToShow = filteredCourses.slice(startIdx, endIdx);

            // Render courses
            grid.innerHTML = coursesToShow.map(course => {

                var discountVal = 0;
                var regVal = 0, promoVal = 0;
                if (course.originalPrice && course.price) {
                    regVal = parseFloat(course.originalPrice.replace(/[^\d.]/g, ''));
                    promoVal = parseFloat(course.price.replace(/[^\d.]/g, ''));
                    discountVal = regVal - promoVal;
                }

                return `
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden card-hover">
                        <div class="relative bg-white overflow-hidden">
                            <img src="${course.image}" 
                                 alt="${course.title}" 
                                 class="block w-full h-auto object-contain training-image"
                                 loading="lazy" decoding="async"
                                 onclick="openImageViewer(this.src, this.alt)"
                                 onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">
                            <div class="absolute top-2 left-2">
                                <span class="${categoryBadgeClasses(course.category)} px-2 py-1 rounded text-xs font-medium">${course.category || 'Other'}</span>
                            </div>
                            <div class="absolute top-2 right-2 flex space-x-1">
                                <button onclick="showAbout('${course.id}')" class="bg-papsi-green text-white rounded-full p-2 shadow-sm hover:bg-green-700 transition-all" aria-label="About">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                                <button onclick="playAudio('${course.id}')" class="bg-papsi-green text-white rounded-full p-2 shadow-sm hover:bg-green-700 transition-all ${!course.audio ? 'opacity-50 cursor-not-allowed' : ''}" ${!course.audio ? 'disabled' : ''} aria-label="Audio Preview">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.797l-4.146-3.317a1 1 0 00-.632-.22H2a1 1 0 01-1-1V7.64a1 1 0 011-1h1.605a1 1 0 00.632-.22l4.146-3.317a1 1 0 011.617.797zM14.657 7.757a1 1 0 011.414 0A9.972 9.972 0 0118 12a9.972 9.972 0 01-1.929 4.243 1 1 0 11-1.414-1.414A7.971 7.971 0 0016 12c0-1.594-.463-3.078-1.343-4.243a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                            </div>
                            <!-- Bottom overlays -->
                            <div class="absolute left-2 right-2 bottom-2 bg-white rounded-md shadow px-3 py-2">
                                <div class="text-papsi-dark font-semibold text-sm">${course.title}</div>
                                <div class="text-gray-600 text-xs mt-0.5">${course.instructor}</div>
                            </div>
                            <div class="absolute bottom-2 right-2 flex items-center gap-2">
                                <div class="bg-white rounded px-2 py-1 shadow text-xs font-medium">
                                    <span class="text-papsi-gold font-semibold">${course.price || ''}</span>
                                    ${course.originalPrice ? `<span class=\"text-gray-400 line-through ml-1\">${course.originalPrice}</span>` : ''}
                                </div>
                                ${(discountVal > 0) ? `<div class=\"bg-white rounded px-2 py-1 shadow text-xs font-medium\">₱${discountVal} OFF</div>` : ''}
                                <div class="bg-white rounded px-2 py-1 shadow text-xs font-medium">${course.duration || ''}</div>
                            </div>
                        </div>
                        <div class="p-4">
                            ${isInCart(course.id) ? `
                                <div class=\"added-success-banner added-banner-animate w-full rounded-md bg-green-50 border border-green-200 p-3 flex flex-col gap-3\" role=\"status\" aria-live=\"polite\">
                                    <div class=\"flex items-start gap-3\">
                                        <div class=\"flex-shrink-0 w-8 h-8 rounded-full bg-papsi-green text-white flex items-center justify-center\">
                                            <svg class=\"w-5 h-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a1 1 0 00-1.414-1.414L9 10.414 7.557 8.97a1 1 0 10-1.414 1.415l2.121 2.12a1 1 0 001.414 0l4.179-4.314z\" clip-rule=\"evenodd\"/></svg>
                                        </div>
                                        <div class=\"flex-1\">
                                            <p class=\"text-sm font-semibold text-papsi-green leading-snug\">Added to cart</p>
                                            <p class=\"text-xs text-green-700 mt-0.5\">Proceed to checkout when you're ready.</p>
                                        </div>
                                    </div>
                                    <div>
                                        <button type=\"button\" onclick=\"openCart(); event.stopPropagation();\" class=\"w-full inline-flex items-center justify-center gap-2 bg-papsi-green hover:bg-green-700 text-white text-sm font-medium px-3 py-2 rounded-md shadow-sm transition\">
                                            <span>View Cart</span>
                                            <svg class=\"w-4 h-4\" viewBox=\"0 0 20 20\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" aria-hidden=\"true\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" d=\"M3 3h2l.4 2M7 13h7.5a1 1 0 00.93-.64L18 7H5.4M7 13l-1.3 2.6A1 1 0 007 17h8M7 13V6a1 1 0 011-1h3.5\"/></svg>
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <button class=\"w-full py-2 rounded bg-papsi-green hover:bg-green-700 text-white text-sm font-medium\" onclick=\"addToCart('${course.id}'); event.stopPropagation();\">Register Now</button>
                            `}
                        </div>
                    </div>
                `;
                // Category colors now determined by helper

                // Calculate discount dynamically
                let discount = 0;
                let regular = 0, promo = 0;
                if (course.originalPrice && course.price) {
                    // Remove non-numeric chars (like ₱)
                    regular = parseFloat(course.originalPrice.replace(/[^\d.]/g, ''));
                    promo = parseFloat(course.price.replace(/[^\d.]/g, ''));
                    discount = regular - promo;
                }

                return `
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden card-hover">
                        <div class="h-48 overflow-hidden relative">
                            <img src="${course.image}" 
                                 alt="${course.title}" 
                                 class="w-full h-full object-cover training-image"
                                 onclick="openImageViewer(this.src, this.alt)"
                                 onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">
                            <div class="absolute top-2 left-2">
                                <span class="${categoryBadgeClasses(course.category)} px-2 py-1 rounded text-xs font-medium">${course.category}</span>
                            </div>
                            <div class="absolute top-2 right-2 flex space-x-1">
                                <button onclick="showAbout('${course.id}')" class="bg-papsi-green text-white rounded-full p-2 shadow-sm hover:bg-green-700 transition-all" aria-label="About">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                                <button onclick="playAudio('${course.id}')" class="bg-papsi-green text-white rounded-full p-2 shadow-sm hover:bg-green-700 transition-all ${!course.audio ? 'opacity-50 cursor-not-allowed' : ''}" ${!course.audio ? 'disabled' : ''} aria-label="Audio Preview">
                                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.617.797l-4.146-3.317a1 1 0 00-.632-.22H2a1 1 0 01-1-1V7.64a1 1 0 011-1h1.605a1 1 0 00.632-.22l4.146-3.317a1 1 0 011.617.797zM14.657 7.757a1 1 0 011.414 0A9.972 9.972 0 0118 12a9.972 9.972 0 01-1.929 4.243 1 1 0 11-1.414-1.414A7.971 7.971 0 0016 12c0-1.594-.463-3.078-1.343-4.243a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-4">
                            <h3 class="font-semibold text-papsi-dark mb-2">${course.title}</h3>
                            <p class="text-gray-600 text-sm mb-3">${course.instructor}</p>
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center space-x-2">
                                    <span class="text-papsi-gold font-semibold">${course.price}</span>
                                    ${course.originalPrice ? `<span class="text-gray-400 line-through text-sm">${course.originalPrice}</span>` : ''}
                                    ${(discount > 0) ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium">₱${discount} OFF</span>` : ''}
                                </div>
                                <span class="text-xs text-gray-500">${course.duration}</span>
                            </div>
                            <button class="w-full bg-papsi-green text-white py-2 rounded hover:bg-green-700 transition-colors">
                                Register Now
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Pagination controls in external container to match My Learning
            if (pag) {
                if (totalPages > 1) {
                    pag.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <button onclick="changeCoursesPage(-1)" class="px-4 py-2 rounded border ${currentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                            <span class="mx-2 text-sm">Page ${currentPage} of ${totalPages}</span>
                            <button onclick="changeCoursesPage(1)" class="px-4 py-2 rounded border ${currentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
                        </div>
                    `;
                } else {
                    pag.innerHTML = '';
                }
            }
            try{ renderTrainingFilterChips(); }catch{}
        }

        function changeCoursesPage(delta) {
            const totalPages = Math.ceil(filteredCourses.length / coursesPerPage);
            currentPage += delta;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            renderCourses();
            updateCounters(); // also updates cart count
        }

        function updateCounters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const speakerFilter = document.getElementById('speakerFilter').value;
            
            // Calculate total available courses for current filters (including search)
            let totalAvailable = allCourses.filter(course => {
                const matchesSearch = !searchTerm || 
                    course.title.toLowerCase().includes(searchTerm) ||
                    course.instructor.toLowerCase().includes(searchTerm) ||
                    course.description.toLowerCase().includes(searchTerm);
                
                const matchesCategory = categoryFilter === 'all' || course.category === categoryFilter;
                const matchesSpeaker = speakerFilter === 'all' || course.instructor === speakerFilter;

                return matchesSearch && matchesCategory && matchesSpeaker;
            }).length;
            
            const startIdx = (currentPage - 1) * coursesPerPage;
            const shownCourses = Math.max(0, Math.min(coursesPerPage, filteredCourses.length - startIdx));
            
            // Update results counter
            document.getElementById('resultsCounter').textContent = `Showing ${shownCourses} of ${totalAvailable} courses`;
            updateCartCount();

        }

        // Render active filter chips for Training Center
        function renderTrainingFilterChips(){
            const chips = document.getElementById('trainingFilterChips');
            const clearBtn = document.getElementById('trainingClearFilters');
            if(!chips || !clearBtn) return;
            const search = document.getElementById('searchInput');
            const category = document.getElementById('categoryFilter');
            const speaker = document.getElementById('speakerFilter');
            const year = window.trainingYearFilter || null;
            const items = [];
            if(search && search.value.trim()) items.push({ key:'search', label:`Search: ${search.value.trim()}` });
            if(category && category.value !== 'all') items.push({ key:'category', label:`Category: ${category.value}` });
            if(speaker && speaker.value !== 'all') items.push({ key:'speaker', label:`Speaker: ${speaker.value}` });
            if(year) items.push({ key:'year', label:`Year: ${year}` });
            if(!items.length){ chips.classList.add('hidden'); clearBtn.classList.add('hidden'); chips.innerHTML=''; return; }
            chips.classList.remove('hidden'); clearBtn.classList.remove('hidden');
            chips.innerHTML = items.map(it => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-50 text-papsi-green text-xs font-medium" data-key="${it.key}">${it.label}<button type="button" class="ml-1 text-papsi-green/80 hover:text-papsi-green" aria-label="Remove ${it.key}" data-remove="${it.key}">×</button></span>`).join('');
            chips.querySelectorAll('[data-remove]').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const key = btn.getAttribute('data-remove');
                    if(key==='search'){ if(search){ search.value=''; const cs=document.getElementById('clearSearch'); if(cs) cs.classList.add('hidden'); } }
                    if(key==='category'){ if(category){ category.value='all'; } }
                    if(key==='speaker'){ if(speaker){ speaker.value='all'; } }
                    if(key==='year'){ window.trainingYearFilter = null; }
                    filterCourses();
                    try{ window.__updateFilterActiveCounts(); }catch{}
                });
            });
        }

        // Cart logic
        function addToCart(courseId) {
            const wasEmpty = cartCourses.length === 0;
            if (!cartCourses.includes(courseId)) {
                cartCourses.push(courseId);
                renderCourses();
                updateCartCount();
                try { persistCart(); } catch {}
                try {
                    const c = (allCourses||[]).find(x=>x.id===courseId);
                    showAddToastWithAction(c ? c.title : 'Course');
                } catch {}
                try { updateCartBar(); } catch {}
                if (wasEmpty) { try { setTimeout(showCoachMarkOnce, 600); } catch {} }
            }
        }

        function updateCartCount() {
            const cartCount = document.getElementById('cartCount');
            if (cartCount) cartCount.textContent = cartCourses.length;
            try { updateCartBar(); } catch {}
        }

    function openCart() {
        // Mark modal as open and immediately hide any cart bars/coach marks
        try { CART_MODAL_OPEN = true; } catch {}
        try { updateCartBar(); } catch {}
        try { dismissCoachMark(); } catch {}
        // Hide other modals
        closeAbout();
        closeAudio();
            // Render cart list
            const cartList = document.getElementById('cartList');
            let subtotal = 0; // regular sum
            let total = 0;    // final total after voucher
            let voucherDiscount = 0; // voucher amount computed from promo sum
            if (cartCourses.length === 0) {
                cartList.innerHTML = '<div class="text-gray-500 text-center">Your cart is empty.</div>';
                setTimeout(() => {
                    const confirmBtn = document.getElementById('confirmRegistrationBtn');
                    if (confirmBtn) {
                        confirmBtn.disabled = true;
                        confirmBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                        confirmBtn.classList.remove('bg-papsi-green', 'hover:bg-green-700');
                    }
                }, 0);
            } else {
                cartList.innerHTML = cartCourses.map(id => {
                    const course = allCourses.find(c => c.id === id);
                    if (!course) return '';
                    // Parse prices (supports regular_fee/promo_fee or originalPrice/price)
                    const fees = parseCourseFees(course);
                    subtotal += fees.reg; // subtotal should add regular fee
                    return `<div class="flex flex-col md:flex-row md:justify-between md:items-center border-b pb-2 gap-1 group">
                        <span class="font-medium">${course.title}</span>
                        <span class="flex items-center gap-2">
                            ${fees.reg > 0 ? `<span class='text-gray-400 line-through text-sm'>₱${fees.reg.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>` : ''}
                            <span class="font-semibold text-papsi-gold">₱${fees.promo.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
                            <button onclick="removeFromCart('${course.id}')" class="ml-2 text-gray-400 hover:text-red-600 transition-colors" title="Remove">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </span>
                    </div>`;
                }).join('');
                setTimeout(() => {
                    const confirmBtn = document.getElementById('confirmRegistrationBtn');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                        confirmBtn.classList.add('bg-papsi-green', 'hover:bg-green-700');
                    }
                }, 0);
            }
            // Totals computation according to new rules
            const { regularSum, promoSum, baseDiscount, voucherDiscount: vDisc, total: finalTotal } = computeCartTotals();
            document.getElementById('cartSubtotal').textContent = `₱${regularSum.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            const discountRow = document.getElementById('cartDiscountRow');
            const discountEl = document.getElementById('cartDiscount');
            if (discountRow && discountEl) {
                if (baseDiscount > 0) {
                    discountRow.classList.remove('hidden');
                    discountEl.textContent = `-₱${baseDiscount.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
                } else {
                    discountRow.classList.add('hidden');
                    discountEl.textContent = '-₱0.00';
                }
            }
            const voucherRow = document.getElementById('cartVoucherRow');
            const voucherEl = document.getElementById('cartVoucher');
            if (voucherRow && voucherEl) {
                if (vDisc > 0) {
                    voucherRow.classList.remove('hidden');
                    voucherEl.textContent = `-₱${vDisc.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
                } else {
                    voucherRow.classList.add('hidden');
                    voucherEl.textContent = '-₱0.00';
                }
            }
            document.getElementById('cartTotal').textContent = `₱${finalTotal.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            // Listen for voucher input changes
            setTimeout(() => {
                const voucherInput = document.getElementById('voucherInput');
                if (voucherInput) {
                    voucherInput.oninput = () => {
                        // If the user edits the input after validation, clear voucher state and status
                        const val = voucherInput.value.trim().toUpperCase();
                        if (!appliedVoucher || val !== (appliedVoucher.code || '')) {
                            appliedVoucher = null;
                            const vs = document.getElementById('voucherStatus');
                            if (vs) vs.innerHTML = '';
                            const voucherRow = document.getElementById('cartVoucherRow');
                            if (voucherRow) voucherRow.classList.add('hidden');
                        }
                        openCart();
                    };
                }
            }, 0);
            document.getElementById('cartModal').classList.remove('hidden');
        }
        function removeFromCart(courseId) {
            const idx = cartCourses.indexOf(courseId);
            if (idx !== -1) {
                cartCourses.splice(idx, 1);
                openCart();
                updateCartCount();
                renderCourses(); // Re-render course grid to update button state
                try { persistCart(); } catch {}
                try { updateCartBar(); } catch {}
            }
        }
        // Format helpers
        function formatDateMDY(d){
            try {
                const dt = (d instanceof Date) ? d : new Date(d);
                if (isNaN(dt)) return '';
                const m = String(dt.getMonth()+1).padStart(2,'0');
                const day = String(dt.getDate()).padStart(2,'0');
                const y = dt.getFullYear();
                return `${m}/${day}/${y}`;
            } catch { return ''; }
        }
        function formatTimestampUS(d){
            try {
                const dt = (d instanceof Date) ? d : new Date(d);
                if (isNaN(dt)) return '';
                const mdy = formatDateMDY(dt);
                let h = dt.getHours();
                const min = String(dt.getMinutes()).padStart(2,'0');
                const ampm = h >= 12 ? 'PM' : 'AM';
                h = h % 12; if (h === 0) h = 12;
                const hh = String(h).padStart(2,'0');
                return `${mdy} ${hh}:${min} ${ampm}`;
            } catch { return ''; }
        }
        async function confirmRegistration() {
            try {
                // Guard: must be logged in and have items
                const profile = window.PAPSI_PROFILE || null;
                if (!profile || !profile.email) {
                    try { showToast('Please log in before confirming registration.', 'error'); } catch {}
                    return;
                }
                if (!Array.isArray(cartCourses) || cartCourses.length === 0) {
                    try { showToast('Your cart is empty.', 'info'); } catch {}
                    return;
                }

                const btn = document.getElementById('confirmRegistrationBtn');
                const prevText = btn?.textContent;
                setPending(btn, true, 'Submitting…');

                // Build trainings from cart
                const selected = (cartCourses||[])
                    .map(id => (allCourses||[]).find(c => c.id === id))
                    .filter(Boolean);
                // Requirement: remove dates in trainingtext and trainingjson when submitting
                const trainingtext = selected.map(c => c.title).join(' | ');
                const trainingjson = selected.map(c => ({ title: c.title }));

                // Compute totals, preserve voucher state for submission
                const { regularSum, baseDiscount, voucherDiscount, total } = computeCartTotals();

                // Derive profile fields (prefer current UI values when available)
                // Build fullname: First Name + Middle Initial + Last Name + Suffix (skip blanks)
                const first = String(profile.firstname || '').trim();
                const mi = String(profile.middleinitial || '').trim();
                const last = String(profile.lastname || '').trim();
                const suf = String(profile.suffix || '').trim();
                const fullname = [first, mi, last, suf].filter(Boolean).join(' ').replace(/\s+/g, ' ').trim();
                // Build nametext: concatenate name parts without spaces/periods and UPPERCASE
                const nametext = (first + mi + last + suf).replace(/[\.\s]/g, '').toUpperCase();
                const mobileRaw = (document.getElementById('mobileInput')?.value || profile.mobile || '').toString();
                const specializationVal = (typeof getSelectWithOtherValue === 'function') ? (getSelectWithOtherValue('specializationSelect','specializationOther') || profile.specialization || '') : (profile.specialization || '');

                const payload = {
                    timestamp: formatTimestampUS(new Date()),
                    email: profile.email || '',
                    id: profile.id || '',
                    title: profile.title || '',
                    firstname: profile.firstname || '',
                    middleinitial: profile.middleinitial || '',
                    lastname: profile.lastname || '',
                    suffix: profile.suffix || '',
                    fullname: fullname,
                    nametext: nametext,
                    mobile: mobileRaw.replace(/[^0-9]/g,'') || '',
                    specialization: specializationVal,
                    school: document.getElementById('schoolInput')?.value || profile.school || '',
                    type: document.getElementById('typeSelect')?.value || profile.type || '',
                    address: document.getElementById('addressTextarea')?.value || profile.address || '',
                    subtotal: regularSum,
                    discount: baseDiscount,
                    vouchercode: (appliedVoucher && appliedVoucher.code) ? appliedVoucher.code : 'none',
                    voucherdiscount: voucherDiscount,
                    total: total,
                    trainingtext: trainingtext,
                    trainingjson: trainingjson
                };

                // POST to Apps Script library with SH=Sheet1&func=cart (explicit per spec)
                const url = `${AUTH_BASE}?SH=Sheet1&func=cart`;
                const res = await fetch(url, {
                    method: 'POST',
                    // Use a simple request to avoid CORS preflight (OPTIONS)
                    headers: { 'Content-Type': 'text/plain; charset=UTF-8' },
                    body: JSON.stringify(payload)
                });
                const text = await res.text();

                if (!res.ok) {
                    try { showToast((text || 'Registration failed.'), 'error', 6000); } catch {}
                    setPending(btn, false, prevText || 'Confirm Registration');
                    return;
                }

                let message = '';
                try {
                    const data = JSON.parse(text);
                    message = data?.message || data?.status || data?.result || '';
                } catch {
                    message = text;
                }
                try { showToast((message || 'Registration submitted.').trim(), 'success', 6000); } catch {}
                // If backend indicates email dispatch, show a small success modal overlay
                try {
                    if (typeof message === 'string' && /Recorded and email dispatched\./i.test(message.trim())) {
                        if (typeof openRegistrationSuccessModal === 'function') {
                            openRegistrationSuccessModal(profile.email || '');
                        }
                    }
                } catch {}

                // Clear cart and update UI
                cartCourses = [];
                try { persistCart(); } catch {}
                try { renderCourses(); } catch {}
                try { updateCartCount(); } catch {}
                try { appliedVoucher = null; } catch {}
                try { closeCart(); } catch {}
                try { updateCartBar(); } catch {}
                // Route to My Learning with transient success banner
                try {
                    window.__showLearningSuccessBanner = true;
                    window.__learningSuccessMessage = (message && String(message).trim()) || 'Registration submitted successfully.';
                    if (typeof showPage === 'function') showPage('learning');
                } catch {}

                setPending(btn, false, prevText || 'Confirm Registration');
            } catch (err) {
                console.error('confirmRegistration error', err);
                try { showToast(err?.message || 'Network error. Please try again.', 'error', 6000); } catch {}
                const btn = document.getElementById('confirmRegistrationBtn');
                setPending(btn, false, 'Confirm Registration');
            }
        }

        function closeCart() {
            document.getElementById('cartModal').classList.add('hidden');
            // Reset voucher state when closing cart
            appliedVoucher = null;
            const vs = document.getElementById('voucherStatus');
            if (vs) vs.innerHTML = '';
            const discountRow = document.getElementById('cartDiscountRow');
            if (discountRow) discountRow.classList.add('hidden');
            const voucherRow = document.getElementById('cartVoucherRow');
            if (voucherRow) voucherRow.classList.add('hidden');
            // Mark modal as closed and refresh cart bar visibility
            try { CART_MODAL_OPEN = false; } catch {}
            try { updateCartBar(); } catch {}
        }

        // Validate voucher via Apps Script endpoint and apply discount
        async function validateVoucher() {
            const input = document.getElementById('voucherInput');
            const status = document.getElementById('voucherStatus');
            const code = (input?.value || '').trim().toUpperCase();
            if (!status) return;
            if (!code) {
                status.innerHTML = '<span class="text-red-600">Please enter a voucher code.</span>';
                appliedVoucher = null;
                openCart();
                return;
            }
            status.innerHTML = '<span class="text-gray-600">Validating voucher…</span>';

            // Build endpoint URL
            const base = 'https://script.google.com/macros/s/AKfycbz8awvt1aQpxA-7vfyp7WJRQLODyHdhVlaMfn7KsRnGIBaLaeQ_7ZYED4qI4kL0CpmXsw/exec';
            const params = new URLSearchParams({
                SH: 'voucher',
                func: 'voucher',
                code: code
            });
            const url = `${base}?${params.toString()}`;

            try {
                const res = await fetch(url, { method: 'GET' });
                const text = await res.text();
                try {
                    const data = JSON.parse(text);
                    // Expecting { code, percentage, date }
                    const pct = Number(data.percentage);
                    if (isNaN(pct) || pct <= 0) throw new Error('Invalid voucher percentage.');
                    appliedVoucher = { code: data.code || code, percentage: pct, date: data.date };
                    status.innerHTML = `<span class="text-green-700">Voucher applied: ${appliedVoucher.percentage}% off</span>`;
                    openCart();
                } catch (e) {
                    // Non-JSON: plain text responses like "Voucher Expired" or "Error: Invalid code"
                    const msg = (text || '').trim();
                    if (/expired/i.test(msg)) {
                        status.innerHTML = '<span class="text-red-600">Voucher expired.</span>';
                    } else if (/invalid/i.test(msg)) {
                        status.innerHTML = '<span class="text-red-600">Error: Invalid code.</span>';
                    } else {
                        status.innerHTML = `<span class=\"text-red-600\">${msg || 'Unable to validate voucher.'}</span>`;
                    }
                    appliedVoucher = null;
                    openCart();
                }
            } catch (err) {
                console.error('Voucher validation error:', err);
                status.innerHTML = `<span class=\"text-red-600\">${err.message || 'Network error validating voucher.'}</span>`;
                appliedVoucher = null;
                openCart();
            }
        }

        // Search and filter functionality for My Learning page
        function filterLearningCourses() {
            const searchTerm = document.getElementById('learningSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('learningCategoryFilter').value;
            const speakerFilter = document.getElementById('learningSpeakerFilter').value;
            const dateSort = document.getElementById('learningDateSort').value;
            const yearFilter = window.learningYearFilter || null; // numeric year or null

            // Filter courses from the user's learning list
            filteredLearningCourses = myLearning.filter(course => {
                const matchesSearch = !searchTerm || 
                    course.title.toLowerCase().includes(searchTerm) ||
                    course.instructor.toLowerCase().includes(searchTerm) ||
                    course.description.toLowerCase().includes(searchTerm);
                
                const matchesCategory = categoryFilter === 'all' || course.category === categoryFilter;
                const matchesSpeaker = speakerFilter === 'all' || course.instructor === speakerFilter;
                const matchesYear = !yearFilter || (course.date instanceof Date && !isNaN(course.date) && course.date.getFullYear() === yearFilter);
                return matchesSearch && matchesCategory && matchesSpeaker && matchesYear;
            });

            // Sort courses
            filteredLearningCourses.sort((a, b) => {
                if (dateSort === 'newest') {
                    return b.date - a.date;
                } else {
                    return a.date - b.date;
                }
            });

            learningCurrentPage = 1; // reset to first page on new filter
            renderLearningCourses();
            updateLearningCounters();
            renderLearningStats();
            try{ renderLearningFilterChips(); }catch{}
        }

        function renderLearningCourses() {
            const grid = document.getElementById('learningCoursesGrid');
            
            if (filteredLearningCourses.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.562M15 6.306a7.962 7.962 0 00-6 0m6 0V5a2 2 0 00-2-2H9a2 2 0 00-2 2v1.306m8 0V7a2 2 0 012 2v6.414l.293.293a1 1 0 001.414-1.414L16 12.586V11a2 2 0 00-2-2H8a2 2 0 00-2 2v1.586l-2.707 2.707a1 1 0 001.414 1.414L7 14.414V13a2 2 0 012-2h6a2 2 0 012 2z"/>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No courses found</h3>
                        <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter criteria.</p>
                    </div>
                `;
                return;
            }

            // Pagination slice
            const total = filteredLearningCourses.length;
            const totalPages = Math.ceil(total / learningPerPage) || 1;
            if (learningCurrentPage > totalPages) learningCurrentPage = totalPages;
            if (learningCurrentPage < 1) learningCurrentPage = 1;
            const start = (learningCurrentPage - 1) * learningPerPage;
            const end = start + learningPerPage;
            const pageItems = filteredLearningCourses.slice(start, end);

            grid.innerHTML = pageItems.map(course => {

                const hasVideo = !!(course.video && /https?:\/\//i.test(course.video));
                const hasModule = !!(course.module && /https?:\/\//i.test(course.module));
                const hasSlides = !!(course.presentation && /https?:\/\//i.test(course.presentation));
                const disCls = 'opacity-60 cursor-not-allowed';

                return `
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden card-hover">
                        <div class="relative bg-white overflow-hidden">
                            <img src="${course.image}" 
                                 alt="${course.title}" 
                                 class="block w-full h-auto object-contain training-image"
                                 loading="lazy" decoding="async"
                                 onclick="openImageViewer(this.src, this.alt)"
                                 onerror="this.src=''; this.alt='Image failed to load'; this.style.display='none';">
                            <div class="absolute top-2 left-2">
                                <span class="${categoryBadgeClasses(course.category)} px-2 py-1 rounded text-xs font-medium">${course.category || 'Other'}</span>
                            </div>
                            <div class="absolute left-2 right-2 bottom-2 bg-white rounded-md shadow px-3 py-2">
                                <div class="text-papsi-dark font-semibold text-sm">${course.title}</div>
                                <div class="text-gray-600 text-xs mt-0.5">${course.instructor}</div>
                            </div>
                            <div class="absolute bottom-2 right-2">
                                <div class="bg-white rounded px-2 py-1 shadow text-xs font-medium">${course.duration || ''}</div>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="flex space-x-2">
                                <button onclick="openCourseContent('video', '${course.id}')" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700 transition-colors flex items-center justify-center space-x-1 ${hasVideo ? '' : disCls}" ${hasVideo ? '' : 'disabled aria-disabled="true"'}>
                                    <span>📹</span>
                                    <span>Video</span>
                                </button>
                                <button onclick="openCourseContent('module', '${course.id}')" class="flex-1 bg-orange-600 text-white py-2 px-3 rounded text-sm hover:bg-orange-700 transition-colors flex items-center justify-center space-x-1 ${hasModule ? '' : disCls}" ${hasModule ? '' : 'disabled aria-disabled="true"'}>
                                    <span>📚</span>
                                    <span>Module</span>
                                </button>
                                <button onclick="openCourseContent('presentation', '${course.id}')" class="flex-1 bg-purple-600 text-white py-2 px-3 rounded text-sm hover:bg-purple-700 transition-colors flex items-center justify-center space-x-1 ${hasSlides ? '' : disCls}" ${hasSlides ? '' : 'disabled aria-disabled="true"'}>
                                    <span>📊</span>
                                    <span>Slides</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Pagination controls
            if (totalPages > 1) {
                grid.insertAdjacentHTML('beforeend', `
                    <div class="col-span-full w-full flex justify-center mt-6">
                        <div class="flex items-center space-x-4">
                            <button onclick="changeLearningPage(-1)" class="px-4 py-2 rounded border ${learningCurrentPage === 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" ${learningCurrentPage === 1 ? 'disabled' : ''}>Previous</button>
                            <span class="mx-2 text-sm">Page ${learningCurrentPage} of ${totalPages}</span>
                            <button onclick="changeLearningPage(1)" class="px-4 py-2 rounded border ${learningCurrentPage === totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-100'}" ${learningCurrentPage === totalPages ? 'disabled' : ''}>Next</button>
                        </div>
                    </div>
                `);
            }
            try{ renderLearningFilterChips(); }catch{}
        }

        function changeLearningPage(delta) {
            const totalPages = Math.ceil(filteredLearningCourses.length / learningPerPage) || 1;
            learningCurrentPage += delta;
            if (learningCurrentPage < 1) learningCurrentPage = 1;
            if (learningCurrentPage > totalPages) learningCurrentPage = totalPages;
            renderLearningCourses();
            updateLearningCounters();
        }

        function updateLearningCounters() {
            const searchTerm = document.getElementById('learningSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('learningCategoryFilter').value;
            const speakerFilter = document.getElementById('learningSpeakerFilter').value;
            
            // Calculate total available courses for current filters (including search)
            let totalAvailable = myLearning.filter(course => {
                const matchesSearch = !searchTerm || 
                    course.title.toLowerCase().includes(searchTerm) ||
                    course.instructor.toLowerCase().includes(searchTerm) ||
                    course.description.toLowerCase().includes(searchTerm);
                
                const matchesCategory = categoryFilter === 'all' || course.category === categoryFilter;
                const matchesSpeaker = speakerFilter === 'all' || course.instructor === speakerFilter;

                return matchesSearch && matchesCategory && matchesSpeaker;
            }).length;
            // Number shown on current page
            const start = (learningCurrentPage - 1) * learningPerPage;
            const end = Math.min(start + learningPerPage, filteredLearningCourses.length);
            const shownCourses = Math.max(0, end - start);
            
            // Update results counter
            document.getElementById('learningResultsCounter').textContent = `Showing ${shownCourses} of ${totalAvailable} courses`;
        }

        // Render active filter chips for My Learning
        function renderLearningFilterChips(){
            const chips = document.getElementById('learningFilterChips');
            const clearBtn = document.getElementById('learningClearFilters');
            if(!chips || !clearBtn) return;
            const search = document.getElementById('learningSearchInput');
            const category = document.getElementById('learningCategoryFilter');
            const speaker = document.getElementById('learningSpeakerFilter');
            const year = window.learningYearFilter || null;
            const sort = document.getElementById('learningDateSort');
            const items = [];
            if(search && search.value.trim()) items.push({ key:'search', label:`Search: ${search.value.trim()}` });
            if(category && category.value !== 'all') items.push({ key:'category', label:`Category: ${category.value}` });
            if(speaker && speaker.value !== 'all') items.push({ key:'speaker', label:`Speaker: ${speaker.value}` });
            if(year) items.push({ key:'year', label:`Year: ${year}` });
            if(sort && sort.value !== 'newest') items.push({ key:'sort', label:`Sort: Oldest` });
            if(!items.length){ chips.classList.add('hidden'); clearBtn.classList.add('hidden'); chips.innerHTML=''; return; }
            chips.classList.remove('hidden'); clearBtn.classList.remove('hidden');
            chips.innerHTML = items.map(it => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-50 text-papsi-green text-xs font-medium" data-key="${it.key}">${it.label}<button type="button" class="ml-1 text-papsi-green/80 hover:text-papsi-green" aria-label="Remove ${it.key}" data-remove="${it.key}">×</button></span>`).join('');
            chips.querySelectorAll('[data-remove]').forEach(btn=>{
                btn.addEventListener('click',()=>{
                    const key = btn.getAttribute('data-remove');
                    if(key==='search'){ if(search){ search.value=''; const cs=document.getElementById('clearLearningSearch'); if(cs) cs.classList.add('hidden'); } }
                    if(key==='category'){ if(category){ category.value='all'; } }
                    if(key==='speaker'){ if(speaker){ speaker.value='all'; } }
                    if(key==='year'){ window.learningYearFilter = null; }
                    if(key==='sort'){ if(sort){ sort.value='newest'; } }
                    filterLearningCourses();
                    try{ window.__updateFilterActiveCounts(); }catch{}
                });
            });
        }

        // Render dynamic statistics header for My Learning
        function renderLearningStats() {
            const grid = document.getElementById('learningStatsGrid');
            const yearBars = document.getElementById('learningYearBars');
            if (!grid) return;
            const total = myLearning.length;
            const categories = myLearning.reduce((acc, c) => {
                const key = c.category || 'Other';
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});
            const totalHours = myLearning.reduce((sum, c) => sum + (c.hoursNum || 0), 0);

            const parts = [
                `<div class="text-center"><div class="text-2xl font-bold text-papsi-green">${total}</div><div class="text-sm text-gray-600">Total Sessions</div></div>`,
                `<div class="text-center"><div class="text-2xl font-bold text-papsi-dark">${totalHours}</div><div class="text-sm text-gray-600">Total Hours</div></div>`,
                `<div class="col-span-full text-[11px] text-gray-600 mt-1">Click a category to filter courses.</div>`
            ];
            Object.entries(categories)
                .sort((a,b)=> a[0].localeCompare(b[0]))
                .forEach(([cat, count]) => {
                    const color = categoryStatsText(cat);
                    const catEnc = encodeURIComponent(cat);
                    parts.push(`<button type="button" data-cat="${catEnc}" class="text-center group rounded p-2 hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-papsi-green/40" title="Filter by ${escapeHtml(cat)}"><div class="text-xl font-semibold ${color} group-hover:text-papsi-green">${count}</div><div class="text-sm text-gray-600">${escapeHtml(cat)}</div></button>`);
                });
            grid.innerHTML = parts.join('');

            // Make category tiles clickable to apply category filter
            grid.querySelectorAll('[data-cat]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const raw = btn.getAttribute('data-cat') || '';
                    const val = decodeURIComponent(raw);
                    const sel = document.getElementById('learningCategoryFilter');
                    if (sel) {
                        const opts = Array.from(sel.options).map(o => o.value);
                        sel.value = opts.includes(val) ? val : 'all';
                    }
                    filterLearningCourses();
                    try { window.__updateFilterActiveCounts(); } catch {}
                    // Optionally scroll to list
                    const gridEl = document.getElementById('learningCoursesGrid');
                    try { gridEl?.scrollIntoView({behavior:'smooth', block:'start'}); } catch {}
                });
            });

            // Year mini bar indicators
            if (yearBars) {
                const yearCounts = myLearning.reduce((acc, c) => {
                    if (c.date instanceof Date && !isNaN(c.date)) {
                        const y = c.date.getFullYear();
                        acc[y] = (acc[y] || 0) + 1;
                    }
                    return acc;
                }, {});
                const years = Object.keys(yearCounts).map(y=>parseInt(y,10)).sort((a,b)=> a-b); // oldest -> newest for sparkline
                if (!years.length) {
                    yearBars.innerHTML = '';
                    yearBars.classList.add('hidden');
                } else {
                    yearBars.classList.remove('hidden');
                    const maxVal = Math.max(...years.map(y => yearCounts[y]));
                    const grandTotal = years.reduce((s,y)=>s+yearCounts[y],0) || 1;
                    // Build sparkline points (cumulative)
                    let cumulative = 0;
                    const sparkWidth = 160;
                    const sparkHeight = 38;
                    const pts = years.map((y, idx) => {
                        cumulative += yearCounts[y];
                        const x = (idx/(years.length-1||1))*sparkWidth;
                        const yPos = sparkHeight - (cumulative / grandTotal)*sparkHeight;
                        return `${x.toFixed(1)},${yPos.toFixed(1)}`;
                    }).join(' ');
                    const sparkline = `<div class=\"mt-4 mb-2\"><div class=\"flex items-center justify-between mb-1\"><span class=\"text-xs font-medium text-gray-600\">Cumulative Growth</span><span class=\"text-[10px] text-gray-500\">${grandTotal} total</span></div><svg viewBox=\"0 0 ${sparkWidth} ${sparkHeight}\" class=\"w-full max-w-xs h-10 text-papsi-green/70\"><polyline fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" points=\"${pts}\" stroke-linejoin=\"round\" stroke-linecap=\"round\" /></svg><div class=\"text-[11px] text-gray-600 mt-1\">Click a year to filter courses.</div></div>`;

                    const selected = window.learningYearFilter || null;
                    const barsHtml = years.slice().reverse().map(y => { // reverse to show newest first visually under sparkline
                        const count = yearCounts[y];
                        const pct = maxVal ? (count / maxVal) * 100 : 0;
                        const share = ((count / grandTotal) * 100).toFixed(1);
                        const active = selected === y;
                        return `<button type="button" data-year="${y}" class="group w-full flex items-center gap-3 text-left year-bar-item ${active?'ring-1 ring-papsi-green/60 bg-green-50':''}" title="${count} course${count!==1?'s':''} in ${y} (${share}% of total)">
    <div class="w-14 text-right text-xs ${active?'text-papsi-green font-semibold':'text-gray-600 font-medium'}">${y}</div>
    <div class="relative flex-1 h-3 rounded bg-gray-100 overflow-hidden">
        <div class="h-full bg-gradient-to-r from-papsi-green to-emerald-500 origin-left scale-x-0 bar-grow" style="width:${pct}%;"></div>
        <span class="absolute inset-0 flex items-center justify-center text-[10px] font-semibold text-white/90 mix-blend-difference pointer-events-none">${count}</span>
        <span class="absolute -right-1 -top-4 text-[10px] text-gray-500 group-hover:text-papsi-green transition">${share}%</span>
    </div>
</button>`;
                    }).join('');

                    yearBars.innerHTML = sparkline + barsHtml + `<div class="mt-2"><button type="button" id="resetYearFilterBtn" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 ${selected? '':'opacity-40 cursor-default'}" ${selected? '':'disabled'}>All Years</button></div>`;

                    // Animate bars
                    requestAnimationFrame(()=>{
                        yearBars.querySelectorAll('.bar-grow').forEach(el=>{
                            el.classList.add('animate-width');
                        });
                    });

                    // Bind click handlers
                    yearBars.querySelectorAll('[data-year]').forEach(btn=>{
                        btn.addEventListener('click', () => {
                            const y = parseInt(btn.getAttribute('data-year'),10);
                            if (window.learningYearFilter === y) {
                                window.learningYearFilter = null; // toggle off
                            } else {
                                window.learningYearFilter = y;
                            }
                            filterLearningCourses();
                        });
                    });
                    const resetBtn = document.getElementById('resetYearFilterBtn');
                    if (resetBtn) resetBtn.addEventListener('click', () => {
                        if (window.learningYearFilter) {
                            window.learningYearFilter = null;
                            filterLearningCourses();
                        }
                    });
                }
            }
        }

        // --- Learning Stats Visibility Toggle ---
        const LEARNING_STATS_VISIBLE_KEY = 'PAPSI_LEARNING_STATS_VISIBLE';

        function applyLearningStatsVisibility() {
            const statsSection = document.getElementById('learningStatsSection');
            const toggleBtn = document.getElementById('learningStatsToggle');
            if (!statsSection || !toggleBtn) return;
            const visible = (localStorage.getItem(LEARNING_STATS_VISIBLE_KEY) ?? 'false') === 'true';
            statsSection.classList.toggle('hidden', !visible);
            toggleBtn.setAttribute('aria-expanded', String(visible));
                    toggleBtn.setAttribute('aria-pressed', String(visible));
                    const label = toggleBtn.querySelector('span');
                    if (label) label.textContent = visible ? 'Hide Stats' : 'Show Stats';
                    const icon = toggleBtn.querySelector('svg');
                    if (icon) { icon.classList.toggle('text-papsi-green', visible); icon.classList.toggle('text-gray-600', !visible); }
        }

        function toggleLearningStats() {
            const current = (localStorage.getItem(LEARNING_STATS_VISIBLE_KEY) ?? 'false') === 'true';
            localStorage.setItem(LEARNING_STATS_VISIBLE_KEY, String(!current));
            applyLearningStatsVisibility();
        }

        function initLearningStatsVisibility() {
            const toggleBtn = document.getElementById('learningStatsToggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleLearningStats);
            }
            applyLearningStatsVisibility();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initLearningStatsVisibility();
        });

        // --- Training Stats (Hub) ---
        const TRAINING_STATS_VISIBLE_KEY = 'PAPSI_TRAINING_STATS_VISIBLE';

        function applyTrainingStatsVisibility() {
            const statsSection = document.getElementById('trainingStatsSection');
            const toggleBtn = document.getElementById('trainingStatsToggle');
            if (!statsSection || !toggleBtn) return;
            const visible = (localStorage.getItem(TRAINING_STATS_VISIBLE_KEY) ?? 'false') === 'true';
            statsSection.classList.toggle('hidden', !visible);
            toggleBtn.setAttribute('aria-expanded', String(visible));
                    toggleBtn.setAttribute('aria-pressed', String(visible));
                    const label = toggleBtn.querySelector('span');
                    if (label) label.textContent = visible ? 'Hide Stats' : 'Show Stats';
                    const icon = toggleBtn.querySelector('svg');
                    if (icon) { icon.classList.toggle('text-papsi-green', visible); icon.classList.toggle('text-gray-600', !visible); }
        }

        function toggleTrainingStats() {
            const current = (localStorage.getItem(TRAINING_STATS_VISIBLE_KEY) ?? 'false') === 'true';
            localStorage.setItem(TRAINING_STATS_VISIBLE_KEY, String(!current));
            applyTrainingStatsVisibility();
        }

        function initTrainingStatsVisibility() {
            const toggleBtn = document.getElementById('trainingStatsToggle');
            if (toggleBtn) toggleBtn.addEventListener('click', toggleTrainingStats);
            applyTrainingStatsVisibility();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initTrainingStatsVisibility();
        });

        function renderTrainingStats() {
            const grid = document.getElementById('trainingStatsGrid');
            const yearBars = document.getElementById('trainingYearBars');
            if (!grid) return;
            const total = allCourses.length;
            const categories = allCourses.reduce((acc, c) => {
                const key = c.category || 'Other';
                acc[key] = (acc[key] || 0) + 1; return acc;
            }, {});
            const totalHours = allCourses.reduce((sum, c) => sum + (c.hoursNum || 0), 0);
            const parts = [
                `<div class="text-center"><div class="text-2xl font-bold text-papsi-green">${total}</div><div class="text-sm text-gray-600">Total Courses</div></div>`,
                `<div class="text-center"><div class="text-2xl font-bold text-papsi-dark">${totalHours}</div><div class="text-sm text-gray-600">Total Hours</div></div>`,
                `<div class="col-span-full text-[11px] text-gray-600 mt-1">Click a category to filter courses.</div>`
            ];
            Object.entries(categories).sort((a,b)=> a[0].localeCompare(b[0])).forEach(([cat,count])=>{
                const color = categoryStatsText(cat);
                const catEnc = encodeURIComponent(cat);
                parts.push(`<button type=\"button\" data-cat=\"${catEnc}\" class=\"text-center group rounded p-2 hover:bg-green-50 focus:outline-none focus:ring-2 focus:ring-papsi-green/40\" title=\"Filter by ${escapeHtml(cat)}\"><div class=\"text-xl font-semibold ${color} group-hover:text-papsi-green\">${count}</div><div class=\"text-sm text-gray-600\">${escapeHtml(cat)}</div></button>`)
            });
            grid.innerHTML = parts.join('');

            // Click to filter by category in Training Center
            grid.querySelectorAll('[data-cat]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const raw = btn.getAttribute('data-cat') || '';
                    const val = decodeURIComponent(raw);
                    const sel = document.getElementById('categoryFilter');
                    if (sel) {
                        const opts = Array.from(sel.options).map(o => o.value);
                        sel.value = opts.includes(val) ? val : 'all';
                    }
                    filterCourses();
                    try { window.__updateFilterActiveCounts(); } catch {}
                    const gridEl = document.getElementById('coursesGrid');
                    try { gridEl?.scrollIntoView({behavior:'smooth', block:'start'}); } catch {}
                });
            });

            if (yearBars) {
                const yearCounts = allCourses.reduce((acc,c)=>{
                    if (c.date instanceof Date && !isNaN(c.date)) {
                        const y = c.date.getFullYear();
                        acc[y] = (acc[y]||0)+1;
                    }
                    return acc;
                }, {});
                const years = Object.keys(yearCounts).map(y=>parseInt(y,10)).sort((a,b)=> a-b);
                if (!years.length) {
                    yearBars.innerHTML='';
                    yearBars.classList.add('hidden');
                } else {
                    yearBars.classList.remove('hidden');
                    const maxVal = Math.max(...years.map(y=>yearCounts[y]));
                    const grandTotal = years.reduce((s,y)=> s+yearCounts[y],0) || 1;
                    let cumulative = 0; const sparkWidth=160; const sparkHeight=38;
                    const pts = years.map((y,i)=>{ cumulative+=yearCounts[y]; const x=(i/(years.length-1||1))*sparkWidth; const yPos=sparkHeight-(cumulative/grandTotal)*sparkHeight; return `${x.toFixed(1)},${yPos.toFixed(1)}`; }).join(' ');
                    const sparkline = `<div class=\"mt-4 mb-2\"><div class=\"flex items-center justify-between mb-1\"><span class=\"text-xs font-medium text-gray-600\">Cumulative Growth</span><span class=\"text-[10px] text-gray-500\">${grandTotal} total</span></div><svg viewBox=\"0 0 ${sparkWidth} ${sparkHeight}\" class=\"w-full max-w-xs h-10 text-papsi-green/70\"><polyline fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" points=\"${pts}\" stroke-linejoin=\"round\" stroke-linecap=\"round\" /></svg><div class=\"text-[11px] text-gray-600 mt-1\">Click a year to filter courses.</div></div>`;
                    const selected = window.trainingYearFilter || null;
                    const barsHtml = years.slice().reverse().map(y=>{
                        const count=yearCounts[y];
                        const pct = maxVal ? (count/maxVal)*100:0;
                        const share = ((count/grandTotal)*100).toFixed(1);
                        const active = selected===y;
                        return `<button type=\"button\" data-year=\"${y}\" class=\"group w-full flex items-center gap-3 text-left year-bar-item ${active?'ring-1 ring-papsi-green/60 bg-green-50':''}\" title=\"${count} course${count!==1?'s':''} in ${y} (${share}% of total)\"><div class=\"w-14 text-right text-xs ${active?'text-papsi-green font-semibold':'text-gray-600 font-medium'}\">${y}</div><div class=\"relative flex-1 h-3 rounded bg-gray-100 overflow-hidden\"><div class=\"h-full bg-gradient-to-r from-papsi-green to-emerald-500 origin-left scale-x-0 bar-grow\" style=\"width:${pct}%;\"></div><span class=\"absolute inset-0 flex items-center justify-center text-[10px] font-semibold text-white/90 mix-blend-difference pointer-events-none\">${count}</span><span class=\"absolute -right-1 -top-4 text-[10px] text-gray-500 group-hover:text-papsi-green transition\">${share}%</span></div></button>`;
                    }).join('');
                    yearBars.innerHTML = sparkline + barsHtml + `<div class=\"mt-2\"><button type=\"button\" id=\"resetTrainingYearFilterBtn\" class=\"text-xs px-2 py-1 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 ${selected?'':'opacity-40 cursor-default'}\" ${selected?'':'disabled'}>All Years</button></div>`;
                    requestAnimationFrame(()=>{ yearBars.querySelectorAll('.bar-grow').forEach(el=> el.classList.add('animate-width')); });
                    yearBars.querySelectorAll('[data-year]').forEach(btn=>{
                        btn.addEventListener('click',()=>{
                            const y = parseInt(btn.getAttribute('data-year'),10);
                            if (window.trainingYearFilter === y) { window.trainingYearFilter = null; } else { window.trainingYearFilter = y; }
                            filterCourses();
                        });
                    });
                    const resetBtn = document.getElementById('resetTrainingYearFilterBtn');
                    if (resetBtn) resetBtn.addEventListener('click',()=>{ if (window.trainingYearFilter) { window.trainingYearFilter=null; filterCourses(); }});
                }
            }
        }

        function clearLearningSearch() {
            document.getElementById('learningSearchInput').value = '';
            document.getElementById('clearLearningSearch').classList.add('hidden');
            learningCurrentPage = 1;
            filterLearningCourses();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.add('hidden');
            filterCourses();
        }

        // Event listeners for search and filters
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const clearBtn = document.getElementById('clearSearch');
            if (e.target.value) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            filterCourses();
        });

        document.getElementById('categoryFilter').addEventListener('change', filterCourses);
        document.getElementById('speakerFilter').addEventListener('change', filterCourses);
        document.getElementById('dateSort').addEventListener('change', filterCourses);
        document.getElementById('clearSearch').addEventListener('click', clearSearch);

        // Event listeners for My Learning page search and filters
        document.getElementById('learningSearchInput').addEventListener('input', function(e) {
            const clearBtn = document.getElementById('clearLearningSearch');
            if (e.target.value) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            filterLearningCourses();
        });

        document.getElementById('learningCategoryFilter').addEventListener('change', filterLearningCourses);
        document.getElementById('learningSpeakerFilter').addEventListener('change', filterLearningCourses);
        document.getElementById('learningDateSort').addEventListener('change', filterLearningCourses);
        document.getElementById('clearLearningSearch').addEventListener('click', clearLearningSearch);

        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            
            // Remove active class from all buttons
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected page
            document.getElementById(page + '-page').classList.remove('hidden');
            // Track active page for cart bar logic
            window.__currentPage = page;
            
            // Add active class to selected button
            const activeBtn = document.getElementById(page + '-btn');
            activeBtn.classList.add('active-tab');
            activeBtn.classList.remove('text-gray-500');

            // Initialize courses grid if hub page is shown
            if (page === 'hub') {
                renderCourses();
                updateCounters();
                try { renderTrainingStats(); applyTrainingStatsVisibility(); } catch {}
                try { updateCartBar(); } catch {}
            }

            // Initialize learning courses grid if learning page is shown
            if (page === 'learning') {
                // Use canonical pipeline to apply current filters and default sort
                filterLearningCourses();
                // Ensure stats visibility preference is applied when entering the page
                try { applyLearningStatsVisibility(); } catch {}
                // If a post-registration flag is set, show success banner briefly
                try {
                    if (window.__showLearningSuccessBanner) {
                        const b = document.getElementById('learningSuccessBanner');
                        const t = document.getElementById('learningSuccessBannerText');
                        if (b) {
                            b.classList.remove('hidden');
                            if (t && typeof window.__learningSuccessMessage === 'string') t.textContent = window.__learningSuccessMessage;
                            // Hide after 4 seconds
                            setTimeout(() => { b.classList.add('hidden'); }, 4000);
                        }
                        // Reset flag
                        window.__showLearningSuccessBanner = false;
                        window.__learningSuccessMessage = '';
                    }
                } catch {}
            }

            // Always refresh cart bar visibility after any navigation
            try { updateCartBar(); } catch {}
        }

        function openImageViewer(src, alt) {
            const viewer = document.getElementById('imageViewer');
            const image = document.getElementById('viewerImage');
            
            image.src = src;
            image.alt = alt;
            viewer.classList.remove('hidden');
            
            // Reset zoom and position
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
            
            // Prevent body scroll when viewer is open
            document.body.style.overflow = 'hidden';
            try { updateCartBar(); } catch {}
        }

        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            viewer.classList.add('hidden');
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
            try { updateCartBar(); } catch {}
        }

    let aboutCourseId = null;
    function showAbout(courseId) {
            aboutCourseId = courseId;
            const modal = document.getElementById('aboutModal');
            const title = document.getElementById('aboutTitle');
            const content = document.getElementById('aboutContent');
            // Find course by id in allCourses or filteredCourses
            const course = allCourses.find(c => c.id === courseId) || filteredCourses.find(c => c.id === courseId);
            if (!course) return;
            title.textContent = course.title;
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-papsi-dark mb-2">Speaker</h4>
                        <p class="text-gray-600">${course.instructor || course.speaker || ''}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-papsi-dark mb-2">Duration</h4>
                            <p class="text-gray-600">${course.duration || (course.hours ? course.hours + ' hours' : '')}</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-papsi-dark mb-2">Price</h4>
                            <div class="flex items-center space-x-2">
                                <p class="text-papsi-gold font-bold text-lg">${course.price || ''}</p>
                                ${course.originalPrice ? `<span class=\"text-gray-400 line-through text-sm\">${course.originalPrice}</span>` : ''}
                                ${(course.originalPrice && course.originalPrice !== course.price) ? `<span class=\"bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-medium\">Discount</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-papsi-dark mb-2">About</h4>
                        <p class="text-gray-600">${course.description || course.about || ''}</p>
                    </div>
                </div>
            `;
            // Update Register Now button state
            setTimeout(() => {
                const btn = document.getElementById('aboutRegisterBtn');
                if (btn) {
                    if (isInCart(courseId)) {
                        btn.textContent = 'Added to Cart';
                        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                        btn.classList.remove('bg-papsi-green', 'hover:bg-green-700');
                        btn.disabled = true;
                    } else {
                        btn.textContent = 'Register Now';
                        btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                        btn.classList.add('bg-papsi-green', 'hover:bg-green-700');
                        btn.disabled = false;
                    }
                }
            }, 0);
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            try { updateCartBar(); } catch {}
        }

        function closeAbout() {
            const modal = document.getElementById('aboutModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            try { updateCartBar(); } catch {}
        }

    let audioCourseId = null;
    function playAudio(courseId) {
            audioCourseId = courseId;
            const modal = document.getElementById('audioModal');
            const title = document.getElementById('audioTitle');
            const description = document.getElementById('audioDescription');
            const audioContent = document.getElementById('audioContent');
            // Find course by id in allCourses or filteredCourses
            const course = allCourses.find(c => c.id === courseId) || filteredCourses.find(c => c.id === courseId);
            if (!course) return;
            title.textContent = `${course.title} - Audio Preview`;

            // Clear previous content
            audioContent.innerHTML = '';

            const p = document.createElement('p');
            p.className = 'text-gray-600 text-sm';
            p.textContent = 'Listen to a preview.';
            audioContent.appendChild(p);

            if (course.audio && typeof course.audio === 'string' && /^https?:\/\//i.test(course.audio)) {
                const audio = document.createElement('audio');
                audio.id = 'courseAudioPlayer';
                audio.controls = true;
                audio.style.width = '100%';
                audio.style.marginTop = '1rem';
                audio.src = course.audio;
                audio.preload = 'none';
                audio.addEventListener('error', () => {
                    const err = document.createElement('div');
                    err.className = 'text-red-500 mt-2';
                    err.textContent = 'Failed to load audio preview.';
                    audio.replaceWith(err);
                });
                audioContent.appendChild(audio);
                // Try autoplay; some browsers block it, so ignore errors
                setTimeout(() => { try { audio.play(); } catch(_) {} }, 250);
            } else {
                const warn = document.createElement('div');
                warn.className = 'text-red-500 mt-2';
                warn.textContent = 'No audio preview available.';
                audioContent.appendChild(warn);
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            try { updateCartBar(); } catch {}
        }

// Move these out of the modal functions so they are global
function aboutRegisterNow() {
    if (aboutCourseId && !isInCart(aboutCourseId)) {
        addToCart(aboutCourseId);
        showAbout(aboutCourseId);
    }
}

function audioRegisterNow() {
    if (audioCourseId && !isInCart(audioCourseId)) {
        addToCart(audioCourseId);
        playAudio(audioCourseId);
    }
}

        function closeAudio() {
            const modal = document.getElementById('audioModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            // Stop audio element if present
            const el = document.getElementById('courseAudioPlayer');
            if (el && !el.paused) {
                try { el.pause(); el.currentTime = 0; } catch {}
            }
            try { updateCartBar(); } catch {}
        }

        function toggleAudio() {
            audioPlaying = !audioPlaying;
            
            if (audioPlaying) {
                // Start audio simulation
                audioInterval = setInterval(() => {
                    audioProgress += 1;
                    if (audioProgress >= 150) { // 2:30 duration
                        audioProgress = 150;
                        audioPlaying = false;
                        clearInterval(audioInterval);
                    }
                    updateAudioUI();
                }, 1000);
            } else {
                // Pause audio
                clearInterval(audioInterval);
            }
            
            updateAudioUI();
        }

        function updateAudioUI() {
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');
            const currentTime = document.getElementById('currentTime');
            const progressBar = document.getElementById('progressBar');
            
            if (audioPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            }
            
            // Update time display
            const minutes = Math.floor(audioProgress / 60);
            const seconds = audioProgress % 60;
            currentTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar
            const progressPercent = (audioProgress / 150) * 100;
            progressBar.style.width = `${progressPercent}%`;
        }

        function seekAudio(event) {
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const progressPercent = (clickX / rect.width) * 100;
            
            audioProgress = Math.floor((progressPercent / 100) * 150);
            updateAudioUI();
        }

        function setVolume(value) {
            // Volume control simulation
            console.log('Volume set to:', value);
        }

        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 5);
            updateImageTransform();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.5);
            updateImageTransform();
        }

        function resetZoom() {
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
        }

        function updateImageTransform() {
            const image = document.getElementById('viewerImage');
            image.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
        }

        // Mouse drag functionality
        document.getElementById('imageContainer').addEventListener('mousedown', function(e) {
            if (currentZoom > 1) {
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging && currentZoom > 1) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateImageTransform();
            }
        });

        document.addEventListener('mouseup', function() {
            isDragging = false;
        });

        // Touch drag functionality for mobile
        document.getElementById('imageContainer').addEventListener('touchstart', function(e) {
            if (currentZoom > 1 && e.touches.length === 1) {
                isDragging = true;
                startX = e.touches[0].clientX - translateX;
                startY = e.touches[0].clientY - translateY;
                e.preventDefault();
            }
        });

        document.addEventListener('touchmove', function(e) {
            if (isDragging && currentZoom > 1 && e.touches.length === 1) {
                translateX = e.touches[0].clientX - startX;
                translateY = e.touches[0].clientY - startY;
                updateImageTransform();
                e.preventDefault();
            }
        });

        document.addEventListener('touchend', function() {
            isDragging = false;
        });

        // Mouse wheel zoom
        document.getElementById('imageContainer').addEventListener('wheel', function(e) {
            e.preventDefault();
            if (e.deltaY < 0) {
                zoomIn();
            } else {
                zoomOut();
            }
        });

        // Close modals when clicking outside
        document.getElementById('imageViewer').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageViewer();
            }
        });

        document.getElementById('aboutModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAbout();
            }
        });

        document.getElementById('audioModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAudio();
            }
        });

        // Close Calendar when clicking on overlay
        document.getElementById('calendarModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCalendarModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            const imageViewer = document.getElementById('imageViewer');
            const aboutModal = document.getElementById('aboutModal');
            const audioModal = document.getElementById('audioModal');
            const calendarModal = document.getElementById('calendarModal');
            const verifyModal = document.getElementById('verifyModal');
            
            if (!imageViewer.classList.contains('hidden')) {
                switch(e.key) {
                    case 'Escape':
                        closeImageViewer();
                        break;
                    case '+':
                    case '=':
                        zoomIn();
                        break;
                    case '-':
                        zoomOut();
                        break;
                    case '0':
                        resetZoom();
                        break;
                }
            } else if (!aboutModal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeAbout();
                }
            } else if (!audioModal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeAudio();
                } else if (e.key === ' ') {
                    // Space toggles the real audio element if present
                    const el = document.getElementById('courseAudioPlayer');
                    if (el) {
                        e.preventDefault();
                        try { el.paused ? el.play() : el.pause(); } catch {}
                    }
                }
            } else if (!calendarModal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeCalendarModal();
                }
            } else if (!verifyModal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeVerifyModal();
                } else if (e.key === 'Enter') {
                    // Trigger verification on Enter for convenience
                    verifyCertificate();
                }
            }
        });

        // Wire toggles for select-with-Other on Profile page and handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Helper: format YYYY-MM-DD -> MM/DD/YYYY for update endpoint
            function formatDateForUpdate(dateVal) {
                if (!dateVal) return '';
                try {
                    const s = String(dateVal);
                    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                    if (m) return `${m[2]}/${m[3]}/${m[1]}`;
                    const d = new Date(s);
                    if (!isNaN(d)) {
                        const mm = String(d.getMonth() + 1).padStart(2, '0');
                        const dd = String(d.getDate()).padStart(2, '0');
                        const yy = d.getFullYear();
                        return `${mm}/${dd}/${yy}`;
                    }
                } catch {}
                return String(dateVal);
            }
            const pairs = [
                ['profileTitle','profileTitleOther'],
                ['positionSelect','positionOther'],
                ['specializationSelect','specializationOther']
            ];
            pairs.forEach(([selId, otherId]) => {
                const sel = document.getElementById(selId);
                const other = document.getElementById(otherId);
                if (!sel || !other) return;
                sel.addEventListener('change', function() {
                    if (sel.value === 'Other') {
                        other.classList.remove('hidden');
                        sel.setAttribute('aria-expanded', 'true');
                        setTimeout(() => { try { other.focus(); } catch {} }, 0);
                    } else {
                        other.classList.add('hidden');
                        other.value = '';
                        sel.setAttribute('aria-expanded', 'false');
                    }
                });
            });

            const formEl = document.querySelector('#profile-page form');
            if (formEl) {
                formEl.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    // Pull saved profile for id/email/password fallbacks
                    let saved = null;
                    try { saved = JSON.parse(localStorage.getItem('PAPSI_PROFILE') || 'null'); } catch {}

                    const email = (document.getElementById('emailInput')?.value || saved?.email || '').trim();
                    const pwdInput = (document.getElementById('passwordInput')?.value || '').trim();
                    const password = (pwdInput && pwdInput !== '********') ? pwdInput : (saved?.password || '');
                    const idVal = (saved?.id || '').toString().trim();

                    const payload = {
                        email,
                        password,
                        id: idVal,
                        title: getSelectWithOtherValue('profileTitle','profileTitleOther'),
                        birthdate: formatDateForUpdate(document.getElementById('birthDateInput')?.value || saved?.birthdate || ''),
                        mobile: (document.getElementById('mobileInput')?.value || '').trim(),
                        school: (document.getElementById('schoolInput')?.value || '').trim(),
                        type: (document.getElementById('typeSelect')?.value || '').trim(),
                        address: (document.getElementById('addressTextarea')?.value || '').trim(),
                        position: getSelectWithOtherValue('positionSelect','positionOther'),
                        specialization: getSelectWithOtherValue('specializationSelect','specializationOther'),
                        about: (document.getElementById('aboutTextarea')?.value || '').trim(),
                        researchinterests: (document.getElementById('researchTextarea')?.value || '').trim(),
                        publications: (document.getElementById('publicationsTextarea')?.value || '').trim()
                    };

                    if (!email) { try { showToast('Email is required', 'error'); } catch {} return; }
                    if (!idVal) { try { showToast('PAPSI ID is missing in profile', 'error'); } catch {} return; }

                    const url = buildAuthUrl('update', payload);

                    const submitBtn = e.submitter || formEl.querySelector('button[type="submit"]');
                    const prevBtnText = submitBtn?.textContent || 'Save Changes';
                    setPending(submitBtn, true, 'Saving…');

                    try {
                        const res = await fetch(url, { method: 'GET' });
                        const text = await res.text();

                        if (text.trim() === 'Error: Update Unsuccessful') {
                            try { showToast('Error: Update Unsuccessful', 'error'); } catch {}
                            return;
                        }

                        let profile = null;
                        try {
                            const data = JSON.parse(text);
                            profile = normalizeServerProfile(data?.profile || data || null);
                        } catch {
                            try { showToast(text || 'Update failed.', 'error'); } catch {}
                            return;
                        }

                        if (!profile || typeof profile !== 'object') {
                            try { showToast('Update failed: invalid response.', 'error'); } catch {}
                            return;
                        }

                        try { localStorage.setItem('PAPSI_PROFILE', JSON.stringify(profile)); } catch {}
                        try { window.PAPSI_PROFILE = profile; } catch {}
                        try { if (typeof setProfile === 'function') setProfile(profile); } catch {}
                        try { showToast('Update Successful', 'success'); } catch {}
                    } catch (err) {
                        try { showToast(err?.message || 'Unable to update profile.', 'error'); } catch {}
                    } finally {
                        setPending(submitBtn, false, prevBtnText);
                    }
                });
            }
        });

        // Handle course content access using myLearning links
        function openCourseContent(contentType, courseId) {
            const course = myLearning.find(c => c.id === courseId);
            if (!course) return;
            let url = '';
            if (contentType === 'video') url = course.video;
            else if (contentType === 'module') url = course.module;
            else if (contentType === 'presentation') url = course.presentation;
            if (!url || !/^https?:\/\//i.test(url)) {
                // Graceful fallback: do nothing if disabled, but keep for safety
                return;
            }
            if (contentType === 'video') {
                openVideoPlayer(url, course.title || 'Video');
                return;
            }
            if (contentType === 'presentation') {
                openSlidesViewer(url, course.title || 'Slides');
                return;
            }
            if (contentType === 'module') {
                openModulesViewer(url, course.title || 'Modules');
                return;
            }
            try { window.open(url, '_blank', 'noopener'); } catch (_) { location.href = url; }
        }

        // Handle enrollment buttons
        document.addEventListener('click', function(e) {
            if (e.target.textContent === 'Register Now') {
                alert('Registration process initiated! You will be redirected to payment.');
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            const hubCartBtn = document.getElementById('cartButton');
            if (hubCartBtn) hubCartBtn.addEventListener('click', openCart);
            const cartModal = document.getElementById('cartModal');
            // Note: Escape handling for cart is managed in the keydown listener above
            loadAnnouncements();
            loadTrainingCourses();
            renderLearningCourses();
            updateLearningCounters();
            if (!window.__currentPage) window.__currentPage = 'home';
            try { updateCartBar(); } catch {}

            // Wire Enter key on input to submit in verification modal
            const verifyInput = document.getElementById('verifyCodeInput');
            if (verifyInput) {
                verifyInput.addEventListener('keydown', function(ev) {
                    if (ev.key === 'Enter') {
                        ev.preventDefault();
                        verifyCertificate();
                    }
                });
            }
        });

        // Verification modal handlers
        function openVerifyModal() {
            const modal = document.getElementById('verifyModal');
            const input = document.getElementById('verifyCodeInput');
            const result = document.getElementById('verifyResult');
            if (result) result.innerHTML = '';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => input && input.focus(), 0);
        }

        function closeVerifyModal() {
            const modal = document.getElementById('verifyModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Close verification when clicking on overlay
        document.getElementById('verifyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVerifyModal();
            }
        });

        async function verifyCertificate() {
            const inputEl = document.getElementById('verifyCodeInput');
            const resultEl = document.getElementById('verifyResult');
            const code = (inputEl?.value || '').trim();
            if (!code) {
                resultEl.innerHTML = '<div class="text-red-600">Please enter the certificate code.</div>';
                return;
            }

            // Show loading state
            resultEl.innerHTML = '<div class="text-gray-600">Verifying… Please wait.</div>';

            // Build the GET URL with query params
            const base = 'https://script.google.com/macros/s/AKfycbxSvBt7qG2fz4w_y9P2CoV7RfJq0kvThANuCWsVRjJz5NaiqqidhgmHQJZneydAt2Yk/exec';
            const params = new URLSearchParams({
                ID: '1ECREzocUMLr9HY9AoLSzNAJDRhtuBi3peuu8IDx2Daw',
                SH: 'Sheet1',
                func: 'verify',
                code: code
            });
            const url = `${base}?${params.toString()}`;

            try {
                const res = await fetch(url, { method: 'GET' });
                const text = await res.text();

                // Success case: JSON with { code, name, training }
                try {
                    const data = JSON.parse(text);
                    const vCode = data.code || code;
                    const vName = data.name || '';
                    const vTraining = data.training || '';
                    resultEl.innerHTML = `
                        <div class="p-3 rounded bg-green-50 border border-green-200 text-green-800">
                            <div class="font-semibold">Certificate is valid</div>
                            <div class="mt-1 text-sm">Code: <span class="font-medium">${vCode}</span></div>
                            <div class="mt-1 text-sm">Name: <span class="font-medium">${vName}</span></div>
                            <div class="mt-1 text-sm">Training: <span class="font-medium">${vTraining}</span></div>
                        </div>`;
                    return;
                } catch (_) {
                    // Not JSON: expect a plain-text error like "Error: Invalid code" or "Error: Contact PAPSI Admin"
                    const errMsg = text?.trim() || 'Verification failed.';
                    resultEl.innerHTML = `<div class="p-3 rounded bg-red-50 border border-red-200 text-red-700">${errMsg}</div>`;
                    return;
                }
            } catch (error) {
                console.error('Verification error:', error);
                resultEl.innerHTML = `<div class="p-3 rounded bg-red-50 border border-red-200 text-red-700">${error.message || 'Unable to verify at this time.'}</div>`;
            }
        }
    </script>
    <script>
    // === Mobile Filter Drawer Logic ===
    (function(){
        const body = document.body;
        let lastFocusedTrigger = null;
        const overlayId = 'filtersGlobalOverlay';

        function ensureOverlay(){
            let ov = document.getElementById(overlayId);
            if(!ov){
                ov = document.createElement('div');
                ov.id = overlayId;
                ov.className = 'filters-overlay';
                ov.addEventListener('click', () => closeFiltersDrawer());
                document.body.appendChild(ov);
            }
            return ov;
        }

        function isMobile(){ return window.matchMedia('(max-width: 767px)').matches; }

        function focusTrap(container){
            if(!container) return;
            const selectors = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
            const nodes = Array.from(container.querySelectorAll(selectors)).filter(el => el.offsetParent !== null);
            if(!nodes.length) return;
            function handle(e){
                if(e.key === 'Tab'){
                    const first = nodes[0];
                    const last = nodes[nodes.length-1];
                    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
                    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
                } else if(e.key === 'Escape') {
                    e.preventDefault(); closeFiltersDrawer();
                }
            }
            container.__trapHandler = handle;
            container.addEventListener('keydown', handle);
        }

        function releaseTrap(container){
            if(container && container.__trapHandler){
                container.removeEventListener('keydown', container.__trapHandler);
                delete container.__trapHandler;
            }
        }

        function openFiltersDrawer(kind){
            if(!isMobile()) return; // desktop uses inline layout
            const id = kind === 'learning' ? 'learningFiltersDrawer' : 'trainingFiltersDrawer';
            const drawer = document.getElementById(id);
            if(!drawer) return;
            lastFocusedTrigger = document.activeElement;
            const overlay = ensureOverlay();
            overlay.classList.add('visible');
            drawer.classList.add('open');
            body.classList.add('filters-lock');
            drawer.setAttribute('aria-hidden','false');
            const trigger = document.getElementById(kind === 'learning' ? 'learningFiltersMobileBtn' : 'trainingFiltersMobileBtn');
            if(trigger) trigger.setAttribute('aria-expanded','true');
            setTimeout(()=>{ // focus first input
                const firstInput = drawer.querySelector('input, select, button');
                if(firstInput) try{ firstInput.focus(); }catch{}
            }, 30);
            focusTrap(drawer);
        }
        window.openFiltersDrawer = openFiltersDrawer;

        function closeFiltersDrawer(forceKind){
            const overlay = document.getElementById(overlayId);
            if(overlay) overlay.classList.remove('visible');
            body.classList.remove('filters-lock');
            ['learningFiltersDrawer','trainingFiltersDrawer'].forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                if(forceKind){
                    if((forceKind==='learning' && id!=='learningFiltersDrawer') || (forceKind==='training' && id!=='trainingFiltersDrawer')) return;
                }
                el.classList.remove('open');
                el.setAttribute('aria-hidden','true');
                releaseTrap(el);
            });
            ['learningFiltersMobileBtn','trainingFiltersMobileBtn'].forEach(id => {
                const t = document.getElementById(id); if(t) t.setAttribute('aria-expanded','false');
            });
            if(lastFocusedTrigger && document.contains(lastFocusedTrigger)){
                try { lastFocusedTrigger.focus(); } catch {}
            }
        }
        window.closeFiltersDrawer = closeFiltersDrawer;

        function toggleDrawer(kind){
            const id = kind==='learning' ? 'learningFiltersDrawer' : 'trainingFiltersDrawer';
            const drawer = document.getElementById(id);
            if(!drawer) return;
            if(drawer.classList.contains('open')) closeFiltersDrawer(kind); else openFiltersDrawer(kind);
        }

        function countActiveFilters(kind){
            // Determine active (excluding defaults)
            if(kind==='learning'){
                let count = 0;
                const search = document.getElementById('learningSearchInput');
                if(search && search.value.trim()) count++;
                const cat = document.getElementById('learningCategoryFilter');
                if(cat && cat.value !== 'all') count++;
                const sp = document.getElementById('learningSpeakerFilter');
                if(sp && sp.value !== 'all') count++;
                const sort = document.getElementById('learningDateSort');
                if(sort && sort.value !== 'newest') count++; // treat non-default sort as active
                const badge = document.getElementById('learningFiltersActiveCount');
                if(badge){
                    if(count){ badge.textContent = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
                }
            } else {
                let count = 0;
                const search = document.getElementById('searchInput');
                if(search && search.value.trim()) count++;
                const cat = document.getElementById('categoryFilter');
                if(cat && cat.value !== 'all') count++;
                const sp = document.getElementById('speakerFilter');
                if(sp && sp.value !== 'all') count++;
                const sort = document.getElementById('dateSort');
                if(sort && sort.value !== 'newest') count++;
                const badge = document.getElementById('trainingFiltersActiveCount');
                if(badge){
                    if(count){ badge.textContent = count; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
                }
            }
        }
        window.__updateFilterActiveCounts = function(){ countActiveFilters('learning'); countActiveFilters('training'); };

        document.addEventListener('DOMContentLoaded', function(){
            // Add overlay element eagerly for smoother animation
            ensureOverlay();
            const lBtn = document.getElementById('learningFiltersMobileBtn');
            const tBtn = document.getElementById('trainingFiltersMobileBtn');
            const isDesk = () => !isMobile();
            if(lBtn) lBtn.addEventListener('click', () => { if(isDesk()){ const drawer = document.getElementById('learningFiltersDrawer'); drawer?.scrollIntoView({behavior:'smooth', block:'start'});} else { toggleDrawer('learning'); } });
            if(tBtn) tBtn.addEventListener('click', () => { if(isDesk()){ const drawer = document.getElementById('trainingFiltersDrawer'); drawer?.scrollIntoView({behavior:'smooth', block:'start'});} else { toggleDrawer('training'); } });
            // Close on resize to desktop
            window.addEventListener('resize', () => {
                if(!isMobile()) closeFiltersDrawer();
            });
            // Hook existing filter triggers to update counts
            ['learningSearchInput','learningCategoryFilter','learningSpeakerFilter','learningDateSort','searchInput','categoryFilter','speakerFilter','dateSort'].forEach(id => {
                const el = document.getElementById(id); if(el){ el.addEventListener('input', window.__updateFilterActiveCounts); el.addEventListener('change', window.__updateFilterActiveCounts); }
            });
            // Initial calc after a short delay (after data loads)
            setTimeout(window.__updateFilterActiveCounts, 1200);

            // Clear buttons
            const lc = document.getElementById('learningClearFilters');
            if(lc) lc.addEventListener('click', () => {
                const search = document.getElementById('learningSearchInput');
                const cs = document.getElementById('clearLearningSearch');
                const cat = document.getElementById('learningCategoryFilter');
                const sp = document.getElementById('learningSpeakerFilter');
                const sort = document.getElementById('learningDateSort');
                if(search){ search.value=''; if(cs) cs.classList.add('hidden'); }
                if(cat) cat.value='all';
                if(sp) sp.value='all';
                if(sort) sort.value='newest';
                window.learningYearFilter = null;
                filterLearningCourses();
                try{ window.__updateFilterActiveCounts(); }catch{}
            });
            const tc = document.getElementById('trainingClearFilters');
            if(tc) tc.addEventListener('click', () => {
                const search = document.getElementById('searchInput');
                const cs = document.getElementById('clearSearch');
                const cat = document.getElementById('categoryFilter');
                const sp = document.getElementById('speakerFilter');
                const sort = document.getElementById('dateSort');
                if(search){ search.value=''; if(cs) cs.classList.add('hidden'); }
                if(cat) cat.value='all';
                if(sp) sp.value='all';
                if(sort) sort.value='newest';
                window.trainingYearFilter = null;
                filterCourses();
                try{ window.__updateFilterActiveCounts(); }catch{}
            });
        });
    })();
    // === End Mobile Filter Drawer Logic ===
    </script>

    <script>
        // Populate Profile page dynamically from a provided JSON object
        // Expected keys: id, date, email, password, title, firstname, middleinitial, lastname, suffix,
        // birthdate, mobile, school, type, address, position, specialization, about, researchinterests, publications
        function setProfile(p) {
            if (!p || typeof p !== 'object') return;
            // Header
            const idEl = document.getElementById('profileId');
            const validityEl = document.getElementById('profileValidity');
            const nameEl = document.getElementById('profileName');
            const avatarEl = document.getElementById('avatarInitials');
            const headerInitEl = document.getElementById('headerInitials');
            const homeInitEl = document.getElementById('homeWelcomeInitials');
            const homeNameEl = document.getElementById('homeWelcomeName');
            if (idEl && p.id) idEl.textContent = `PAPSI ID: ${p.id}`;
            if (validityEl) {
                const validitySrc = p.date || p.validity || p.expiry || p.expiration || p.Date || p.Validity || p.Expiry || p.Expiration;
                validityEl.textContent = validitySrc ? formatValidity(validitySrc) : '';
            }
            if (nameEl) nameEl.textContent = buildFullName(p);
            if (avatarEl) avatarEl.textContent = buildInitials(p);
            if (headerInitEl) headerInitEl.textContent = buildInitials(p);
            if (homeInitEl) homeInitEl.textContent = buildInitials(p);
            if (homeNameEl) homeNameEl.textContent = buildFullName(p);

            // Account
            setValue('emailInput', p.email);
            setValue('passwordInput', p.password);

            // Personal
            setSelectWithOther('profileTitle', 'profileTitleOther', p.title);
            setValue('firstNameInput', p.firstname);
            setValue('middleInitialInput', p.middleinitial);
            setValue('lastNameInput', p.lastname);
            setValue('suffixInput', p.suffix);
            setValue('birthDateInput', normalizeDateInput(p.birthdate));
            setValue('mobileInput', p.mobile);
            try { applyMobileFormattingOnLoad(); } catch {}

            // Affiliation
            setValue('schoolInput', p.school);
            setSelect('typeSelect', p.type);
            setValue('addressTextarea', p.address);
            setSelectWithOther('positionSelect', 'positionOther', p.position);
            setSelectWithOther('specializationSelect', 'specializationOther', p.specialization);

            // Academic & Research
            setValue('aboutTextarea', p.about);
            setValue('researchTextarea', p.researchinterests);
            setValue('publicationsTextarea', p.publications);

            // My Learning: accept either Attended or attended (already normalized by normalizeServerProfile),
            // or fallback to a global attached object if provided elsewhere
            try {
                const attended = Array.isArray(p.Attended) ? p.Attended : (Array.isArray(p.attended) ? p.attended : (Array.isArray(window.PAPSI_ATTENDED) ? window.PAPSI_ATTENDED : null));
                if (attended) setMyLearning(attended);
            } catch {}
        }

        function setValue(id, val) {
            const el = document.getElementById(id);
            if (el != null && typeof val !== 'undefined' && val !== null) {
                el.value = String(val);
            }
        }
        function setSelect(id, val) {
            const el = document.getElementById(id);
            if (!el || typeof val === 'undefined' || val === null) return;
            const v = String(val).trim();
            for (const opt of el.options) {
                if (opt.text.replace('.', '').toLowerCase() === v.replace('.', '').toLowerCase()) {
                    el.value = opt.text;
                    return;
                }
            }
            // If not found, add as custom option
            const opt = document.createElement('option');
            opt.text = v;
            opt.value = v;
            el.add(opt);
            el.value = v;
        }
        // Helpers for select + Other pattern
        function setSelectWithOther(selectId, otherInputId, value) {
            const sel = document.getElementById(selectId);
            const other = document.getElementById(otherInputId);
            if (!sel || !other) return;
            const v = (value ?? '').toString().trim();

            // If blank: prefer placeholder option (value="") if present
            if (!v) {
                const placeholder = Array.from(sel.options).find(o => o.value === '');
                if (placeholder) sel.value = '';
                else sel.selectedIndex = 0;
                other.classList.add('hidden');
                other.value = '';
                sel.setAttribute('aria-expanded', 'false');
                return;
            }

            const matchOpt = Array.from(sel.options).find(o => o.text.toLowerCase() === v.toLowerCase());
            if (matchOpt && matchOpt.text.toLowerCase() !== 'other') {
                sel.value = matchOpt.value || matchOpt.text;
                other.classList.add('hidden');
                other.value = '';
                sel.setAttribute('aria-expanded', 'false');
            } else {
                sel.value = 'Other';
                other.classList.remove('hidden');
                other.value = v;
                sel.setAttribute('aria-expanded', 'true');
            }
        }
        function getSelectWithOtherValue(selectId, otherInputId) {
            const sel = document.getElementById(selectId);
            const other = document.getElementById(otherInputId);
            if (!sel) return '';
            const val = sel.value;
            if (val === 'Other') return other ? (other.value || '').trim() : '';
            return val;
        }
        // === Mobile Number Formatting (Philippines 11-digit 09XX-XXX-XXXX) ===
        function normalizeDigits(str){ return (str||'').replace(/[^0-9]/g,''); }
        function formatMobilePH(raw){
            let d = normalizeDigits(raw);
            // If 10 digits and starts with 9, assume missing leading 0.
            if(d.length === 10 && d.startsWith('9')) d = '0' + d;
            if(d.length !== 11) return raw; // only format when we have 11 after normalization
            return d.slice(0,4)+'-'+d.slice(4,7)+'-'+d.slice(7);
        }
        function applyMobileFormattingOnLoad(){
            const input = document.getElementById('mobileInput');
            if(!input) return;
            const formatted = formatMobilePH(input.value);
            input.value = formatted;
        }
        function attachMobileFormattingHandlers(){
            const input = document.getElementById('mobileInput');
            if(!input || input.__mobileFormatBound) return;
            input.__mobileFormatBound = true;
            input.addEventListener('focus', () => {
                // show raw digits while editing
                const digits = normalizeDigits(input.value);
                input.value = digits;
            });
            input.addEventListener('input', () => {
                // keep only digits, limit to 11 (PH mobile standard)
                let digits = normalizeDigits(input.value);
                if(digits.length > 11) digits = digits.slice(0,11);
                input.value = digits; // show digits during typing
            });
            input.addEventListener('blur', () => {
                const digits = normalizeDigits(input.value);
                const formatted = formatMobilePH(digits);
                // If formatter returned original raw (no change) but digits were altered (e.g., partial), keep digits; else use formatted
                if(formatted === digits || formatted === input.value){
                    input.value = formatted;
                } else {
                    input.value = formatted;
                }
            });
        }
        document.addEventListener('DOMContentLoaded', attachMobileFormattingHandlers);
        // Intercept profile form submission to strip hyphens before sending
        (function(){
            document.addEventListener('DOMContentLoaded', function(){
                const form = document.querySelector('#profile-page form');
                if(!form) return;
                form.addEventListener('submit', function(){
                    const mobileEl = document.getElementById('mobileInput');
                    if(mobileEl){ mobileEl.value = normalizeDigits(mobileEl.value); }
                }, true); // capture so it runs before earlier submit handler reading value
            });
        })();
        // === End Mobile Number Formatting ===
        function buildFullName(p) {
            const parts = [];
            if (p.firstname) parts.push(p.firstname);
            if (p.middleinitial) parts.push(String(p.middleinitial).charAt(0).toUpperCase() + '.');
            if (p.lastname) parts.push(p.lastname);
            if (p.suffix) parts.push(String(p.suffix).trim());
            return parts.join(' ') || 'Member';
        }
        function buildInitials(p) {
            const a = (p.firstname || '').trim();
            const b = (p.lastname || '').trim();
            const inits = `${a.charAt(0)}${b.charAt(0)}`.toUpperCase();
            return inits || 'MM';
        }
        function formatValidity(dateStr) {
            // Parses a wide range of formats and outputs like "until Dec 12, 2025"
            try {
                const d = parseFlexDate(dateStr);
                if (!d || isNaN(d.getTime())) return String(dateStr);
                const fmt = d.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' });
                return `until ${fmt}`;
            } catch { return String(dateStr); }
        }
        function normalizeDateInput(dateStr) {
            if (!dateStr) return '';
            const d = parseFlexDate(dateStr) || new Date(dateStr);
            if (isNaN(d.getTime())) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const da = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${da}`;
        }

        // If a global object is present, auto-populate
                if (window.PAPSI_PROFILE) {
                        try { setProfile(window.PAPSI_PROFILE); } catch (_) { /* no-op */ }
                }
        </script>

        <!-- Registration Success Modal -->
        <div id="registrationSuccessOverlay" class="fixed inset-0 bg-black/50 z-[3500] hidden" role="dialog" aria-modal="true" aria-labelledby="regSuccessTitle">
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                    <div class="flex items-center justify-between px-4 py-3 border-b">
                        <h3 id="regSuccessTitle" class="text-lg font-semibold text-papsi-dark">Registration Successful</h3>
                        <button id="regSuccessCloseX" class="text-gray-500 hover:text-gray-700" aria-label="Close">&times;</button>
                    </div>
                    <div class="px-4 py-4">
                        <p id="regSuccessSubtitle" class="text-gray-700">
                            Please see our email containing the payment procedures. Sent to your email address: <span class="font-semibold"></span>
                        </p>
                    </div>
                    <div class="px-4 pb-4 flex gap-2 justify-end">
                        <button id="regSuccessOk" class="bg-papsi-green text-white px-4 py-2 rounded hover:bg-green-700">Ok</button>
                        <button id="regSuccessClose" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
        // Support functions for Registration Success modal
        function openRegistrationSuccessModal(email){
            try {
                const overlay = document.getElementById('registrationSuccessOverlay');
                const subtitle = document.getElementById('regSuccessSubtitle');
                const emailSpan = subtitle?.querySelector('span');
                if (emailSpan) emailSpan.textContent = String(email || '').trim();
                overlay?.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                // Focus OK for easy dismiss
                setTimeout(() => { try { document.getElementById('regSuccessOk')?.focus(); } catch {} }, 0);
            } catch {}
        }
        function closeRegistrationSuccessModal(){
            try {
                const overlay = document.getElementById('registrationSuccessOverlay');
                overlay?.classList.add('hidden');
                document.body.style.overflow = '';
            } catch {}
        }
        document.addEventListener('DOMContentLoaded', function(){
            const closeX = document.getElementById('regSuccessCloseX');
            const closeBtn = document.getElementById('regSuccessClose');
            const okBtn = document.getElementById('regSuccessOk');
            closeX?.addEventListener('click', closeRegistrationSuccessModal);
            closeBtn?.addEventListener('click', closeRegistrationSuccessModal);
            okBtn?.addEventListener('click', closeRegistrationSuccessModal);
            document.getElementById('registrationSuccessOverlay')?.addEventListener('click', function(e){ if (e.target === this) closeRegistrationSuccessModal(); });
            document.addEventListener('keydown', function(e){
                const ov = document.getElementById('registrationSuccessOverlay');
                if (ov && !ov.classList.contains('hidden') && e.key === 'Escape') closeRegistrationSuccessModal();
            });
        });
        </script>

    <!-- Contact Support Modal -->
    <div id="supportModal" class="modal hidden z-50">
        <div class="modal-content max-w-xl mx-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-papsi-dark">Contact Support</h3>
                <button onclick="closeSupportModal()" class="text-gray-400 hover:text-gray-600" aria-label="Close support modal">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-6">
                <!-- Email Section -->
                <div>
                    <h4 class="text-lg font-semibold text-papsi-dark">Email Us</h4>
                    <p class="text-gray-600 text-sm">We usually respond within a business day.</p>
                    <div class="mt-3 flex flex-wrap gap-2 items-center">
                        <span class="text-sm text-papsi-dark font-medium">papsi.seminar@gmail.com</span>
                        <a class="bg-papsi-green text-white px-3 py-2 rounded hover:bg-green-700 transition-colors"
                           href="mailto:papsi.seminar@gmail.com?subject=PAPSI%20Support&body=Hello%20PAPSI%20Support%2C%0A%0APlease%20help%20me%20with%20...%0A%0AThank%20you%2C%0A%3CYour%20Name%3E">
                           Email Us
                        </a>
                        <button onclick="copyToClipboard('papsi.seminar@gmail.com')" class="bg-gray-200 text-papsi-dark px-3 py-2 rounded hover:bg-gray-300 transition-colors">Copy Email</button>
                    </div>
                </div>

                <!-- Call or SMS Section -->
                <div>
                    <h4 class="text-lg font-semibold text-papsi-dark">Call or SMS</h4>
                    <p class="text-gray-600 text-sm">We’re reachable during business hours (PH Time).</p>
                    <div class="mt-3 flex flex-wrap gap-2 items-center">
                        <span class="text-sm text-papsi-dark font-medium">+63 966 165 2084</span>
                        <a class="bg-papsi-green text-white px-3 py-2 rounded hover:bg-green-700 transition-colors" href="tel:+639661652084">Call</a>
                        <a class="bg-papsi-dark text-white px-3 py-2 rounded hover:bg-gray-800 transition-colors" href="sms:+639661652084?body=Hello%20PAPSI%20Support%2C">SMS</a>
                        <button onclick="copyToClipboard('+639661652084')" class="bg-gray-200 text-papsi-dark px-3 py-2 rounded hover:bg-gray-300 transition-colors">Copy Number</button>
                    </div>
                </div>

                <div id="supportCopyStatus" class="text-sm"></div>
                <div class="flex gap-2 justify-end">
                    <button onclick="closeSupportModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openSupportModal() {
            const modal = document.getElementById('supportModal');
            const status = document.getElementById('supportCopyStatus');
            if (status) status.textContent = '';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        function closeSupportModal() {
            const modal = document.getElementById('supportModal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        // Close Support when clicking on overlay
        document.getElementById('supportModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeSupportModal();
            }
        });
        // Clipboard helper
        async function copyToClipboard(text) {
            const status = document.getElementById('supportCopyStatus');
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }
                if (status) status.innerHTML = '<span class="text-green-700">Copied to clipboard.</span>';
            } catch (err) {
                if (status) status.innerHTML = '<span class="text-red-600">Failed to copy.</span>';
            }
        }
        // Add ESC handling for support modal alongside others
        document.addEventListener('keydown', function(e) {
            const supportModal = document.getElementById('supportModal');
            if (supportModal && !supportModal.classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    closeSupportModal();
                }
            }
        });
        </script>
        <script>
        // ===== Video Player (in-page) =====
        function normalizeVideoUrl(input) {
            const url = String(input || '').trim();
            if (!url) return null;
            if (/\.(mp4|webm|ogg)(\?|#|$)/i.test(url)) return { mode: 'video', src: url, raw: url };
            if (/drive\.google\.com\/file\/d\//i.test(url)) {
                const id = (url.match(/\/file\/d\/([^/]+)/i) || [])[1];
                if (id) return { mode: 'iframe', src: `https://drive.google.com/file/d/${id}/preview`, raw: url };
            }
            if (/drive\.google\.com\/open\?id=/i.test(url)) {
                try { const id = new URL(url).searchParams.get('id'); if (id) return { mode: 'iframe', src: `https://drive.google.com/file/d/${id}/preview`, raw: url }; } catch {}
            }
            if (/youtube\.com\/watch\?v=/i.test(url)) {
                try { const id = new URL(url).searchParams.get('v'); if (id) return { mode: 'iframe', src: `https://www.youtube.com/embed/${id}`, raw: url }; } catch {}
            }
            if (/youtu\.be\//i.test(url)) {
                const id = (url.match(/youtu\.be\/([^?&#]+)/i) || [])[1];
                if (id) return { mode: 'iframe', src: `https://www.youtube.com/embed/${id}`, raw: url };
            }
            if (/vimeo\.com\/\d+/i.test(url)) {
                const id = (url.match(/vimeo\.com\/(\d+)/i) || [])[1];
                if (id) return { mode: 'iframe', src: `https://player.vimeo.com/video/${id}`, raw: url };
            }
            if (/onedrive\.live\.com\/embed/i.test(url)) return { mode: 'iframe', src: url, raw: url };
            if (/1drv\.ms\//i.test(url)) return { mode: 'iframe', src: url, raw: url };
            return { mode: 'iframe', src: url, raw: url };
        }

        const VP_SIZE_KEY = 'PAPSI_VP_SIZE';

        function setVideoSize(size) {
            const content = document.getElementById('videoModalContent');
            if (!content) return;
            content.classList.remove('video-size-normal','video-size-large','video-size-full');
            if (size === 'large') content.classList.add('video-size-large');
            else if (size === 'full') content.classList.add('video-size-full');
            else content.classList.add('video-size-normal');
            try { localStorage.setItem(VP_SIZE_KEY, size); } catch {}
        }

        function openVideoPlayer(url, title) {
            const norm = normalizeVideoUrl(url);
            const modal = document.getElementById('videoPlayerModal');
            const content = document.getElementById('videoModalContent');
            const titleEl = document.getElementById('videoPlayerTitle');
            const embed = document.getElementById('videoEmbedContainer');
            const loading = document.getElementById('videoLoading');
            const fallback = document.getElementById('videoFallback');
            const openExternal = document.getElementById('videoOpenExternal');
            if (!modal || !content || !titleEl || !embed || !loading || !fallback) return;

            titleEl.textContent = title || 'Video';
            embed.innerHTML = '';
            loading.classList.remove('hidden');
            fallback.classList.add('hidden');
            if (openExternal) openExternal.href = (norm && norm.raw) || url;

            setVideoSize(localStorage.getItem(VP_SIZE_KEY) || 'normal');

            if (norm && norm.mode === 'video') {
                const vid = document.createElement('video');
                vid.src = norm.src;
                vid.controls = true;
                vid.autoplay = true;
                vid.playsInline = true;
                vid.style.width = '100%';
                vid.style.height = '100%';
                vid.addEventListener('canplay', () => loading.classList.add('hidden'), { once: true });
                embed.appendChild(vid);
            } else {
                const ifr = document.createElement('iframe');
                ifr.src = norm ? norm.src : url;
                ifr.title = title || 'Video';
                ifr.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                ifr.allowFullscreen = true;
                ifr.frameBorder = '0';
                ifr.style.width = '100%';
                ifr.style.height = '100%';
                ifr.addEventListener('load', () => loading.classList.add('hidden'), { once: true });
                embed.appendChild(ifr);
                setTimeout(() => {
                    if (!loading.classList.contains('hidden')) {
                        loading.classList.add('hidden');
                        fallback.classList.remove('hidden');
                    }
                }, 5000);
            }

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeVideoPlayer() {
            const modal = document.getElementById('videoPlayerModal');
            const embed = document.getElementById('videoEmbedContainer');
            if (embed) embed.innerHTML = '';
            if (modal) modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            if (typeof showPage === 'function') showPage('learning');
        }

        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('vpSizeNormal')?.addEventListener('click', ()=>setVideoSize('normal'));
            document.getElementById('vpSizeLarge')?.addEventListener('click', ()=>setVideoSize('large'));
            document.getElementById('vpSizeFull')?.addEventListener('click', ()=>setVideoSize('full'));
            document.addEventListener('keydown', function(e){
                const modal = document.getElementById('videoPlayerModal');
                if (modal && !modal.classList.contains('hidden') && e.key === 'Escape') {
                    e.preventDefault();
                    closeVideoPlayer();
                }
            });
            document.getElementById('videoPlayerModal')?.addEventListener('click', function(e){ if (e.target === this) closeVideoPlayer(); });
        });
        // ===== End Video Player =====

        // ===== Slides (PDF) Viewer =====
        function normalizePdfUrl(input) {
            const url = String(input || '').trim();
            if (!url) return null;
            // Google Drive file link → preview
            if (/drive\.google\.com\/file\/d\//i.test(url)) {
                const id = (url.match(/\/file\/d\/([^/]+)/i) || [])[1];
                if (id) return { mode: 'drive', src: `https://drive.google.com/file/d/${id}/preview`, raw: url };
            }
            if (/drive\.google\.com\/open\?id=/i.test(url)) {
                try {
                    const id = new URL(url).searchParams.get('id');
                    if (id) return { mode: 'drive', src: `https://drive.google.com/file/d/${id}/preview`, raw: url };
                } catch {}
            }
            // Direct PDF → use PDF.js online viewer
            if (/\.pdf(\?|#|$)/i.test(url)) {
                const viewer = 'https://mozilla.github.io/pdf.js/web/viewer.html?file=';
                return { mode: 'pdfjs', src: viewer + encodeURIComponent(url), raw: url };
            }
            // Fallback
            return { mode: 'iframe', src: url, raw: url };
        }

        const SP_SIZE_KEY = 'PAPSI_SP_SIZE';
        function setSlidesSize(size) {
            const content = document.getElementById('slidesModalContent');
            if (!content) return;
            content.classList.remove('slides-size-normal','slides-size-large','slides-size-full');
            if (size === 'large') content.classList.add('slides-size-large');
            else if (size === 'full') content.classList.add('slides-size-full');
            else content.classList.add('slides-size-normal');
            try { localStorage.setItem(SP_SIZE_KEY, size); } catch {}
        }

        function openSlidesViewer(url, title) {
            const norm = normalizePdfUrl(url);
            const modal = document.getElementById('slidesModal');
            const frame = document.getElementById('slidesFrame');
            const loading = document.getElementById('slidesLoading');
            const fallback = document.getElementById('slidesFallback');
            const openExternal = document.getElementById('slidesOpenExternal');
            const titleEl = document.getElementById('slidesTitle');
            if (!modal || !frame || !loading || !fallback) return;

            titleEl.textContent = title || 'Slides';
            loading.classList.remove('hidden');
            fallback.classList.add('hidden');
            if (openExternal) openExternal.href = (norm && norm.raw) || url;

            setSlidesSize(localStorage.getItem(SP_SIZE_KEY) || 'normal');
            frame.src = norm ? norm.src : url;
            const onLoad = () => { loading.classList.add('hidden'); frame.removeEventListener('load', onLoad); };
            frame.addEventListener('load', onLoad);
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    loading.classList.add('hidden');
                    fallback.classList.remove('hidden');
                }
            }, 5000);

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeSlidesViewer() {
            const modal = document.getElementById('slidesModal');
            const frame = document.getElementById('slidesFrame');
            if (frame) frame.src = 'about:blank';
            if (modal) modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            if (typeof showPage === 'function') showPage('learning');
        }

        document.addEventListener('DOMContentLoaded', function(){
            // Size buttons removed (Normal/Large/Full) – default size applied; listeners no longer needed.
            document.addEventListener('keydown', function(e){
                const modal = document.getElementById('slidesModal');
                if (modal && !modal.classList.contains('hidden') && e.key === 'Escape') {
                    e.preventDefault();
                    closeSlidesViewer();
                }
            });
            document.getElementById('slidesModal')?.addEventListener('click', function(e){ if (e.target === this) closeSlidesViewer(); });
        });
        // ===== End Slides (PDF) Viewer =====
        </script>
        <script>
        // ===== Modules (Drive Folder) Viewer =====
        const MODULES_VIEW_KEY = 'PAPSI_MODULES_VIEW'; // list | grid
        function normalizeModuleUrl(input) {
            const raw = String(input || '').trim();
            if (!raw) return null;
            const m1 = raw.match(/drive\.google\.com\/drive\/folders\/([^/?#]+)/i);
            const m2 = raw.match(/drive\.google\.com\/drive\/u\/\d+\/folders\/([^/?#]+)/i);
            let folderId = (m1 && m1[1]) || (m2 && m2[1]) || '';
            if (!folderId) {
                try { const u = new URL(raw); const id = u.searchParams.get('id'); if (id) folderId = id; } catch {}
            }
            if (folderId) {
                return { mode: 'drive-folder', folderId, raw };
            }
            return { mode: 'other', raw };
        }

        function buildEmbeddedFolderSrc(folderId, viewMode) {
            const mode = (viewMode === 'grid') ? 'grid' : 'list';
            return `https://drive.google.com/embeddedfolderview?id=${folderId}#${mode}`;
        }

        function applyModulesViewToggle(active) {
            const listBtn = document.getElementById('modulesViewList');
            const gridBtn = document.getElementById('modulesViewGrid');
            if (!listBtn || !gridBtn) return;
            listBtn.classList.remove('modules-toggle-active');
            gridBtn.classList.remove('modules-toggle-active');
            if (active === 'grid') gridBtn.classList.add('modules-toggle-active'); else listBtn.classList.add('modules-toggle-active');
        }

        let currentModulesFolder = null; // remember folderId for view switching

        function openModulesViewer(url, title) {
            const norm = normalizeModuleUrl(url);
            if (!norm) return;
            if (norm.mode !== 'drive-folder') {
                // fallback open in new tab
                try { window.open(norm.raw, '_blank', 'noopener'); } catch (_) { location.href = norm.raw; }
                return;
            }
            currentModulesFolder = norm.folderId;
            const modal = document.getElementById('modulesModal');
            const frame = document.getElementById('modulesFrame');
            const loading = document.getElementById('modulesLoading');
            const fallback = document.getElementById('modulesFallback');
            const openExternal = document.getElementById('modulesOpenExternal');
            const titleEl = document.getElementById('modulesTitle');
            if (!modal || !frame || !loading || !fallback) {
                console.warn('Modules modal markup missing; opening in new tab instead.');
                try { window.open(norm.raw, '_blank', 'noopener'); } catch (_) { location.href = norm.raw; }
                return;
            }

            const savedView = (localStorage.getItem(MODULES_VIEW_KEY) === 'grid') ? 'grid' : 'list';
            applyModulesViewToggle(savedView);

            titleEl.textContent = title || 'Modules';
            loading.classList.remove('hidden');
            fallback.classList.add('hidden');
            if (openExternal) openExternal.href = norm.raw;

            frame.src = buildEmbeddedFolderSrc(norm.folderId, savedView);
            const onLoad = () => { loading.classList.add('hidden'); frame.removeEventListener('load', onLoad); };
            frame.addEventListener('load', onLoad);
            setTimeout(() => {
                if (!loading.classList.contains('hidden')) {
                    loading.classList.add('hidden');
                    fallback.classList.remove('hidden');
                }
            }, 6000);

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeModulesViewer() {
            const modal = document.getElementById('modulesModal');
            const frame = document.getElementById('modulesFrame');
            if (frame) frame.src = 'about:blank';
            if (modal) modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            if (typeof showPage === 'function') showPage('learning');
            currentModulesFolder = null;
        }

        function switchModulesView(mode) {
            if (!currentModulesFolder) return;
            try { localStorage.setItem(MODULES_VIEW_KEY, mode === 'grid' ? 'grid' : 'list'); } catch {}
            applyModulesViewToggle(mode);
            const frame = document.getElementById('modulesFrame');
            if (frame) frame.src = buildEmbeddedFolderSrc(currentModulesFolder, mode);
        }

        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('modulesModal')?.addEventListener('click', function(e){ if (e.target === this) closeModulesViewer(); });
            document.getElementById('modulesViewList')?.addEventListener('click', () => switchModulesView('list'));
            document.getElementById('modulesViewGrid')?.addEventListener('click', () => switchModulesView('grid'));
            document.addEventListener('keydown', function(e){
                const modal = document.getElementById('modulesModal');
                if (modal && !modal.classList.contains('hidden') && e.key === 'Escape') {
                    e.preventDefault();
                    closeModulesViewer();
                }
            });
        });
        // ===== End Modules (Drive Folder) Viewer =====
        </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98288178e4bb6e8c',t:'MTc1ODQ0NjYyNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
<!-- About & Privacy Information Modals (Option B) -->
<div id="aboutInfoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="aboutInfoTitle">
    <div class="modal-content max-w-3xl mx-auto p-0" role="document">
        <div class="px-6 py-4 border-b flex items-start justify-between">
            <h3 id="aboutInfoTitle" class="text-xl font-bold text-papsi-dark">About PAPSI</h3>
            <button type="button" class="text-gray-400 hover:text-gray-600" aria-label="Close about dialog" onclick="closeInfoModal('aboutInfoModal')">&times;</button>
        </div>
            <div class="p-6 space-y-4 text-sm leading-relaxed max-h-[70vh] overflow-y-auto" id="aboutInfoBody">
                <p><strong>PAPSI</strong> (Philippine Association of Physics and Science Instructors) is a national organization dedicated to advancing the teaching and learning of science, particularly in the fields of natural and physical sciences. Guided by experts from De La Salle University and other leading institutions, PAPSI brings together educators who are passionate about raising the quality of science education across the Philippines. Through conferences, seminars, trainings, and research initiatives, PAPSI fosters collaboration, professional growth, and the sharing of best practices among science instructors.</p>
                <p>Our mission is to promote excellence in science teaching by equipping educators with the latest knowledge, skills, and pedagogical approaches. Beyond physics and general science, PAPSI also emphasizes the importance of statistics, research, laboratory skills, Disaster Risk Reduction and Resiliency (DRRR), and ICT integration in education. We envision a community of competent, confident, and inspired educators who not only deepen their expertise but also cultivate in students a lasting appreciation for science. By uniting teachers nationwide, PAPSI aims to be a leading force in shaping innovative, effective, and future-ready education.</p>
                <p>Through this member portal you can: access training opportunities, track your professional learning, view announcements, manage your profile, and connect with the broader PAPSI community.</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>Professional development and training center</li>
                    <li>Archiving of attended seminars and modules</li>
                    <li>Secure certificate verification utility</li>
                    <li>Community engagement & upcoming initiatives</li>
                </ul>
                <p class="text-gray-600">For inquiries or collaboration proposals, please use the Contact Support feature found under Extras.</p>
            </div>
        <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
            <button type="button" class="px-4 py-2 rounded bg-papsi-green text-white text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-papsi-green" onclick="closeInfoModal('aboutInfoModal')">Close</button>
        </div>
    </div>
</div>
<div id="privacyInfoModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="privacyInfoTitle">
    <div class="modal-content max-w-3xl mx-auto p-0" role="document">
        <div class="px-6 py-4 border-b flex items-start justify-between">
            <h3 id="privacyInfoTitle" class="text-xl font-bold text-papsi-dark">Privacy Policy</h3>
            <button type="button" class="text-gray-400 hover:text-gray-600" aria-label="Close privacy dialog" onclick="closeInfoModal('privacyInfoModal')">&times;</button>
        </div>
        <div class="p-6 space-y-4 text-sm leading-relaxed max-h-[70vh] overflow-y-auto" id="privacyInfoBody">
            <p>Your privacy matters. PAPSI collects only the minimum information necessary to operate member services (e.g., name, contact details, professional profile, attended trainings).</p>
            <p><strong>Data Usage:</strong> Information is used to display your learning history, personalize content, and facilitate training registration.</p>
            <p><strong>Storage & Retention:</strong> Limited profile data may be stored in secure systems and locally in your browser (e.g., preferences) for faster experience. You may clear local storage at any time.</p>
            <p><strong>Sharing:</strong> PAPSI does not sell your data. Aggregated or anonymized insights may be used for program improvement.</p>
            <p><strong>Your Rights:</strong> You may request correction or removal of your profile data subject to organizational verification.</p>
            <p class="text-gray-600">For privacy-related concerns contact: <span class="font-medium">papsi.seminar@gmail.com</span></p>
        </div>
        <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
            <button type="button" class="px-4 py-2 rounded bg-papsi-green text-white text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-papsi-green" onclick="closeInfoModal('privacyInfoModal')">Close</button>
        </div>
    </div>
</div>
<script>
// === About & Privacy Info Modals (Option B Support) ===
(function(){
    if(window.__PAPSI_INFO_MODALS_BOUND) return; // idempotency guard
    window.__PAPSI_INFO_MODALS_BOUND = true;

    const focusStack = [];

    function trapFocus(modal){
        const selectors = 'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])';
        const focusables = Array.from(modal.querySelectorAll(selectors)).filter(el=>el.offsetParent!==null);
        if(!focusables.length) return;
        let first = focusables[0];
        let last = focusables[focusables.length-1];
        modal.addEventListener('keydown', function(e){
            if(e.key === 'Tab'){
                if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
                else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
            }
        });
    }

    window.openInfoModal = function(id){
        const modal = document.getElementById(id);
        if(!modal) return;
        const previouslyFocused = document.activeElement;
        focusStack.push(previouslyFocused);
        modal.classList.remove('hidden');
        document.body.style.overflow='hidden';
        // Focus first focusable
        setTimeout(()=>{
            const btn = modal.querySelector('button, [href], [tabindex]:not([tabindex="-1"])');
            if(btn) try{btn.focus();}catch{}
            trapFocus(modal);
        },0);
    };

    window.closeInfoModal = function(id){
        const modal = document.getElementById(id);
        if(!modal) return;
        modal.classList.add('hidden');
        document.body.style.overflow='auto';
        const toFocus = focusStack.pop();
        if(toFocus && typeof toFocus.focus === 'function') setTimeout(()=>{ try{toFocus.focus();}catch{} },0);
    };

    // Overlay click to close
    ['aboutInfoModal','privacyInfoModal'].forEach(mid => {
        const m = document.getElementById(mid);
        if(!m) return;
        m.addEventListener('click', function(e){ if(e.target === m) closeInfoModal(mid); });
    });

    // Global ESC handler
    document.addEventListener('keydown', function(e){
        if(e.key !== 'Escape') return;
        const openModals = ['aboutInfoModal','privacyInfoModal'].map(id=>document.getElementById(id)).filter(m=>m && !m.classList.contains('hidden'));
        if(!openModals.length) return;
        e.preventDefault();
        // Close the top-most (last opened)
        closeInfoModal(openModals[openModals.length-1].id);
    });
})();
// === End About & Privacy Info Modals ===
</script>
</body>
</html>
